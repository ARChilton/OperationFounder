var eventDescription,appdb,basedb,remotedb,admindb,syncBasedb,adminSync,evtUpdateCheck,adminCurrentlySelected,userCurrentlySelected,nextMessageEndKey,nextMessageEndKey2,adminDatabaseName,baseDatabaseName,lastSync,base,name,tableId,tableLogId,sqPatrol,sqTimeIn,sqTimeOut,sqWait,sqOffRoute,sqTotalScore,baseCodes=[],baseNames=[],appdbConnected=!1,basedbConnected=!1,remotedbConnected=!1,admindbConnected=!1,adminSyncInProgress=!1,baseSyncInProgress=!1,evtUpdateCheckConnected=!1,deleteNotificationCleared=!0,attemptCount=0,newestMessage="message",dbSeqNumber=parseInt(localStorage.dbSeqNumber),nextSeq=0,username=localStorage.username,password=localStorage.password,lastDb=localStorage.lastDb,couchdb=localStorage.couchdb,http=localStorage.http,db=localStorage.db,appDatabaseName="oppFounderLoginDb",remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb,appServer="https://checkpointlive.com/app",patrolRecord=[],patrolRecordAdmin=[],offRouteIndex=[],offRouteIndexAdmin=[],pageChangeAnimation="none";function onDeviceReady(){"android"==cordova.platformId&&StatusBar.backgroundColorByHexString("#283593")}function onPause(){}function onResume(){}function checkForMessagesSinceSeqNo(e,t){var a={since:t},n=/message/i;return e.changes(a).then(function(e){return nextSeq=e.last_seq,e.results.filter(function(e){return n.test(e.id)&&!e.deleted})})}function updateMsgBadgeNo(e,t){return t?$("#messageBadge").html(0).addClass("hide"):$("#messageBadge").html(e).removeClass("hide")}function checkForNewMessagesOnPageLoad(e,t){Promise.resolve().then(function(){return checkForMessagesSinceSeqNo(e,t)}).then(function(e){return!(e.length<1)&&updateMsgBadgeNo(e.length)}).catch(function(e){})}function addMessages(e,t,a,n,o,s,i,r){null!=n.limit&&!1!==n.limit&&n.limit++;var d=t.height();return e.allDocs(n).then(function(e){return formBubbleMessages(e.rows,n.limit,o)}).then(function(e){return o?t.prepend(e.reverse()).height():t.append(e.reverse()).height()}).then(function(e){return s&&(r=i?a[0].scrollHeight:e-d+r,scrollToElement(a,r,1)),e}).catch(function(e){return!1})}function formBubbleMessages(e,t,a){var n=!1,o=0,s=e.length,i=getBaseNumber(),r=new Date,d=new Date;return d.setDate(d.getDate()-1),Promise.all(e.map(function(e){var c=e.doc;if("string"==typeof c.message){var l=" message-text",u="bubble",m="msg",p="bubble";if(c.date=new Date(c._id.replace("message-","")),c.time=addZero(c.date.getHours())+":"+addZero(c.date.getMinutes()),c.from=parseInt(c.from),c.to=parseInt(c.to),c.msgBaseNo="Base "+c.from,0===c.from&&(c.msgBaseNo="Admin HQ"),!n&&s>1)return a||(newestMessage=c._id),n=Object.assign({},c),void o++;if(1!==s||(n=Object.assign({},c),c.from="n/a",c._id!==nextMessageEndKey)){n.from===i?u+=" message-out":u+=" message-in",n.from!==c.from?u+=" tail":m+=" msgContinued",void 0===n.from&&(n.from="unknown");var h='<div id="'+n._id+'" class="'+m+'"><div class="'+u+'"><div class="msgFrom color-'+n.from+'">'+n.username+" @ "+n.msgBaseNo+'</div><div class="'+l+'">'+n.message+'</div><div class="bubble-text-meta msgTimeStamp ">'+n.time+"</div></div></div>";if(n.date.toDateString()!==c.date.toDateString()&&(h=dateBubble(n.date,r,d)+h),n=Object.assign({},c),++o!==t){if(o===t-1||s<t&&o===s&&s>1){c.from===i?(p+=" message-out",m+=" topMsg"):(p+=" message-in",m+=" topMsg"),s<t&&(p+=" tail"),nextMessageEndKey=c._id;var g='<div id="'+c._id+'" class="'+m+'"><div class="'+p+'"><div class="msgFrom color-'+c.from+'">'+c.username+" @ "+c.msgBaseNo+'</div><div class="'+l+'">'+c.message+'</div><div class="bubble-text-meta msgTimeStamp ">'+c.time+"</div></div></div>";return document.getElementById("topDateMsgBubble").innerHTML=dateString(c.date,r,d),g+h}}else if(o===t)return void(nextMessageEndKey=c._id);return h}}}))}function dateString(e,t,a){var n=e.toDateString();return n===t.toDateString()?"Today":n===a.toDateString()?"Yesterday":n}function dateBubble(e,t,a){return'<div class="msg dateMsgDivider"><div class="bubble dateBubble">'+dateString(e,t,a)+"</div></div>"}function orientationLandscapeUpdate(){ons.orientation.isLandscape()?($(".landscapeHide").addClass("hide"),$(".landscapeShow").removeClass("hide"),$(".speed__dial.fab--bottom__right").attr("direction","left")):$(".speed__dial.fab--bottom__right").attr("direction","up")}function orientationUpdates(){ons.orientation.isLandscape()?($(".landscapeHide").addClass("hide"),$(".landscapeShow").removeClass("hide"),$(".speed__dial.fab--bottom__right").attr("direction","left")):($(".landscapeShow").addClass("hide"),$(".landscapeHide").removeClass("hide"),$(".speed__dial.fab--bottom__right").attr("direction","up"))}function destroyPouchDBs(){new PouchDB(baseDatabaseName).destroy().then(function(){ons.notification.alert(baseDatabaseName+"/basedb database destroyed")}),new PouchDB(appDatabaseName).destroy().then(function(){ons.notification.alert(appDatabaseName+"/opFounderAppDb database destroyed")}),new PouchDB(adminDatabaseName).destroy().then(function(){ons.notification.alert(adminDatabaseName+"/admindb database destroyed")})}function cleanAll(){ons.notification.prompt({title:"Clean all databases",messageHTML:"<p>You are about to delete all items from the central database, this will propagate out to all other devices, are you sure you want to do this?</p><p>If yes please enter the admin passcode used to access the admin portion of the app</p>",cancelable:!0,placeholder:"Enter admin code here"}).then(function(e){e.toLowerCase()===baseCodes[0]&&admindb.allDocs().then(function(e){for(var t=0,a=e.total_rows;t<a;t++){var n=e.rows[t];if("_design".test(n.id)){var o={_id:n.id,_rev:n.value.rev,_deleted:!0};admindb.put(o,options).catch(function(e){})}}}).then(function(){admindb.compact().then(function(e){}).catch(function(e){})})})}function patrolRecordUpdate(e,t,a){return a?t?offRouteIndexAdmin.indexOf(e)>-1||(offRouteIndexAdmin.push(e),!1):patrolRecordAdmin.indexOf(e)>-1||(patrolRecordAdmin.push(e),!1):t?offRouteIndex.indexOf(e)>-1||(offRouteIndex.push(e),!1):patrolRecord.indexOf(e)>-1||(patrolRecord.push(e),!1)}function removePatrolRecord(e,t){switch(t){case!0:var a=patrolRecordAdmin.indexOf(e),n=offRouteIndexAdmin.indexOf(e);return a>-1?(patrolRecordAdmin.splice(a,1),!0):n>-1&&(offRouteIndexAdmin.splice(n,1),!0);case!1:a=patrolRecord.indexOf(e),n=offRouteIndex.indexOf(e);return a>-1?(patrolRecord.splice(a,1),!0):n>-1&&(offRouteIndex.splice(n,1),!0)}}function editableStyling(e,t){if(void 0===t)return e?{tr:"",td:""}:{tr:" lockedLog",td:" padlockLocked"};e?($("#"+t).removeClass("lockedLog"),$("#"+t+" > .lockImage").removeClass("padlockLocked")):($("#"+t).addClass("lockedLog"),$("#"+t+" > .lockImage").addClass("padlockLocked"))}function removeExisiting(e,t){$("#"+e).remove()}function updateExisting(e,t,a,n,o,s,i,r,d,c){var l=e;$("#"+l).html("<td class='bold lockImage'>"+t+"</td><td>"+a+"</td><td>"+n+"</td><td class='hide landscapeShow'>"+o+"</td><td class='hide landscapeShow'>"+s+"</td><td>"+i+"</td><td class='hide landscapeShow editable'>"+r+"</td>"),editableStyling(r,l)}function updateAdminExisting(e,t,a,n,o,s,i,r,d,c,l,u){var m=e;$("#"+m).html("<td class='lockImage'>"+d+"</td><td class='bold'>"+t+"</td><td>"+a+"</td><td>"+n+"</td><td class='hide landscapeShow'>"+o+"</td><td class='hide landscapeShow'>"+s+"</td><td class='hide landscapeShow'>"+i+"</td><td class='hide landscapeShow'>"+c+"</td><td class='hide landscapeShow editable'>"+r+"</td>"),editableStyling(r,m)}function updateTable(e,t,a,n,o,s,i,r,d,c){var l=e,u=editableStyling(r);return'<tr id="'+l+'"class="'+(c+u.tr)+'"><td class="'+("bold lockImage"+u.td)+'">'+t+"</td><td>"+a+"</td><td>"+n+'</td><td class="hide landscapeShow">'+o+'</td><td class="hide landscapeShow">'+s+"</td><td>"+i+'</td><td class="hide landscapeShow editable">'+r+"</td></tr>"}function updateAdminTable(e,t,a,n,o,s,i,r,d,c,l,u){var m=e,p=editableStyling(r);return'<tr id="'+m+'" class="'+(u+p.tr)+'"><td class="'+("lockImage"+p.td)+'">'+d+'</td><td class="bold">'+t+"</td><td>"+a+"</td><td>"+n+'</td><td class="hide landscapeShow">'+o+'</td><td class="hide landscapeShow">'+s+'</td><td class="hide landscapeShow">'+i+'</td><td class="hide landscapeShow">'+c+'</td><td class="hide landscapeShow editable">'+r+"</td></tr>"}function tableUpdateFunction(e,t,a){var n=new Date(e.timeIn),o=addZero(n.getHours())+":"+addZero(n.getMinutes()),s=new Date(e.timeOut),i=addZero(s.getHours())+":"+addZero(s.getMinutes());return tableLogId=1==t?"ad-log-":"log-",e.offRoute&&(tableLogId+="-or"),t?patrolRecordUpdate(e._id,e.offRoute,!0)?updateAdminExisting(e._id,e.patrol,o,i,e.timeWait,e.offRoute,e.totalScore,e.editable,e.base,e.username,"#adminLogsTable",tableLogId):a.push(updateAdminTable(e._id,e.patrol,o,i,e.timeWait,e.offRoute,e.totalScore,e.editable,e.base,e.username,"#adminLogsTable",tableLogId)):e.base===getBaseNumber()?patrolRecordUpdate(e._id,e.offRoute,!1)?updateExisting(e._id,e.patrol,o,i,e.timeWait,e.offRoute,e.totalScore,e.editable,"#logsTable",tableLogId):a.push(updateTable(e._id,e.patrol,o,i,e.timeWait,e.offRoute,e.totalScore,e.editable,"#logsTable",tableLogId)):void 0}function updateTableFromAllDocs(e,t){for(var a=[],n=0,o=e.total_rows;n<o;n++){tableUpdateFunction(e.rows[n].doc,t,a)}if(a.length>0){if(t)var s=$("#adminLogsTable");else s=$("#logsTable");s.prepend(a.reverse())}orientationLandscapeUpdate()}function dbUpdateFromFindOrChange(e,t,a){for(var n=/_(\d)/g,o=[],s=0,i=[],r=navi.topPage.name,d=(e.last_seq,0),c=e.docs.length;d<c;d++){var l=e.docs[d];try{if(l._deleted>0){if(removePatrolRecord(l._id,t)){$("#"+l._id).remove();var u=l._id.split(n)[1];!deleteNotificationCleared||u!=base&&0!==base||(deleteNotificationCleared=!1,ons.notification.alert({title:"HQ deleted some logs",messageHTML:"For your awareness HQ have deleted logs and they will be removed from your log list",cancelable:!0}).then(function(e){deleteNotificationCleared=!0}))}}else if(null!=l.patrol)l.patrol.length>0&&(l.patrol!==a&&a&&void 0!==a||tableUpdateFunction(l,t,o));else if(/message/i.test(l._id))s++,"messagesPage.html"===r&&i.push(l);else if("eventDescription"===l._id){var m=l._rev.split(/\W/g)[0];ons.notification.alert({title:"Event Update",messageHTML:"<p>This event has been updated by the event organisers to version: "+m+".</p><p>Your device will update once this message closes.</p>",cancelable:!0}).then(function(){var e;if("messagesPage.html"===navi.topPage.name){var t=navi.pages.length-2;e=navi.pages[t].name}else e=navi.topPage.name;navi.resetToPage("updatePage.html",{animation:pageChangeAnimation,data:{eventInfo:l,lastPage:e}})}).catch(function(e){})}}catch(e){}}if(o.length>0){if(t)var p=$("#adminLogsTable");else p=$("#logsTable");p.prepend(o.reverse())}if(s>0)if("messagesPage.html"===r){var h={include_docs:!0,endkey:newestMessage,startkey:"message￰",descending:!0,limit:void 0},g=basedb;t&&(g=admindb);var f=$("#messagesPage .page__content");Promise.resolve().then(function(){return addMessages(g,$("#messageWindow"),f,h,!1,!1)}).then(function(){if($("#scrollToBottomFab").prop("visible")){var e=(parseInt($("#scrollMessageBadge").html())||0)+s,t=" new message";e>1&&(t+="s"),$("#scrollMessageBadge").html(e+t).removeClass("hide")}else scrollToElement(f,f[0].scrollHeight,1);nextSeq=dbSeqNumber+=s,localStorage.dbSeqNumber=dbSeqNumber}).catch(function(e){})}else{updateMsgBadgeNo((parseInt($("#messageBadge").html())||0)+s),nextSeq+=s}orientationLandscapeUpdate()}function clearQuickAddInputs(){$(".quickAddInput").val(""),$("#wait").val("0"),$("#offRoute").prop("checked",!1),$("#total").prop("disabled",!1)}function editLog(e){for(var t=e.length,a=((new Date).toISOString(),0),n=t;a<n;a++){var o=e[a];basedb.get(o).then(function(e){switch(e.editable){case!1:ons.notification.alert({title:"No longer editable",message:"This record has been locked by the event admins and cannot be edited",cancelable:!0});break;case!0:var t=new Date(e.timeIn),a=new Date(e.timeOut);switch($("#patrolNo").val(e.patrol),$("#timeIn").val(addZero(t.getHours())+":"+addZero(t.getMinutes())),$("#timeOut").val(addZero(a.getHours())+":"+addZero(a.getMinutes())),$("#wait").val(e.timeWait),$("#total").val(e.totalScore),e.offRoute){case!0:$("#offRoute").prop("checked",!0);break;case!1:$("#offRoute").prop("checked",!1)}scrollToElement($("#page1 .page__content"),0,400)}})}}function deleteRecords(e){for(var t=e.length,a=(new Date).toISOString(),n=0,o=t;n<o;n++){var s=e[n];attemptCount=0,writeUntilWrittenDelete(s,a),$("#"+s).remove()}ons.notification.alert({title:t+" logs deleted",message:"You have deleted "+t+" logs. This has updated the record in the database to deleted and will sync up with other users now.",cancelable:!0})}function writeUntilWrittenDelete(e,t){admindb.get(e).then(function(e){return admindb.put({_id:e._id,_rev:e._rev,username:name,timestamp:t,_deleted:!0})}).then(function(e){return!0}).catch(function(a){if(404===a.status&&admindb.put({_id:e,_rev:origRev,username:name,timestamp:t,_deleted:!0}).then(function(e){return!0}).catch(function(e){}),409===a.status)return attemptCount<5&&(attemptCount++,writeUntilWrittenDelete(e))})}function lockOrUnlockLogFromEdits(e,t){var a=e.length,n=(new Date).toISOString();switch(t){case!1:var o="unlocked",s="allow";break;case!0:o="locked",s="stop"}for(var i=0,r=a;i<r;i++){var d=e[i];admindb.get(d).then(function(e){switch(t){case!0:e.editable=!1;break;case!1:e.editable=!0}switch(e.timestamp=n,tableUpdateFunction(e,!0),t){case!0:$("#"+d).addClass("lockedLog");break;case!1:$("#"+d).removeClass("lockedLog")}return admindb.put(e)}).then(function(){orientationLandscapeUpdate()}).catch(function(e){})}ons.notification.alert({title:a+" logs "+o,message:"You have set "+a+" to "+o+". This will propagate to other users to "+s+" them the ability to update the log.",cancelable:!0})}function checkConnection(){return navigator.connection.type}function changeAtSymbol(e){return e.replace("@",",40,")}function changeAtSymbolBack(e){return e.replace(",40,","@")}function loginPut(e){var t=(new Date).toISOString();return appdb.put({_id:e._id,_rev:e._rev,base:base,name:name,timestamp:t})}function logOutPageChange(){return navi.bringPageTop("loginPage.html",{animation:pageChangeAnimation}).then(function(e){return $("#userName").val(name),$(".adminCleanAll").remove(),deleteIndexes(),e}).catch(function(e){})}function deleteIndexes(){return offRouteIndex=[],offRouteIndexAdmin=[],patrolRecord=[],patrolRecordAdmin=[],!0}function closeDatabases(){basedbConnected&&!syncBasedb.canceled&&(syncBasedb.cancel(),basedbConnected=!1,baseSyncInProgress=!1),admindbConnected&&!adminSync.canceled&&(adminSync.cancel(),admindbConnected=!1,adminSyncInProgress=!1),null==evtUpdateCheck||evtUpdateCheck.canceled||evtUpdateCheck.cancel(),deleteIndexes()}function baseLogOut(){if(navi.topPage.data.firstPage){var e={animation:pageChangeAnimation,data:{eventInfo:navi.topPage.data.eventInfo}};navi.replacePage("loginPage.html",e)}else{e={animation:pageChangeAnimation};navi.popPage(e)}return closeDatabases(),logOutPageChange(),document.getElementById("menu").toggle(),menuController(),appdb.get("login_"+username).then(function(e){var t=(new Date).toISOString();return e.base="logOut",e.timestamp=t,appdb.put(e)}).catch(function(e){throw e})}function signOut(){navi.resetToPage("signInPage.html",{animation:pageChangeAnimation}),baseNames=[],baseCodes=[],document.getElementById("menu").toggle(),closeDatabases(),basedb=void 0,admindb=void 0,remotedb=void 0,remotedbConnected=!1,localStorage.lastDb="false",localStorage.verified="false",localStorage.evtOrganiser="false"}function goToEventSummary(){var e=navi.topPage.data;navi.bringPageTop("eventSummaryPage.html",{animation:pageChangeAnimation,data:e}).then(function(){document.getElementById("menu").toggle()})}function changeEvent(){document.getElementById("menu").toggle(),baseNames=[],baseCodes=[],closeDatabases(),basedb=void 0,admindb=void 0,remotedb=void 0,remotedbConnected=!1,localStorage.lastDb="false";var e={animation:pageChangeAnimation};return navi.resetToPage("eventSelectionPage.html",e)}function editEvent(){document.getElementById("menu").toggle(),closeDatabases();var e={animation:pageChangeAnimation,data:{edit:!0,eventInfo:navi.topPage.data.eventInfo}};return navi.bringPageTop("createEventPage.html",e)}function getBaseNumber(){return base}function apiAjax(e,t){return{async:!0,crossDomain:!0,url:e,method:"POST",dataType:"json",xhrFields:{withCredentials:!1},headers:{"content-type":"application/x-www-form-urlencoded"},data:t}}function baseSelectValue(e){return document.getElementById("baseSelectDialog").hide(),$("#baseCode").val(e).text("Selected base: "+baseNames[e])}function loginAndRunFunction(e,t){if(null!=t)var a={animation:pageChangeAnimation,data:t};else a={animation:pageChangeAnimation};switch(e){case"logOut":logOutPageChange();break;case-1:alert("incorrect login information saved, please log in again"),navi.bringPageTop("loginPage.html",a);break;case 0:navi.bringPageTop("admin.html",a);break;default:navi.bringPageTop("page1.html",a)}}function addAppdbLoginDb(e){return appdb.get("login_"+username).then(function(t){return void 0===t.db?t.db=[e]:-1===t.db.indexOf(e)&&t.db.push(e),t.currentDb=e,t.timestamp=(new Date).toISOString(),appdb.put(t)}).catch(function(t){if(404===t.status)return appdb.put({_id:"login_"+username,db:[e],currentDb:e,timestamp:(new Date).toISOString()});throw t.message="issue saving event to device",t})}function compareTwoArrays(e,t,a){if(a)return $(e).not(t).get();if(e.length!==t.length)return!1;for(var n=0,o=e.length;n<o;n++)if(e[n]!==t[n])return!1;return!0}function downscaleImg(e,t,a){var n=imgStats(e);if(n.width<t&&n.height<a)return!1;var o=a/n.height*n.width;return o<t?t=o:a=t/n.width*n.height,{width:Math.floor(t),height:Math.floor(a)}}function imgStats(e){try{var t=e.naturalHeight,a=e.naturalWidth,n=a/t,o=!0}catch(e){}return t>a&&(o=!1),{height:t,width:a,ratio:n,landscape:o}}function stepped_scale(e,t,a){if(void 0===a)a=.5;return Promise.resolve().then(function(){var n=document.createElement("canvas"),o=n.getContext("2d"),s=document.createElement("canvas"),i=s.getContext("2d");if(n.width=t,n.height=n.width*e.naturalHeight/e.naturalWidth,e.width*a>t){var r=1/a,d={width:Math.floor(e.width*a),height:Math.floor(e.height*a)};for(s.width=d.width,s.height=d.height,i.drawImage(e,0,0,d.width,d.height);d.width*a>t;)d={width:Math.floor(d.width*a),height:Math.floor(d.height*a)},i.drawImage(s,0,0,d.width*r,d.height*r,0,0,d.width,d.height);o.drawImage(s,0,0,d.width,d.height,0,0,n.width,n.height)}else o.drawImage(e,0,0,n.width,n.height);return n}).then(function(e){return getCanvasBlob(e)}).then(function(e){return e}).catch(function(e){})}function getCanvasBlob(e){return new Promise(function(t,a){return e.toBlob(function(e){return t(e)})})}function menuController(){switch(navi.topPage.name){case"page1.html":$("#baseLogOut").removeClass("hide").find("div.center").html("Leave Base"),$("#goToMap").removeClass("hide"),menuEvtOrganiser();break;case"admin.html":$("#baseLogOut").removeClass("hide").find("div.center").html("Leave Admin Area"),menuEvtOrganiser(),$("#copyAllLogs, #goToEventSummary").removeClass("hide");break;case"loginPage.html":menuEvtOrganiser(),$("#baseLogOut, #copyAllLogs").addClass("hide");break;case"eventSelectionPage.html":$("#baseLogOut , #eventChanger , #eventEditor, #copyAllLogs").addClass("hide");break;default:menuEvtOrganiser(),$("#baseLogOut, #copyAllLogs").addClass("hide")}lastSyncHandler()}function menuEvtOrganiser(){"true"===localStorage.evtOrganiser?$("#eventEditor , #eventChanger, #goToEventSummary").removeClass("hide"):$("#eventEditor , #eventChanger, #goToEventSummary").addClass("hide")}function participantReference(e,t){if(""===e||void 0===e)return!1;var a=$("#"+t+" .participantRef");a.each(function(t){var n=a[t].innerHTML;a[t].innerHTML=n.replace(/team/i,e)}),"page1"===t&&$("#patrolNo").attr("placeholder",e+" No.")}function copyToClipboard(e){var t=$("<input>");$("body").append(t),t.val(e.html()).select(),document.execCommand("copy"),t.remove()}function copyAllLogs(){copyToClipboard($("#allLogsCopy")),ons.notification.alert({title:"All logs table added to clipboard",messageHTML:"<p>You have just added the whole admin logs table to your clipboard.</p><p>This is in the form of an html table, paste into Microsoft Excel or HTML file to view.</p>",cancelable:!0})}function scrollToElement(e,t,a){e.animate({scrollTop:t},a)}function openMessages(){var e={animation:pageChangeAnimation,data:{currentBase:getBaseNumber(),eventInfo:navi.topPage.data.eventInfo}};navi.bringPageTop("messagesPage.html",e)}function lastSyncHandler(){void 0!==lastSync&&lastSyncUpdater(lastSync)}function lastSyncUpdater(e){if(void 0===e){var t=new Date;lastSync=addZero(t.getHours())+":"+addZero(t.getMinutes())+":"+addZero(t.getSeconds())}else lastSync=e;$(".lastSync").html("last sync: "+lastSync),$(".normalTitle").addClass("hide"),$(".syncTitle").removeClass("hide")}function isScrolledIntoView(e){var t=e.getBoundingClientRect().top,a=e.getBoundingClientRect().bottom;return t>=0&&a<=window.innerHeight}function addZero(e){return e<10&&(e="0"+e),e}document.addEventListener("deviceready",onDeviceReady,!1),document.addEventListener("pause",onPause,!1),document.addEventListener("resume",onResume,!1),ons.ready(function(){if(ons.platform.isIOS()||ons.forcePlatformStyling("android"),orientationLandscapeUpdate(),ons.orientation.on("change",function(){orientationUpdates()}),$(document).on("click",".menuButton",function(){document.getElementById("menu").toggle(),$("#menu").addClass("menuShadow")}),$("#menu").on("postclose",function(){$("#menu").removeClass("menuShadow")}),!1===appdbConnected&&(appdb=new PouchDB(appDatabaseName,{auto_compaction:!0}),appdbConnected=!0),"true"===localStorage.previousSignIn&&"false"!=lastDb?appdb.get("login_"+username).then(function(e){base=e.base,name=e.name,appdbConnected=!0;var a=appServer+"/api/signin",n={username:username,password:password};return $.ajax(apiAjax(a,n)).then(function(a){var n=a.user.roles.sort(),o=e.db.sort();if(!1===compareTwoArrays(n,o,!1)){if(e.db=n,appdb.put(e).then(function(e){return appdb.compact()}).then(function(e){var a=compareTwoArrays(n,o,!0);return Promise.all(a.map(function(e){return t(e,["eventDescription"],!1)}))}).catch(function(e){}),localStorage.db=JSON.stringify(e.db),e.db.indexOf(lastDb)>-1)return e;var s={status:307,message:"last database does not match current user's databases"};throw s}return e}).catch(function(t){if(307===t.status)throw t;if(401===t.status&&"unauthorized"===t.error)throw t;return e})}).then(function(e){return new PouchDB(lastDb).get("eventDescription").then(function(t){return t.lastBase=e.base,t}).catch(function(e){throw e})}).then(function(e){var t={eventInfo:e,firstPage:!0};if("number"==typeof e.lastBase)if(0===e.lastBase)var a="admin.html";else a="page1.html";else a="loginPage.html";return navi.bringPageTop(a,{animation:pageChangeAnimation,data:t})}).catch(function(e){return navi.bringPageTop("signInPage.html",{animation:pageChangeAnimation})}):navi.bringPageTop("signInPage.html",{animation:pageChangeAnimation}),ons.platform.isWebView()){document.addEventListener("offline",function(){$(".logTable").before('<div class="offlineMessage"><ons-icon icon="md-refresh-sync-alert"></ons-icon> Offline - sync to HQ will resume when online<div>'),$(".offlineMap").html("Local Map - Offline")},!1),document.addEventListener("online",function(){$(".offlineMessage").remove(),$(".offlineMap").html("Local Map")},!1)}function e(e,t){switch(t){case!0:return $("#"+e+" .progressBar").removeClass("hide"),!0;case!1:return $("#"+e+" .progressBar").addClass("hide"),!1}}function t(e,t,a){if(a)o=new PouchDB(e),n=new PouchDB(http+username+":"+password+"@"+couchdb+"/"+e);else var n=new PouchDB(e),o=new PouchDB(http+username+":"+password+"@"+couchdb+"/"+e);var s={doc_ids:t};return o.replicate.to(n,s).then(function(e){return e.docs_written>0}).catch(function(e){throw e})}function a(e,t){if(null!=t)return t;if(null!=e._attachments&&null!=e._attachments.evtLogo)return new PouchDB(e.dbName).getAttachment("eventDescription","evtLogo").then(function(e){return URL.createObjectURL(e)}).catch(function(e){})}var n=function(e,t,a){var n=a?function(t){return a(t[e])}:function(t){return t[e]};return t=t?-1:1,function(e,a){return e=n(e),a=n(a),t*((e>a)-(a>e))}};document.addEventListener("postpush",function(o){switch(navi.topPage.name){case"signInPage.html":null!=username&&$("#signInUserName").val(changeAtSymbolBack(username)),$(".signUpButton").hasClass("evtHandler")||$(".signUpButton").addClass("evtHandler").on("click",function(){navi.bringPageTop("signUpPage.html",{animation:pageChangeAnimation})}),$("#signInPassword").hasClass("evtHandler")||$("#signInPassword").addClass("evtHandler").on("keyup",function(e){13===e.which&&(e.preventDefault(),$(".signInButton").click())}),$(".signInButton").hasClass("evtHandler")||$(".signInButton").addClass("evtHandler").on("click",function(){e("signInPage",!0),username=changeAtSymbol($("#signInUserName").val().trim()),password=$("#signInPassword").val().trim();var a=appServer+"/api/signin",n={username:username,password:password};$.ajax(apiAjax(a,n)).then(function(e){if(200===e.status){"undefined"!=typeof localStorage&&(localStorage.couchdb=e.couchdb,localStorage.http=e.http,localStorage.username=username,localStorage.password=password,localStorage.db=JSON.stringify(e.user.roles),localStorage.previousSignIn=!0,void 0!==e.user.metadata&&(localStorage.evtOrganiser=e.user.metadata.evtOrganiser,null!=e.user.metadata.verification&&(localStorage.verified=e.user.metadata.verification.verified))),couchdb=e.couchdb,http=e.http,M=e.user.roles;var t=(new Date).toISOString();return appdb.get("login_"+username).then(function(a){return a.db=M,a.timestamp=t,a.http=http,a.couchdb=couchdb,appdb.put(a).then(function(t){return e}).catch(function(e){throw e})}).catch(function(a){if(404===a.status){var n={_id:"login_"+username,db:M,timestamp:t,http:http,couchdb:couchdb};return appdb.put(n).then(function(t){if(t.ok)return e}).catch(function(e){})}throw a})}throw e}).then(function(e){return Promise.all(M.map(function(e){return t(e,["eventDescription"],!1)})).then(function(t){return e.user.metadata}).catch(function(e){throw e})}).then(function(e){var t;Promise.resolve().then(function(){if(!(e.evtOrganiser&&e.verification.verified||!e.evtOrganiser))return t="verificationPage.html",!1;switch(M.length){case 1:return t="loginPage.html",new PouchDB(M[0]).get("eventDescription").then(function(e){return localStorage.lastDb=e.dbName,lastDb=e.dbName,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb,{eventInfo:e}}).catch(function(e){throw e});case 0:return e.evtOrganiser?(t="createEventPage.html",!1):(ons.notification.alert({title:"This event has finished",message:"The events associated with these log in details have finished",cancelable:!0}),t="signInPage.html",!1);default:if("false"==lastDb||null==lastDb)return t="eventSelectionPage.html",{db:M};t="loginPage.html";var a=M.indexOf(lastDb);if(a>-1)return new PouchDB(M[a]).get("eventDescription").then(function(e){return lastDb=e.dbName,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb,{eventInfo:e}}).catch(function(e){throw e})}}).then(function(e){if(!1!==e){a={animation:pageChangeAnimation,data:e};return navi.resetToPage(t,a)}var a={animation:pageChangeAnimation};return navi.bringPageTop(t,a)}).catch(function(e){throw e})}).catch(function(e){if($("#signInPage .progressBar").addClass("hide"),401===e.status)return ons.notification.alert({title:e.error,messageHTML:"<p>"+e.message+"</p><p>Be aware that both your username and password are case sensitive.</p>",cancelable:!0});if(404===e.status&"Event information not found on server"===e.title)return!1;var t;switch(ons.platform.isWebView()&&(t=checkConnection()),t){case"none":return ons.notification.alert({title:"Error",message:"Couldn't connect to server because this device is offline.",cancelable:!0});default:return ons.notification.alert({title:"Error",message:"Couldn't connect to server, please try again later.",cancelable:!0})}})});break;case"signUpPage.html":var s=!1,i=!1,r=!1,d=!1,c=!1;if(!$("#signUpEmail").hasClass("evtHandler")){var l="";$("#signUpEmail").addClass("evtHandler").on("blur",function(){var e=document.getElementById("signUpEmail").getElementsByTagName("input");if($(e)[0].checkValidity()){var t=appServer+"/api/user/checkusername",a=changeAtSymbol($("#signUpEmail").val().trim()),n={username:a};a!=l&&""!=a&&$.ajax(apiAjax(t,n)).then(function(e){switch(e.status){case 200:i=a,r=!0;break;case 409:s||(s=!0,ons.notification.alert({title:e.message,message:e.reason,cancelable:!0}).then(function(){s=!1}));break;case 500:default:s||(s=!0,ons.notification.alert({title:"error",message:"issue validating email address is unique",cancelable:!0}).then(function(){s=!1}))}}).catch(function(e){s||(s=!0,ons.notification.alert({title:"Error connecting to server",message:"We are very sorry there was an error connecting to the server to validate your email address is unique please try submitting your sign up or come back later.",cancelable:!0}).then(function(){s=!1}))}),l=a}else s||(s=!0,r=!1,ons.notification.alert({title:"Invalid email",message:"Please enter a valid email address like: event@hikemanager.com",cancelable:!0}).then(function(){s=!1}))})}$("#signUpPassword").hasClass("evtHandler")||$("#signUpPassword").addClass("evtHandler").on("blur",function(){var e=$(this).val().trim();e.length>=6?d!=e&&(d=e,c=e===$("#signUpPasswordConfirm").val()):(d=e,s||(s=!0,ons.notification.alert({title:"Longer password required",message:"Minimum of 6 characters",cancelable:!0}).then(function(){s=!1})))}),$("#signUpPasswordConfirm").hasClass("evtHandler")||$("#signUpPasswordConfirm").addClass("evtHandler").on("blur",function(){var e=$(this).val().trim();e===d&&""!=d?d.length>=6?c=!0:s||(s=!0,ons.notification.alert({title:"Longer password required",message:"Minimum of 6 characters",cancelable:!0}).then(function(){s=!1})):""===e&&!1===d?(s=!0,ons.notification.alert({title:"Please enter a password",messageHTML:"Please enter a password to confirm",cancelable:!0}).then(function(){s=!1})):(c=!1,s||(s=!0,ons.notification.alert({title:"Password does not match",messageHTML:"Your passwords do not match",cancelable:!0}).then(function(){s=!1})))}).on("keyup",function(e){13===e.which&&(e.preventDefault(),$(".signUpInputButton").click())}),$(".signUpInputButton").hasClass("evtHandler")||$(".signUpInputButton").addClass("evtHandler").on("click",function(){switch(r&&c){case!0:var e=appServer+"/api/user/new",t={username:i,password:d,evtOrganiser:!0};$.ajax(apiAjax(e,t)).then(function(e){switch(e.status){case 200:navi.replacePage("verificationPage.html"),username=i,password=d,"undefined"!=typeof localStorage&&(localStorage.username=i,localStorage.password=d,localStorage.verified=!1,localStorage.evtOrganiser=!0,localStorage.previousSignIn=!0);break;default:ons.notification.alert({title:"error",message:"Something has gone wrong that isn't your fault please contact support",cancelable:!0})}}).catch(function(e){ons.notification.alert({title:"error",message:"error: "+e.toString(),cancelable:!0})});break;case!1:var a="<p>Please complete the following:</p>";!1===r&&(a+="<p>Enter a email</p>"),!1===c&&(a+="<p>Enter and confirm your password</p>"),ons.notification.alert({title:"Missing fields",messageHTML:a,cancelable:!0})}});break;case"verificationPage.html":$("#verificationCode").hasClass("evtHandler")||$("#verificationCode").addClass("evtHandler").on("keyup",function(e){13===e.which&&(e.preventDefault(),$("#verifyAccountButton").click())}),$("#verifyAccountButton").hasClass("evtHandler")||$("#verifyAccountButton").addClass("evtHandler").on("click",function(){var e=appServer+"/api/user/verify",t={username:localStorage.username,token:$("#verificationCode").val().trim()};""!=t.token&&$.ajax(apiAjax(e,t)).then(function(e){switch(e.status){case 200:navi.replacePage("createEventPage.html"),"undefined"!=typeof localStorage&&(localStorage.verified=!0);break;case 401:ons.notification.alert({title:"Incorrect code",message:"This code does not match your user account, please check you entered it correctly.",cancelable:!0});break;case 500:ons.notification.alert({title:"Error",message:e.err.toString(),cancelable:!0})}}).catch(function(e){ons.notification.alert({title:"Error sending verification code",message:"failed to send verification code because of: "+e.toString(),cancelable:!0})})}),$("#resendVerificationCode").hasClass("evtHandler")||$("#resendVerificationCode").addClass("evtHandler").on("click",function(){var e=appServer+"/api/user/resendverification",t={username:username};$.ajax(apiAjax(e,t)).then(function(e){ons.notification.alert({title:"Email sent",message:"Your new verification email has been sent",cancelable:!0})}).catch(function(e){ons.notification.alert({title:"Error",message:"There was an issue re-sending your verification email, please try again",cancelable:!0})})});break;case"createEventPage.html":var u,m=!1,p={},h=[],g=!1,f=1,v=navi.topPage.data,b=!1;function w(e){var t,a=$(e),n=$(e).val();if(""!=n)if(h.indexOf(n)>-1){if(t=!1,null!=p[e.id]){if(p[e.id]!=n){t=!0;var o=h.indexOf(p[e.id]);h.splice(o,1),delete p[e.id]}}else t=!0;t&&ons.notification.alert({title:"Password Error",message:"The admin and base passwords must be unique.",cancelable:!0}).then(function(){a.val("")})}else if(null!=p[e.id]){if(p[e.id]!=n){o=h.indexOf(p[e.id]);h.splice(o,1),p[e.id]=n,h.push(n)}}else h.push(n),p[e.id]=n;else if(null!=p[e.id]&&p[e.id]!=n){o=h.indexOf(p[e.id]);h.splice(o,1),delete p[e.id]}};function S(e){var t='<div class="baseSetUp"><p class="txtLeft bold marginTop">Base '+e+'</p><ons-input id="base'+e+'Name" modifier="underbar" placeholder="Base name or location" float type="text" class="fullWidthInput"></ons-input><div class="flex flexRow flexSpaceBetween marginTop"><div class="caption"><span class="bold">Maximum score available</span><br/><span class="marginLeft">(blank = no score input)</span></div><ons-input id="base'+e+'MaxScore" modifier="underbar" placeholder="Max score" float type="number" class="baseMaxScore" required></ons-input></div><div class="flex flexRow flexSpaceBetween marginTop basePasswordShowHide"><div class="caption bold">Base password *</div><ons-input id="base'+e+'Password" modifier="underbar" placeholder="Password" float type="text" class="basePassword eventPassword maxWidth50per" required></ons-input></div><textarea class="textarea marginTop" id="base'+e+'Instructions" placeholder="Base specific instructions" style="width: 100%; height:45px;"></textarea></div>';return $(".addBaseButton").before(t)}function y(e){switch(e){case!0:$(".basePasswordShowHide").addClass("hide");break;case!1:$(".basePasswordShowHide").removeClass("hide")}}function C(){eventDescription={_id:"eventDescription",eventName:$("#eventName").val().trim(),dateStart:$("#eventStartDate").val(),dateEnd:$("#eventEndDate").val(),pRef:$("#pReference").val().trim(),eventDescription:$("#eventDescription").val().trim(),passwordProtectLogs:$("#passwordSwitch").prop("checked"),logOffRoute:$("#offRouteLogsSwitch").prop("checked"),autoTime:$("#autoTimeSwitch").prop("checked"),adminPassword:$("#adminPassword").val(),evtUsername:$("#evtUsername").val(),bases:[{baseNo:0,baseName:"admin HQ",basePassword:$("#adminPassword").val().trim()}]}}function P(t,a,n){for(var o=1,s=t+1;o<s;o++){var i={baseNo:o,baseMaxScore:$("#base"+o+"MaxScore").val(),basePassword:$("#base"+o+"Password").val().trim(),baseInstructions:$("#base"+o+"Instructions").val().trim()},r=$("#base"+o+"Name").val().trim();if(""!==r&&void 0!==r||(r=o),i.baseName=r,u=!1,a&&""===i.basePassword)return ons.notification.alert({title:"Missing Password",message:"Check each base has a password and that the admin password is set, else if passwords are not required turn off the 'Password protect base logs' switch.",cancelable:!0}).then(function(){return e("createEventPage",!1),!1});n.bases.push(i),u=!0}return u}if(!0===v.edit&&null!=v.eventInfo){g=!0;var I=/\W/g;F="string"==typeof(B=v.eventInfo)._rev?parseInt(B._rev.split(I)[0])+1:2,$("#createEventPage .center").html("Edit Event - version: "+F),$("#eventName").val(B.eventName),$("#eventStartDate").val(B.dateStart),$("#eventEndDate").val(B.dateEnd),$("#eventDescription").val(B.eventDescription),$("#pReference").val(B.pRef),$("#passwordSwitch").prop("checked",B.passwordProtectLogs),$("#offRouteLogsSwitch").prop("checked",B.logOffRoute),$("#autoTimeSwitch").prop("checked",B.autoTime),$("#adminPassword").val(B.adminPassword),$("#evtUsername").val(B.evtUsername).prop("disabled",!0),B.bases.forEach(function(e){var t=e.basePassword,a="base"+e.baseNo,n=e.baseNo;""!=t&&h.push(t),n>0?(n>1&&(S(n),f=n),""!=t&&(p[a+"Password"]=t,$("#"+a+"Password").val(t)),$("#"+a+"Name").val(e.baseName),$("#"+a+"MaxScore").val(e.baseMaxScore),$("#"+a+"Instructions").val(e.baseInstructions)):p.adminPassword=t});var k=$("#eventBannerImage");Promise.resolve().then(function(){return a(B,E)}).then(function(e){null!=e?(k.hide().attr("src",e).fadeIn(1500),E=e):k.hide().fadeIn(1500)}).catch(function(e){}),y(!B.passwordProtectLogs)}if(!$("#eventBanner").hasClass("evtHandler")){var D=document.querySelector("#eventBanner");$("#eventBanner").addClass("evtHandler").on("change",function(){var e=$("#eventBannerImage");Promise.resolve().then(function(){return e=D,new Promise(function(t,a){b=e.files[0],t(E=URL.createObjectURL(b))});var e}).then(function(t){return e.attr("src",t)}).catch(function(e){})})}$(".passwordProtectLogs").hasClass("evtHandler")||$(".passwordProtectLogs").addClass("evtHandler").on("click",function(){var e=$("#passwordSwitch");switch(e.prop("checked")){case!0:e.prop("checked",!1),$(".basePasswordShowHide").addClass("hide");break;case!1:e.prop("checked",!0),$(".basePasswordShowHide").removeClass("hide")}}),$("#passwordSwitch").hasClass("evtHandler")||$("#passwordSwitch").addClass("evtHandler").on("change",function(){y(!$("#passwordSwitch").prop("checked"))}),$("#createEventForm").hasClass("evtHandlerPassword")||$("#createEventForm").addClass("evtHandlerPassword").find(".eventPassword").on("blur",function(){w(this)}),$("#offRouteLogs").hasClass("evtHandler")||($("#offRouteLogs").addClass("evtHandler"),$("#offRouteLogs .offRouteLogs").on("click",function(){switch($("#offRouteLogsSwitch").prop("checked")){case!0:$("#offRouteLogsSwitch").prop("checked",!1);break;case!1:$("#offRouteLogsSwitch").prop("checked",!0)}})),$("#automateTimeEntry").hasClass("evtHandler")||($("#automateTimeEntry").addClass("evtHandler"),$("#automateTimeEntry .autoTime").on("click",function(){switch($("#autoTimeSwitch").prop("checked")){case!0:$("#autoTimeSwitch").prop("checked",!1);break;case!1:$("#autoTimeSwitch").prop("checked",!0)}})),$("#evtUsername").hasClass("evtHandler")||$("#evtUsername").addClass("evtHandler").on("blur",function(){var e=$("#evtUsername").val().trim();if(""!=e){var t=appServer+"/api/user/checkusername",a={username:e};$.ajax(apiAjax(t,a)).then(function(e){switch(e.status){case 200:m=!0;break;case 409:ons.notification.alert({title:e.message,message:e.reason,cancelable:!0});break;case 500:default:ons.notification.alert({title:"error",message:"issue checking username is unique",cancelable:!0})}}).catch(function(e){ons.notification.alert({title:"error",message:"issue checking username is unique",cancelable:!0})})}});var T=$(".addBaseButton");T.hasClass("evtHandler")||T.addClass("evtHandler").on("click",function(){S(++f),$("#passwordSwitch").prop("checked")||$(".basePasswordShowHide").addClass("hide");var e=1370+181*f;scrollToElement($("#createEventPage .page__content"),e,1e3),$("#base"+f+"Password").on("blur",function(){w(this)})}),$("#saveEvent").hasClass("evtHandler")||$("#saveEvent").addClass("evtHandler").on("click",function(){if(g){if(g){var a=new PouchDB(B.dbName);n=document.getElementById("eventBannerImage");ons.notification.confirm({title:"Update Event",message:"Are you sure you want to update "+B.eventName,cancelable:!0}).then(function(t){if(1===!t)throw{canceled:!0};return e("createEventPage",!0),0!=b&&Promise.resolve().then(function(){return downscaleImg(n,1922,240)}).then(function(e){return 0!=e&&stepped_scale(n,e.width,.5)}).then(function(e){if(0!=e)return b=e})}).then(function(e){return a.get("eventDescription")}).then(function(e){var t=!1;if(C(),eventDescription.dateStart>eventDescription.dateEnd)throw"Event set to end before it starts.";if(!P(f,eventDescription.passwordProtectLogs,eventDescription))throw"password not set";return $.each(eventDescription,function(a,n){return"bases"==a?n.forEach(function(a){if(void 0===e.bases[a.baseNo])return t=!0,!1;var n=e.bases[a.baseNo];return $.each(a,function(e,a){return a===n[e]||(t=!0,!1)})}):n===e[a]||(t=!0,!1)}),!1!==b?(eventDescription._attachments={evtLogo:{data:b,content_type:b.type}},t=!0):"object"==typeof e._attachments&&(eventDescription._attachments=e._attachments),t?(eventDescription._rev=e._rev,eventDescription.dbName=e.dbName,eventDescription.evtUserPass=e.evtUserPass,a.put(eventDescription)):{ok:!1}}).then(function(e){return e.ok?(eventDescription._rev=e.rev,t(B.dbName,["eventDescription"],!0)):ons.notification.alert({title:"No change found",message:"No change has been detected from previous event information. A new version has not been saved.",cancelable:!0}).then(function(){throw navi.popPage()})}).then(function(e){var t={animation:pageChangeAnimation,data:{eventName:eventDescription.eventName,url:E,eventInfo:eventDescription}};return navi.resetToPage("eventSummaryPage.html",t)}).then(function(e){return new PouchDB(http+username+":"+password+"@"+couchdb+"/"+B.dbName).compact(),closeDatabases()}).catch(function(t){if(e("createEventPage",!1),!0===t.canceled)return!1;var a={title:"Input Error",message:t,cancelable:!0};ons.notification.alert(a)})}}else{if(e("createEventPage",!0),C(),eventDescription.dateStart>eventDescription.dateEnd)return ons.notification.alert({title:"Check event dates",message:"Event set to end before it starts.",cancelable:!0});if(0!=b){var n=document.getElementById("eventBannerImage");Promise.resolve().then(function(){return downscaleImg(n,1922,240)}).then(function(e){return 0!=e&&stepped_scale(n,e.width,.5)}).then(function(e){return 0!=e?b=e:b}).then(function(e){return eventDescription._attachments={evtLogo:{data:e,content_type:e.type}}}).catch(function(e){})}switch(""===eventDescription.eventName||""===eventDescription.dateStart||""===eventDescription.dateEnd||""===eventDescription.adminPassword||""===eventDescription.evtUsername){case!0:ons.notification.alert({title:"Missing attributes",messageHTML:"<p>An event requires the following information:</p><p>A name</p></p><p>Start and end date</p></p><p>An admin password</p><p>An event username</p>"}).then(function(){return e("createEventPage",!1)});break;case!1:if(m){if(P(f,eventDescription.passwordProtectLogs,eventDescription)){var o=appServer+"/api/event/new",s={username:username,password:password,eventName:eventDescription.eventName,eventUsername:eventDescription.evtUsername};$.ajax(apiAjax(o,s)).then(function(e){if(void 0!==localStorage.db){var t=JSON.parse(localStorage.db);t.push(e.dbName),localStorage.db=JSON.stringify(t)}else localStorage.db=e.dbName;localStorage.lastDb=e.dbName,localStorage.couchdb=e.url,localStorage.http=e.http,eventDescription.evtUserPass=e.evtUserPass,eventDescription.dbName=e.dbName;var a=e.http+username+":"+password+"@"+e.url+"/"+e.dbName;return remotedbURL===a||(remotedbURL=a,remotedbConnected?remotedb.close().then(function(e){return remotedbConnected=!1}).catch(function(e){throw e}):remotedbConnected)}).then(function(e){return!1===e?remotedb=new PouchDB(remotedbURL):remotedb}).then(function(e){return e.get("eventDescription").then(function(t){return eventDescription._rev=t._rev,e.put(eventDescription)}).catch(function(t){if(404===t.status)return e.put(eventDescription);throw t.message="unable to upload event description to the database",t})}).then(function(e){return t(eventDescription.dbName,["eventDescription"],!1)}).then(function(e){return addAppdbLoginDb(eventDescription.dbName)}).then(function(e){var t={animation:pageChangeAnimation,data:{eventName:eventDescription.eventName,url:E,eventInfo:eventDescription}};return navi.resetToPage("eventSummaryPage.html",t)}).catch(function(t){return void 0===t.message&&(t.message="issue saving the event"),ons.notification.alert({title:"error",message:t.message,cancelable:!0}).then(function(){return e("createEventPage",!1)})})}}else ons.notification.alert({title:"error",message:"username is not unique, please try a different username",cancelable:!0}).then(function(){return e("createEventPage",!1)})}}});break;case"eventSummaryPage.html":var x=navi.topPage.data.eventName,E=navi.topPage.data.url;if("object"==typeof navi.topPage.data.eventInfo)var B=navi.topPage.data.eventInfo;else B=eventDescription;if(!$("#eventSummaryPage").hasClass("evtLoaded")){$("#eventSummaryPage").addClass("evtLoaded"),$("#evtSummaryTitle").html(x);var L=new Date(B.dateStart),_=new Date(B.dateEnd);$("#evtSummaryStartDate").append(addZero(L.getHours())+":"+addZero(L.getMinutes())+" on "+L.toDateString()),$("#evtSummaryEndDate").append(addZero(_.getHours())+":"+addZero(_.getMinutes())+" on "+_.toDateString()),$("#evtSummaryBaseCount").append(B.bases.length),$("#evtSummaryUsername").append(B.evtUsername),$("#evtSummaryPassword").append(B.evtUserPass),""!==B.eventDescription&&$("#evtSummaryDescription").append(B.eventDescription.replace(/\n/g,"<br>")),$("#evtSummaryAdminPass").append(B.bases[0].basePassword);var N=[];if(B.bases.forEach(function(e){var t='<div class="baseSummaryInfo"><p class="bold evtSummaryBasesTitle">Base '+e.baseNo+": "+e.baseName+"</p>";void 0===e.baseMaxScore||""===e.baseMaxScore?message="no score available at this location":message=e.baseMaxScore,t+='<p><span class="bold sentanceCase">Max Score Available: </span>'+message+"</p>",B.passwordProtectLogs&&(t+='<p><span class="bold sentanceCase">Base code: </span><span class="passwordFont">'+e.basePassword+"</span></p>"),"string"==typeof e.baseInstructions&&""!==e.baseInstructions&&(t+='<p><span class="bold sentanceCase">Base instructions: </span>'+e.baseInstructions.replace(/\n/g,"<br>")+"</p>"),t+="</div>",N.push(t)}),$("#evtSummaryBases").append(N),Promise.resolve().then(function(){return a(B,E)}).then(function(e){null!=e&&($("#evtSummaryBanner").append('<img src="'+e+'" class="loginLogo marginTop" id="eventSummaryBannerImage">'),E=e)}).catch(function(e){}),$("#goToEvent").on("click",function(){lastDb=B.dbName,localStorage.lastDb=lastDb,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb;var e={animation:pageChangeAnimation,data:navi.topPage.data},t=navi.pages[0].name;return"loginPage.html"===t||"admin.html"===t?navi.popPage():navi.resetToPage("loginPage.html",e)}),"true"===localStorage.evtOrganiser){$(".evtSendEmail").on("click",function(){var e=appServer+"/api/event/email",t={username:username,password:password,db:B.dbName};return $.ajax(apiAjax(e,t)).then(function(e){return U=200!==e.status?{title:"Error",message:"There was an issue sending you an email with the event details, please try again later.",cancelable:!0}:{title:"Email Sent",messageHTML:'<p>An email has been sent to you at the email address you use to sign in:</p><p class="secondaryColor">'+changeAtSymbolBack(username)+"</p><p>Please check your inbox it should be with you shortly.</p><p>This will contain instructions you can distribute to your users on how start using the app or website.</p>",cancelable:!0}}).then(function(e){return ons.notification.alert(e)})});var O=$("#eventSummaryPage .page__content"),H=document.getElementById("sendEventEmailButtonContainer"),R=document.getElementById("emailEvtDescription");O.on("scroll",function(){return isScrolledIntoView(H)?R.hide():R.show()})}else $(".evtSendEmail").addClass("hide")}break;case"loginPage.html":if("string"==typeof name&&"undefined"!==name&&$("#userName").val(name),void 0!==navi.topPage.data.eventInfo){B=navi.topPage.data.eventInfo;if(!evtUpdateCheckConnected){evtUpdateCheckConnected=!0;var M=new PouchDB(B.dbName),A=new PouchDB(http+username+":"+password+"@"+couchdb+"/"+B.dbName),U={doc_ids:["eventDescription"],live:!0,retry:!0},q=!1;evtUpdateCheck=M.replicate.from(A,U).on("change",function(e){if(!q){q=!0;var t=e.docs[0]._rev.split(/\W/g)[0];ons.notification.alert({title:"Event Updated",messageHTML:"<p>This event has been updated by the event organisers to version: "+t+".</p><p>Your device will update once this message closes.</p>",cancelable:!0}).then(function(e){var t={animation:pageChangeAnimation,data:{event:B.dbName,lastPage:"loginPage.html"}};navi.resetToPage("updatePage.html",t),evtUpdateCheck.cancel(),q=!1})}}).on("paused active denied error",function(e){}).on("complete",function(e){evtUpdateCheckConnected=!1})}$("#loginEventDescription").html(B.eventDescription.replace(/\n/g,"<br>"));var F;L=new Date(B.dateStart),_=new Date(B.dateEnd),I=/\W/g;F="string"==typeof B._rev?B._rev.split(I)[0]:1,$("#loginEventDescriptionTitle").after('<span id="evtVersion">Event version: '+F+'</span><p><span class="bold">Start</span>: '+L.toDateString()+" at "+addZero(L.getHours())+":"+addZero(L.getMinutes())+'<br><span class="bold">End</span>: '+_.toDateString()+" at "+addZero(_.getHours())+":"+addZero(_.getMinutes())+"</p>");E=navi.topPage.data.url,k=$("#loginEventLogo");if(Promise.resolve().then(function(){return a(B,E)}).then(function(e){null!=e?(k.hide().attr("src",e).removeClass("hide").fadeIn(1500),E=e):k.hide().removeClass("hide").fadeIn(1500)}).catch(function(e){}),B.passwordProtectLogs){B.bases.forEach(function(e){var t=e.basePassword;""===t&&(t=e.baseNo.toString()),baseCodes.push(t),baseNames.push(e.baseName)});var W="Please enter both your name and your base code provided by the event organisers.",j="Welcome to "+B.eventName+" please enter your name and base code below:";(Z=$("#baseCode")).hasClass("evtHandler")||Z.addClass("evtHandler").on("keyup",function(e){13===e.which&&(e.preventDefault(),$(".loginButton").click())})}else{var Z;W="Please enter both your name and select a base.",j="Welcome to "+B.eventName+" please enter your name and select a base below:";$("#baseCode").replaceWith('<ons-button class="primaryColorButton" modifier="large" id="baseCode">Select a base</ons-button>'),(Z=$("#baseCode")).hasClass("evtHandler")||Z.addClass("evtHandler").on("click",function(){var e=document.getElementById("baseSelectDialog");null===e?ons.createDialog("baseSelectDialog.html").then(function(e){e.addEventListener("preshow",function(e){var t=navi.topPage.data.eventInfo.bases;baseCodes=[],baseNames=[];var a=$("#loginBaseSelect");a.empty(),t.forEach(function(e){var t=e.baseNo.toString(),n=e.baseName;baseCodes.push(t),baseNames.push(n),a.append('<ons-list-item onClick="baseSelectValue('+t+')" class="baseSelectItem"  id="baseSelect_'+t+'" value ="'+t+'"><label class="left"><ons-input name="color" type="radio" input-id="radio-'+t+'"></ons-input></label><label for = "radio-'+t+'"class = "center" >'+n+"</label></ons-list-item>")})}),e.show()}).catch(function(e){}):e.show()}),$("#betweenNameAndBase").html("Select your base by pressing the button below:"),$("#loginCodeCaption").remove()}$("#loginWelcome").html(j),$("#loginTitle .normalTitle,#loginTitle .mainTitle").html(B.eventName)}var Q=$("#loginButton"),K=$("#baseCode"),Y=$("#userName");Q.hasClass("evtHandler")||Q.addClass("evtHandler").on("click",function(){var e=(new Date).toISOString();B.eventName;return Promise.resolve().then(function(){if(""===K.val()||""===Y.val())throw{message:W,title:"Missing inputs",cancelable:!0};var e=K.val().toLowerCase().trim();if(name=Y.val(),!((base=baseCodes.indexOf(e))>-1))throw{message:"Please try re-entering your base code or contact the event organisers",title:"Incorrect Base Code",cancelable:!0};return base}).then(function(e){return 0!==e||B.passwordProtectLogs?e:ons.notification.prompt({title:"Enter Admin Code",messageHTML:"To enter the admin area please enter the admin code provided to you by the event organisers:",cancelable:!0,placeholder:"Enter admin code here"}).then(function(t){if(t.toLowerCase().trim()!==B.adminPassword)throw{title:"Admin code Error",message:"Please try re-entering your admin code, the code you entered was incorrect.",cancelable:!0};return e})}).then(function(t){return appdb.get("login_"+username).then(function(t){return t.base=base,t.name=name,t.currentDb=B.dbName,t.timestamp=e,appdb.put(t)}).catch(function(e){return ons.notification.alert({title:"Error saving user",message:"You have logged in but there was an error saving your user credentials, the app will require you to log in again if you close it.",cancelable:!0})})}).then(function(e){loginAndRunFunction(base,{eventInfo:B}),evtUpdateCheck.cancel()}).catch(function(e){return ons.notification.alert(e)})}),menuController("loginPage.html");break;case"eventSelectionPage.html":var z=$("#ongoingEvents"),V=$("todaysEvents"),J=$("#upcomingEvents"),G=$("#pastEvents"),X=JSON.parse(localStorage.db);Promise.all(X.map(function(e){return new PouchDB(e).get("eventDescription").then(function(t){var n,o=new Date,s=o.getDay(),i=o.getMonth(),r=o.getFullYear(),d=new Date(t.dateStart),c=d.getDay(),l=d.getMonth(),u=d.getFullYear(),m=new Date(t.dateEnd);n=d<o&&o<m?z:o<d&&c===s&&l===i&&u===r?V:o<d?J:o>m?G:J;var p='<div class="card shadow--2dp" id="'+e+'"><div class="cardMediaDiv"></div><div class="material-card__title">'+t.eventName+'</div><div class="material-card__actions material-card--border"><ons-button modifier="quiet" class="goToEventButton secondaryColor">Enter event</ons-button><ons-button modifier="quiet" class="goToSummary secondaryColor">Info</ons-button><ons-button modifier="quiet" ripple class="cardIconButton rotate270 evtInstructionsShow button--material button--material--flat"><i class="zmdi zmdi-chevron-left chevron"></i></ons-button></div><div class="material-card__supporting-text hide">'+t.eventDescription.replace(/\n/g,"<br>")+'</div><div class="cardTRButton"><ons-button modifier="quiet" ripple class="cardIconButton hide"><i class="zmdi zmdi-share"></i></ons-button></div></div><br>';n.append(p),n.find(".eventTitle").removeClass("hide");var h=$("#"+e);h.data("eventInfo",t),$("#"+e+" .goToEventButton").on("click",function(){var e=h.data("eventInfo");lastDb=e.dbName,localStorage.lastDb=lastDb,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb;var t={animation:pageChangeAnimation,data:{eventInfo:e}};navi.resetToPage("loginPage.html",t)});var g=$("#"+e+" .evtInstructionsShow");return g.on("click",function(){g.toggleClass("rotate90"),$("#"+e+" .material-card__supporting-text").slideToggle(500)}),$("#"+e+" .goToSummary").on("click",function(){var e=h.data("eventInfo"),t=(h.find(),{animation:pageChangeAnimation,data:{eventInfo:e}});navi.bringPageTop("eventSummaryPage.html",t)}),a(t)}).then(function(t){if(null!=t)return $("#"+e+" .cardMediaDiv").css({"background-image":'url("'+t+'")',"background-repeat":"no-repeat","background-position":"center top","background-size":"cover",height:240,"min-height":100}),!0}).catch(function(e){})}));var ee=$("#createNewEventButton");ee.hasClass("evtHandler")||ee.addClass("evtHandler").on("click",function(){var e={animation:pageChangeAnimation,data:{edit:!1}};navi.bringPageTop("createEventPage.html",e)}),menuController("eventSelectionPage.html");break;case"page1.html":menuController("page1.html");var te=document.getElementById("fullEditFab");te.hide(),userCurrentlySelected=[],$("#fullEditFab").removeClass("hide");var ae=$("#logsTable");if(void 0!==navi.topPage.data.eventInfo){var ne=(B=navi.topPage.data.eventInfo).bases[getBaseNumber()];""!=ne.baseInstructions&&($("#p1TopHalf").prepend('<div id="instructions"><ons-list><ons-list-item tappable><div class="left"><span id="baseInstructionsShowHideWord">Hide base instructions</span></div><div class="right"><i id="instructionChevron" icon="md-chevron-left" class="zmdi zmdi-chevron-left secondaryColor rotate270 chevron"></i></div></ons-list-item></div>'),$("#instructions").append('<div id="baseInstructions" class="baseInstructions">'+B.bases[getBaseNumber()].baseInstructions.replace(/\n/g,"<br>")+"</div>"),$("#instructions").on("click",function(){$("#instructionChevron").toggleClass("rotate90"),$("#baseInstructions").slideToggle(500);var e=$("#baseInstructionsShowHideWord");"Hide base instructions"===e.html()?e.html("Show base instructions"):e.html("Hide base instructions")})),""===ne.baseMaxScore||void 0===ne.baseMaxScore?$("#page1TotalScore").hide():$("#total").attr("placeholder","Total score (max "+ne.baseMaxScore+")"),1==B.autoTime&&$("#p1TopHalf .page1Time").hide(),baseDatabaseName=B.dbName}function oe(e){e.length>0&&ae.prepend(e),orientationLandscapeUpdate(),clearQuickAddInputs()}base>0?($("#page1 .normalTitle, #page1 .mainTitle").html("Base "+base+" @ "+B.bases[getBaseNumber()].baseName),$("#quickAddTitle").html("Add new log from base "+base),participantReference(B.pRef,"page1")):"noBase"===base&&($("#page1 .normalTitle,#page1 .mainTitle").html("On the look out"),$("#quickAddTitle").html("Record the teams you see"),$("#tableTitle").html("Teams seen")),$("#logsTable").empty(),!1===basedbConnected&&(basedb=new PouchDB(baseDatabaseName),basedbConnected=!0),basedb.createIndex({index:{fields:["timeOut"],name:"timeOutIndex",ddoc:"timeOutIndex",type:"json"}}).then(function(e){return basedb.createIndex({index:{fields:["base","timeOut"],name:"baseTimeOutIndex",ddoc:"baseTimeOutIndex",type:"json"}})}).then(function(e){return basedb.createIndex({index:{fields:["patrol"],name:"patrolIndex",ddoc:"patrolIndex",type:"json"}})}).then(function(e){return basedb.find({selector:{timeOut:{$gt:0},base:{$eq:base}},sort:["timeOut"]})}).then(function(e){return dbUpdateFromFindOrChange(e,!1)}).then(function(e){return basedb.createIndex({index:{fields:["base"],name:"baseIndex",ddoc:"baseIndex",type:"json"}})}).then(function(e){if(!1===remotedbConnected&&(remotedb=new PouchDB(remotedbURL),remotedbConnected=!0),!1===baseSyncInProgress){return baseSyncInProgress=!0,syncBasedb=basedb.sync(remotedb,{live:!0,retry:!0}).on("change",function(e){"pull"===e.direction&&dbUpdateFromFindOrChange(e.change,!1)}).on("paused",function(e){lastSyncUpdater()}).on("active",function(e){}).on("error",function(e){ons.notification.alert({title:"Error",messageHTML:"<p>An error has occured with the following message</p><p>"+e.message+"</p>",cancelable:!0}),e.status}).on("complete",function(e){baseSyncInProgress=!1})}}).catch(function(e){}),checkForNewMessagesOnPageLoad(basedb,dbSeqNumber),B.logOffRoute&&!$("#offRouteCheckbox").hasClass("evtHandler")?($("#offRouteCheckbox").addClass("evtHandler").removeClass("logOffRouteFalse"),$(".checkbox").on("click",".checkbox__input",function(){$("#offRoute.checkbox__input").is(".checkbox__input:checked")?$("#total").prop("disabled",!0):$("#total").prop("disabled",!1)})):B.logOffRoute||$("#offRouteCheckbox").addClass("logOffRouteFalse"),$("#logsTable").hasClass("evtHandler")||($("#logsTable").addClass("evtHandler"),$("#logsTable").on("click","tr",function(e){if($(this).hasClass("lockedLog"))ons.notification.alert({title:"No longer editable",message:"This record has been locked by HQ and cannot be edited",cancelable:!0});else if($(this).hasClass("tableSelected")){$(this).removeClass("tableSelected");var t=$(this).attr("id"),a=userCurrentlySelected.indexOf(t);a>-1&&userCurrentlySelected.splice(a,1),$("tr").hasClass("tableSelected")||te.hide()}else{$("tr").removeClass("tableSelected"),$(this).addClass("tableSelected"),te.show(),userCurrentlySelected=[];t=$(this).attr("id");userCurrentlySelected.push(t)}})),$("#fullEditFab").hasClass("evtHandler")||($("#fullEditFab").addClass("evtHandler"),$("#fullEditFab").on("click",function(){editLog(userCurrentlySelected)})),$("#cancelSubmitQuick").hasClass("evtHandler")||($("#cancelSubmitQuick").addClass("evtHandler"),$("#cancelSubmitQuick").on("click",function(){ons.notification.confirm({message:"Are you sure you want to clear this entry?",cancelable:!0}).then(function(e){1==e&&clearQuickAddInputs()})})),$("#submitQuick").hasClass("evtHandler")||($("#submitQuick").addClass("evtHandler"),$("#submitQuick").on("click",function(){base=getBaseNumber(),sqPatrol=$("#patrolNo").val(),o=$("#timeIn").val(),sqTimeOut=$("#timeOut").val(),sqWait=$("#wait").val(),sqOffRoute=$("#offRoute").prop("checked"),sqTotalScore=$("#total").val();var e="",t=Date.now(),a=(new Date).toISOString(),n=[];if(""===o)var o=new Date;else if(5==o.length){var s=o.split(":");(o=new Date).setHours(s[0]),o.setMinutes(s[1]),o.setSeconds(0)}if(""===sqTimeOut)sqTimeOut=new Date;else if(5==sqTimeOut.length){var i=sqTimeOut.split(":");(sqTimeOut=new Date).setHours(i[0]),sqTimeOut.setMinutes(i[1])}if(""===sqPatrol&&(e="<p>Patrol number</p>"),sqOffRoute||""!==sqTotalScore||""===ne.baseMaxScore||(e+="<p>Total score for the patrol</p>"),""!==e)ons.notification.alert({title:"Missing fields",messageHTML:"<p>This log entry is missing the following fields:</p>"+e,cancelable:!0});else if(parseInt(sqTotalScore)>parseInt(ne.baseMaxScore))ons.notification.alert({title:"Total score",message:"The total score entered is greater than the maximum points available at a base.",cancelable:!0});else if(o>sqTimeOut)ons.notification.alert({title:"Time input",message:"The time out must be after the time in.",cancelable:!0});else if(sqOffRoute&&""!=sqTotalScore)ons.notification.confirm({title:"Confirm off route or log score",messageHTML:"<p>You have entered a score of "+sqTotalScore+" and that the team was off route.</p><p>Select whether you wish to submit an off route log with no score or an on route log with a score of "+sqTotalScore+".</p>",cancelable:!0,buttonLabels:["Off route - no score","On route - score of "+sqTotalScore]}).then(function(e){switch(e){case 0:$("#total").val(""),$("#submitQuick").click();break;case 1:$("#offRoute").prop("checked",!1),$("#submitQuick").click()}}).catch(function(e){});else{""==sqWait&&(sqWait=0),(sqOffRoute&&""!=sqTotalScore||"noBase"===base)&&(sqTotalScore=""),B.logOffRoute||(sqOffRoute="n/a");var r={_id:sqPatrol+"_base_"+base,patrol:sqPatrol,base:base,username:name,timeIn:o,timeOut:sqTimeOut,timeWait:sqWait,offRoute:"",totalScore:sqTotalScore,editable:!0,timestamp:a};switch(sqOffRoute){case!0:r._id=sqPatrol+"_base_"+base+"_offRoute_"+t,r.offRoute=sqOffRoute,tableUpdateFunction(r,!1,n),oe(n),basedb.put(r);break;default:basedb.get(r._id).then(function(e){switch(e.editable){case!0:return ons.notification.confirm({title:"Update",message:"Are you sure you want to update patrol number "+sqPatrol,cancelable:!0}).then(function(t){if(1===t)return r._rev=e._rev,r._id=e._id,basedb.put(r).then(function(e){return tableUpdateFunction(r,!1,n)})}).catch(function(e){});case!1:return ons.notification.alert({title:"No longer editable",message:"This record has been updated by HQ and cannot be edited",cancelable:!0})}}).catch(function(e){if(404==e.status)return tableUpdateFunction(r,!1,n),basedb.put(r);if(409==e.status)switch(doc.editable){case!0:var t={_id:doc._id,_rev:doc._rev,patrol:sqPatrol,base:base,username:name,timeIn:o,timeOut:sqTimeOut,timeWait:sqWait,offRoute:"",totalScore:sqTotalScore,editable:!0,timestamp:a};basedb.put(t).then(function(){return tableUpdateFunction(t,!1,n)});break;case!1:ons.notification.alert({title:"No longer editable",message:"This record has been recorded by HQ and cannot be edited, please contact HQ to unlock",cancelable:!0})}}).then(function(e){oe(n)})}}}));break;case"admin.html":var se,ie,re=!1,de=[],ce=$("#patrolSearch"),le=$("#adminTitleDiv");function ue(e,t,a){timeStarting=Date.now();for(var n=[],o=0,s=e.docs.length;o<s;o++){var i=e.docs[o];if("number"!=typeof re||i.patrol===re){var r=de.indexOf(i.patrol);if(t||!(r>-1)){var d="on route";i.offRoute&&(d="off route");var c=new Date(i.timeOut),l=addZero(c.getHours())+":"+addZero(c.getMinutes()),u='<tr id="ls-'+i.patrol+'"><td class="bold">'+i.patrol+"</td><td>"+l+"</td><td>"+i.base+"</td><td>"+d+'</td><td class="hide landscapeShow">'+i.username+"</td></tr>";r>-1?($("#lastSeenTable #ls-"+i.patrol).remove(),n=u):(de.push(i.patrol),n.unshift(u))}}}a.append(n),orientationLandscapeUpdate()}function me(e,t){admindb.find({selector:{timeOut:{$gt:0}},fields:["_id","base","patrol","timeOut","offRoute","username"],sort:[{timeOut:"desc"}]}).then(function(a){return ue(a,t,e)}).catch(function(e){})};function pe(e,t){e.empty(),admindb.query("leaderboardIndex",{reduce:!0,group:!0}).then(function(e){return e.rows.sort(n("value",!0))}).then(function(e){return a=e,n=t,o=1,s="",Promise.all(a.map(function(e){s===e.value&&o--;var t='<tr id="lb-'+o+'"><td class="bold">'+o+"</td><td>"+e.key+"</td><td>"+e.value+"</td></tr>";if(o++,s=e.value,!n||n===e.key||void 0===n)return t}));var a,n,o,s}).then(function(t){e.append(t)}).catch(function(e){})};if(menuController("admin.html"),null!=navi.topPage.data.eventInfo){B=navi.topPage.data.eventInfo;adminDatabaseName=B.dbName}if(!ce.hasClass("evtHandler")){ce.addClass("evtHandler");var he=!1,ge=!1;ce.on("click",function(){if(he)ge&&($("#patrolSearchInput").removeClass("hide"),le.addClass("adminHide"));else{le.addClass("adminHide");$(this).prepend('<ons-input id="patrolSearchInput" type="number" modifier="underbar" placeholder="Patrol No." float class="patrolSearchInput" autofocus></ons-input>'),he=!0,$(document).ready(function(){$("#patrolSearchInput").focus().on("keyup blur",function(e){if(13===e.which||"blur"===e.type){var t=$(this).val();re!=t&&""!==t?(re=t,admindb.find({selector:{timeOut:{$gt:0},patrol:{$eq:re}},sort:["timeOut"]}).then(function(e){$("#adminLogsTable").empty(),patrolRecordAdmin=[],offRouteIndexAdmin=[],dbUpdateFromFindOrChange(e,!0),null!=se&&(de=[],se.empty(),ue(e,!0,se)),null!=ie&&pe(ie,re)})):""===t&&re!=t&&!1!==re&&"blur"===e.type?($(this).addClass("hide"),le.removeClass("adminHide"),ge=!0,admindb.find({selector:{timeOut:{$gt:0}},sort:["timeOut"]}).then(function(e){re=!1,$("#adminLogsTable").empty(),patrolRecordAdmin=[],offRouteIndexAdmin=[],dbUpdateFromFindOrChange(e,!0),null!=se&&void 0!==se&&(se.empty(),de=[],me(se,!1)),null!=ie&&pe(ie,re)})):""===t&&($(this).addClass("hide"),le.removeClass("adminHide"),ge=!0)}})})}})}document.getElementById("adminTabbar").addEventListener("postchange",function(t){switch(t.tabItem.getAttribute("page")){case"allLogsPage.html":var a=$("#allLogsPage");if(participantReference(B.pRef,"allLogsPage"),!a.hasClass("evtHandler")){a.addClass("evtHandler");var n=document.getElementById("adminSpeedDial");n.hide(),adminCurrentlySelected=[];0==admindbConnected&&(admindb=new PouchDB(adminDatabaseName),admindbConnected=!0),admindb.createIndex({index:{fields:["timeOut"],name:"timeOutIndex",ddoc:"timeOutIndex",type:"json"}}).then(function(e){return admindb.createIndex({index:{fields:["base","timeOut"],name:"baseTimeOutIndex",ddoc:"baseTimeOutIndex",type:"json"}})}).then(function(e){return admindb.createIndex({index:{fields:["patrol"],name:"patrolIndex",ddoc:"patrolIndex",type:"json"}})}).then(function(e){return admindb.createIndex({index:{fields:["base"],name:"baseIndex",ddoc:"baseIndex",type:"json"}})}).then(function(e){return admindb.get("_design/leaderboardIndex").then(function(e){return e}).catch(function(e){var t={_id:"_design/leaderboardIndex",views:{leaderboardIndex:{map:function(e){"string"==typeof e.patrol&&emit(e.patrol,parseInt(e.totalScore)||0)}.toString(),reduce:"_sum"}}};return admindb.put(t)})}).then(function(e){return admindb.find({selector:{timeOut:{$gt:0}},sort:["timeOut"]})}).then(function(e){return dbUpdateFromFindOrChange(e,!0)}).then(function(e){if(!1===remotedbConnected&&(remotedb=new PouchDB(remotedbURL),remotedbConnected=!0),!1===adminSyncInProgress){return adminSyncInProgress=!0,adminSync=admindb.sync(remotedb,{live:!0,retry:!0}).on("change",function(e){"pull"===e.direction&&dbUpdateFromFindOrChange(e.change,!0,re)}).on("paused",function(e){lastSyncUpdater()}).on("active",function(e){}).on("error",function(e){ons.notification.alert({title:error,message:"A connection error has occured please, refresh the app or web page",cancelable:!0})}).on("complete",function(e){adminSyncInProgress=!1})}}).catch(function(e){}),$("#adminSpeedDial").removeClass("hide"),$("#adminLogsTable").hasClass("evtHandler")||$("#adminLogsTable").addClass("evtHandler").on("click","tr",function(e){if($(this).hasClass("tableSelected")){$(this).removeClass("tableSelected");var t=$(this).attr("id"),a=adminCurrentlySelected.indexOf(t);a>-1&&adminCurrentlySelected.splice(a,1),$("tr").hasClass("tableSelected")||n.hide()}else if(1==e.shiftKey){$(this).addClass("tableSelected"),n.show();t=$(this).attr("id");adminCurrentlySelected.push(t)}else{$("tr").removeClass("tableSelected"),$(this).addClass("tableSelected"),n.show(),adminCurrentlySelected=[];t=$(this).attr("id");adminCurrentlySelected.push(t)}}),$("#adminDelete").hasClass("evtHandler")||($("#adminDelete").addClass("evtHandler"),$("#adminDelete").on("click",function(){ons.notification.confirm({title:"Are you sure?",message:"Are you sure you wish to delete these "+adminCurrentlySelected.length+" logs",cancelable:!0}).then(function(e){1==e&&deleteRecords(adminCurrentlySelected)})})),$("#adminLock").hasClass("evtHandler")||$("#adminLock").addClass("evtHandler").on("click",function(){lockOrUnlockLogFromEdits(adminCurrentlySelected,!0)}),$("#adminUnlock").hasClass("evtHandler")||$("#adminUnlock").addClass("evtHandler").on("click",function(){lockOrUnlockLogFromEdits(adminCurrentlySelected,!1)}),checkForNewMessagesOnPageLoad(admindb,dbSeqNumber)}break;case"lastSeenPage.html":void 0===se&&(se=$("#lastSeenTable")),se.hasClass("evtListener")||(se.addClass("evtListener"),e("adminPage",!0),participantReference(B.pRef,"lastSeenPage"),me(se,!1),e("adminPage",!1),adminSync.on("change",function(t){if(e("adminPage",!0),0===("string"==typeof re?t.change.docs.filter(function(e){return e.patrol===re}):t.change.docs.filter(function(e){return"string"==typeof e.patrol})).length)return e("adminPage",!1);se.empty(),de=[],me(se,!1),e("adminPage",!1)}));break;case"leaderboard.html":void 0===ie&&(ie=$("#leaderboardTable")),ie.hasClass("evtListener")||(ie.addClass("evtListener"),e("adminPage",!0),participantReference(B.pRef,"leaderboard"),pe(ie,re),e("adminPage",!1),adminSync.on("change",function(t){if(e("adminPage",!0),0===("string"==typeof re?t.change.docs.filter(function(e){return e.patrol===re}):t.change.docs.filter(function(e){return"string"==typeof e.patrol})).length)return e("adminPage",!1);pe(ie,re),e("adminPage",!1)}))}});break;case"messagesPage.html":var fe=navi.topPage.data.currentBase,ve=(B=navi.topPage.data.eventInfo,$("#messageWindow")),be=$("#messageInput"),we=document.getElementById("newMessages"),Se=$("#messageInputPlaceholder"),$e=basedb,ye=$("#messagesPage .page__content"),Ce=($("#messagesPage"),!0),Pe=$("#scrollToBottomFab"),Ie=$("#scrollMessageBadge");function ke(){var e=(new Date).toISOString(),t={_id:"message-"+e,message:be.html().trim(),from:fe,time:e,username:name};$e.put(t).then(function(e){e.ok&&(be.html(""),Se.removeClass("hide"),De=!0,nextSeq=++dbSeqNumber,localStorage.dbSeqNumber=dbSeqNumber)}).then(function(e){return addMessages($e,ve,ye,{include_docs:!0,endkey:newestMessage,startkey:"message￰",descending:!0,limit:void 0},!1,!0,!0)}).catch(function(e){}),""===be.html()&&(Se.removeClass("hide"),De=!0)};dbSeqNumber=nextSeq,localStorage.dbSeqNumber=nextSeq,0===fe&&($e=admindb,adminSync),Pe[0].hide(),addMessages($e,ve,ye,U={include_docs:!0,endkey:"message",startkey:"message￰",descending:!0,limit:25},!1,!0,!0);var De=!0;be.on("keydown",function(e){De&&(Se.addClass("hide"),De=!1),13!=e.which||e.shiftKey||e.preventDefault()}).on("keyup",function(e){13!=e.which||e.shiftKey||""!==be.html().trim()&&ke()}),$("#sendMessage").on("click",function(){""!==be.html().trim()&&ke()}),lastSyncHandler(),Pe.on("click",function(){var e=ye[0].scrollHeight;scrollToElement(ye,e,1)}),updateMsgBadgeNo(0,!0),ye.on("scroll",function(){return Ce&&nextMessageEndKey!==nextMessageEndKey2&&function e(){return Ce=!1,Promise.resolve().then(function(){var t=ye.scrollTop();return t<120?(nextMessageEndKey2=nextMessageEndKey,addMessages($e,ve,ye,{include_docs:!0,endkey:"message",startkey:nextMessageEndKey,descending:!0,limit:10},!0,!0,!1,t).then(function(t){return ye.scrollTop()<300&&nextMessageEndKey!==nextMessageEndKey2?e():Ce=nextMessageEndKey!==nextMessageEndKey2})):(Ce=!0,!0)}).catch(function(e){})}(),isScrolledIntoView(we)?(Pe[0].hide(),void Ie.html(0).addClass("hide")):Pe[0].show()});break;case"updatePage.html":var Te,xe=navi.topPage.data;U={animation:pageChangeAnimation,data:{firstPage:!0}},closeDatabases(),Promise.resolve().then(function(){if(void 0===xe.lastPage)throw"no last page defined";return Te=navi.topPage.data.lastPage,null!=xe.eventInfo?U.data.eventInfo=xe.eventInfo:null!=xe.event?new PouchDB(xe.event).get("eventDescription").then(function(e){U.data.eventInfo=e}).catch(function(e){throw e}):void 0}).then(function(e){navi.resetToPage(Te,U)}).catch(function(e){ons.notification.alert({title:"Issue Updating",message:"There was an issue updating, please sign in again to fix",cancelable:!0}).then(function(){Te="signInPage.html",navi.resetToPage(Te,U)})});break;case"testPage.html":var Ee=Stripe("pk_test_Oy2WT7ZOCDFPn0znWKqZ4zQQ"),Be=Ee.elements().create("card",{style:{base:{fontSize:"16px",color:"#32325d"}}});Be.addEventListener("change",function(e){var t=document.getElementById("card-errors");e.error?t.textContent=e.error.message:t.textContent=""}),document.getElementById("payment-form").addEventListener("submit",function(e){e.preventDefault(),Ee.createToken(Be).then(function(e){var t,a,n;e.error?document.getElementById("card-errors").textContent=e.error.message:(t=e.token,a=document.getElementById("payment-form"),(n=document.createElement("input")).setAttribute("type","hidden"),n.setAttribute("name","stripeToken"),n.setAttribute("value",t.id),a.appendChild(n),a.submit())})}),Be.mount("#card-element")}})});
