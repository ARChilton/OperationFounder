var eventDescription,appdb,basedb,remotedb,admindb,syncBasedb,adminSync,evtUpdateCheck,adminCurrentlySelected,userCurrentlySelected,nextMessageEndKey,nextMessageEndKey2,adminDatabaseName,baseDatabaseName,lastSync,adminShowMap,base,personName,tableLogId,sqPatrol,sqTimeIn,sqTimeOut,sqWait,sqOffRoute,sqTotalScore,baseCodes=[],baseNames=[],appdbConnected=!1,basedbConnected=!1,remotedbConnected=!1,admindbConnected=!1,adminSyncInProgress=!1,baseSyncInProgress=!1,evtUpdateCheckConnected=!1,deleteNotificationCleared=!0,attemptCount=0,menu=document.getElementById("menu"),newestMessage="message",dbSeqNumber=parseInt(localStorage.dbSeqNumber),nextSeq=0,username=localStorage.username,password=localStorage.password,lastDb=localStorage.lastDb,couchdb=localStorage.couchdb,http=localStorage.http,appDatabaseName="oppFounderLoginDb",remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb,appServer="https://checkpointlive.com/app",followGPS=!1,maps={},mapLayers={},BING_KEY="AqVat8HR9TsQF1uwWckLU_1Dv_wrrDR3ThriJUmZyDhPcHRGwpeTDA9NVhKaS5RX",mapboxTkn="pk.eyJ1IjoiYXJjaGlsdG9uIiwiYSI6ImNpdm1mdGk4NjA3eDUyenBveTgwejB2dWIifQ.ehb0-8mRLEpQ9R89H0HlvQ",turnCachingOn=!0,reCacheAfter=2592e6,bingOS=L.tileLayer.bing({bingMapsKey:BING_KEY,imagerySet:"ordnanceSurvey",maxNativeZoom:17,maxZoom:19,minZoom:10,useCache:turnCachingOn,crossOrigin:!0,cacheMaxAge:reCacheAfter,attribution:'<img class="bingLogo" src="./img/bingLogo/bing_maps_logo_gray.png">'}),mapboxAttributes='Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',mapboxURL="https://api.mapbox.com/styles/v1/{source}/{style}/tiles/256/{z}/{x}/{y}?access_token="+mapboxTkn,streets=L.tileLayer(mapboxURL,{style:"streets-v10",source:"mapbox",attribution:mapboxAttributes,useCache:turnCachingOn,crossOrigin:!0,cacheMaxAge:reCacheAfter}),dark=L.tileLayer(mapboxURL,{style:"dark-v9",source:"mapbox",attribution:mapboxAttributes,useCache:turnCachingOn,crossOrigin:!0,cacheMaxAge:reCacheAfter}),satellite=L.tileLayer(mapboxURL,{style:"satellite-v9",source:"mapbox",attribution:mapboxAttributes,useCache:turnCachingOn,crossOrigin:!0,cacheMaxAge:reCacheAfter}),sat_streets=L.tileLayer(mapboxURL,{style:"satellite-streets-v10",source:"mapbox",attribution:mapboxAttributes,useCache:turnCachingOn,crossOrigin:!0,cacheMaxAge:reCacheAfter}),highlightFootpath=L.tileLayer(mapboxURL,{style:"cjggxt9wq00462sme3kihy7cd",source:"archilton",attribution:mapboxAttributes,useCache:turnCachingOn,crossOrigin:!0,cacheMaxAge:reCacheAfter}),chkPtLiveIcon=L.icon({iconUrl:"./img/map-pin.svg",iconSize:[25,40],iconAnchor:[12.5,40],tooltipAnchor:[0,-36],shadowUrl:"./img/marker-shadow.png"}),patrolRecord=[],patrolRecordAdmin=[],offRouteIndex=[],offRouteIndexAdmin=[],geolocation=localStorage.geolocation,pageChangeAnimation="none";function checkForMessagesSinceSeqNo(e,t){var a={since:t},n=/message/i;return e.changes(a).then(function(e){return nextSeq=e.last_seq,e.results.filter(function(e){return n.test(e.id)&&!e.deleted})})}function updateMsgBadgeNo(e,t){return t?$("#messageBadge").html(0).addClass("hide"):$("#messageBadge").html(e).removeClass("hide")}function checkForNewMessagesOnPageLoad(e,t){Promise.resolve().then(function(){return checkForMessagesSinceSeqNo(e,t)}).then(function(e){return!(e.length<1)&&updateMsgBadgeNo(e.length)}).catch(function(e){})}function addMessages(e,t,a,n,o,i,s,r){void 0!=n.limit&&!1!==n.limit&&n.limit++;var c=t.height();return e.allDocs(n).then(function(e){return formBubbleMessages(e.rows,n.limit,o)}).then(function(e){return o?t.prepend(e.reverse()).height():t.append(e.reverse()).height()}).then(function(e){return i&&(r=s?a[0].scrollHeight:e-c+r,scrollToElement(a,r,1)),e}).catch(function(e){return!1})}function formBubbleMessages(e,t,a){var n=!1,o=0,i=e.length,s=getBaseNumber(),r=new Date,c=new Date;return c.setDate(c.getDate()-1),Promise.all(e.map(function(e){var d=e.doc;if("string"==typeof d.message){var l="bubble",u="msg",m="bubble";if(d.date=new Date(d._id.replace("message-","")),d.time=addZero(d.date.getHours())+":"+addZero(d.date.getMinutes()),d.from=parseInt(d.from),d.to=parseInt(d.to),d.msgBaseNo="Checkpoint "+d.from,0===d.from&&(d.msgBaseNo="Admin HQ"),!n&&i>1)return a||(newestMessage=d._id),n=Object.assign({},d),void o++;if(1!==i||(n=Object.assign({},d),d.from="n/a",document.getElementById("topDateMsgBubble").innerHTML=dateString(d.date,r,c),d._id!==nextMessageEndKey)){n.from===s?l+=" message-out":l+=" message-in",n.from!==d.from?l+=" tail":u+=" msgContinued",void 0===n.from&&(n.from="unknown");var p='<div id="'+n._id+'" class="'+u+'"><div class="'+l+'"><div class="msgFrom color-'+n.from+'">'+n.username+" @ "+n.msgBaseNo+'</div><div class=" message-text">'+n.message+'</div><div class="bubble-text-meta msgTimeStamp ">'+n.time+"</div></div></div>";if(n.date.toDateString()!==d.date.toDateString()&&(p=dateBubble(n.date,r,c)+p),n=Object.assign({},d),++o!==t){if(o===t-1||i<t&&o===i&&i>1){d.from===s?(m+=" message-out",u+=" topMsg"):(m+=" message-in",u+=" topMsg"),i<t&&(m+=" tail"),nextMessageEndKey=d._id;var h='<div id="'+d._id+'" class="'+u+'"><div class="'+m+'"><div class="msgFrom color-'+d.from+'">'+d.username+" @ "+d.msgBaseNo+'</div><div class=" message-text">'+d.message+'</div><div class="bubble-text-meta msgTimeStamp ">'+d.time+"</div></div></div>";return document.getElementById("topDateMsgBubble").innerHTML=dateString(d.date,r,c),h+p}}else if(o===t)return void(nextMessageEndKey=d._id);return p}}}))}function dateString(e,t,a){var n=e.toDateString();return n===t.toDateString()?"Today":n===a.toDateString()?"Yesterday":n}function dateBubble(e,t,a){return'<div class="msg dateMsgDivider"><div class="bubble dateBubble">'+dateString(e,t,a)+"</div></div>"}function orientationLandscapeUpdate(){ons.orientation.isLandscape()?($(".landscapeHide").addClass("hide"),$(".landscapeShow").removeClass("hide"),$(".speed__dial.fab--bottom__right").attr("direction","left")):$(".speed__dial.fab--bottom__right").attr("direction","up")}function orientationUpdates(){ons.orientation.isLandscape()?($(".landscapeHide").addClass("hide"),$(".landscapeShow").removeClass("hide"),$(".speed__dial.fab--bottom__right").attr("direction","left")):($(".landscapeShow").addClass("hide"),$(".landscapeHide").removeClass("hide"),$(".speed__dial.fab--bottom__right").attr("direction","up"))}function destroyPouchDBs(){new PouchDB(baseDatabaseName).destroy().then(function(){ons.notification.alert(baseDatabaseName+"/basedb database destroyed")}),new PouchDB(appDatabaseName).destroy().then(function(){ons.notification.alert(appDatabaseName+"/opFounderAppDb database destroyed")}),new PouchDB(adminDatabaseName).destroy().then(function(){ons.notification.alert(adminDatabaseName+"/admindb database destroyed")})}function cleanAll(){ons.notification.prompt({title:"Clean all databases",messageHTML:"<p>You are about to delete all items from the central database, this will propagate out to all other devices, are you sure you want to do this?</p><p>If yes please enter the admin passcode used to access the admin portion of the app</p>",cancelable:!0,placeholder:"Enter admin code here"}).then(function(e){e.toLowerCase()===baseCodes[0]&&admindb.allDocs().then(function(e){for(var t=0,a=e.total_rows;t<a;t++){var n=e.rows[t];if("_design".test(n.id)){var o={_id:n.id,_rev:n.value.rev,_deleted:!0};admindb.put(o).catch(function(e){})}}}).then(function(){admindb.compact().then(function(e){}).catch(function(e){})})})}function addMarkerToLayer(e,t,a,n,o){var i=L.marker([a,n],{icon:chkPtLiveIcon});i.id=t,i.data=o,e.addLayer(i),i.bindTooltip(navi.topPage.data.eventInfo.pRef+" "+o.patrol,{permanent:!1,direction:"top"})}var locateButton=function(e,t,a){switch(e){case 1:maps[a].setView(t.getLatLng(),maps[a].getZoom()),followGPS=!0,$("#fabLocateIcon").replaceWith('<ons-icon icon="md-gps-dot" class="locateAlign locateSelected" id="fabLocateIcon"><ons-icon>');break;case 2:followGPS=!1,$("#fabLocateIcon").replaceWith('<ons-icon icon="md-gps" class="locateAlign locateNotSelected" id="fabLocateIcon"><ons-icon>')}};function zoomToLayer(e,t){return followGPS=!1,locateButton(2),maps[t].fitBounds(e.getBounds(),{maxZoom:maps[t].getZoom()})}function removeLayerFrom(e,t){t.removeLayer(t.getLayers().filter(function(t){return t.id===e})[0])}function createMap(e){var t=$(".tableSelected"),a=t.length;mapLayers[e]=L.markerClusterGroup({showCoverageOnHover:!0,spiderfyOnMaxZoom:!0,removeOutsideVisibleBounds:!0}),maps[e]=L.map(e,{center:[54.52743260123856,-3.0248451206716713],zoom:16,preferCanvas:!0,attributionControl:!1,zoomControl:!1}),L.control.scale({position:"bottomright"}).addTo(maps[e]),L.control.attribution({position:"bottomleft",prefix:!1}).addTo(maps[e]),maps[e].locate({setView:!1,maxZoom:maps[e].getZoom(),watch:!0,enableHighAccuracy:!0}),L.control.iconLayers([{title:"Default",layer:highlightFootpath,icon:"./img/bgmap-img/ac-highlight-footpath.png"},{title:"Ordnance Survey (UK)",layer:bingOS,icon:"./img/bgmap-img/os.png"},{title:"Streets",layer:streets,icon:"./img/bgmap-img/mb-streets.png"},{title:"Satellite",layer:satellite,icon:"./img/bgmap-img/mb-sat.png"},{title:"Satellite-hybrid",layer:sat_streets,icon:"./img/bgmap-img/mb-sat-hybrid.png"},{title:"dark",layer:dark,icon:"./img/bgmap-img/mb-dark.png"}],{position:"topleft",maxLayersInRow:3}).addTo(maps[e]),mapLayers[e].addTo(maps[e]),followGPS=!0,Promise.resolve().then(function(){if(0===a)throw"none selected";return Promise.all(t.map(function(e,t){return admindb.get(t.id)}))}).then(function(e){return e.filter(function(e){return e.geolocation})}).then(function(t){return t.forEach(function(t){addMarkerToLayer(mapLayers[e],t._id,t.geolocation.lat,t.geolocation.lon,t)})}).then(function(){zoomToLayer(mapLayers[e],e)}).catch(function(e){});var n=maps[e].getCenter(),o=L.circle(n,{radius:3,fillColor:"#4285F4",fillOpacity:.2,stroke:!1}).addTo(maps[e]),i=L.circleMarker(n,{radius:8,fill:!0,fillOpacity:1,fillColor:"#4285F4",stroke:!0,color:"#ffffff",weight:3}).bindTooltip("You",{direction:"top"}).addTo(maps[e]);maps[e].on("locationfound",function(t){var a=t.accuracy/2;i.setLatLng(t.latlng),o.setLatLng(t.latlng),o.setRadius(a),n=t.latlng,followGPS&&maps[e].setView(i.getLatLng(),maps[e].getZoom())}),maps[e].on("locationerror",function(e){$("#fabLocate").hide()});var s=$("#"+e+" .locOn");if(!s.hasClass("evtHandler")){s.addClass("evtHandler").on("click",function(){return locateButton(followGPS?2:1,i,e)});var r=function(){followGPS&&locateButton(2,i,e)};$("#map").on("swipe tap click taphold",function(){r()}),maps[e].on("dragstart zoomend",function(){r()})}}function patrolRecordUpdate(e,t,a){return a?t?offRouteIndexAdmin.indexOf(e)>-1||(offRouteIndexAdmin.push(e),!1):patrolRecordAdmin.indexOf(e)>-1||(patrolRecordAdmin.push(e),!1):t?offRouteIndex.indexOf(e)>-1||(offRouteIndex.push(e),!1):patrolRecord.indexOf(e)>-1||(patrolRecord.push(e),!1)}function removePatrolRecord(e,t){var a,n;switch(t){case!0:return a=patrolRecordAdmin.indexOf(e),n=offRouteIndexAdmin.indexOf(e),a>-1?(patrolRecordAdmin.splice(a,1),!0):n>-1&&(offRouteIndexAdmin.splice(n,1),!0);case!1:return a=patrolRecord.indexOf(e),n=offRouteIndex.indexOf(e),a>-1?(patrolRecord.splice(a,1),!0):n>-1&&(offRouteIndex.splice(n,1),!0)}}function editableStyling(e,t){if(void 0===t)return e?{tr:"",td:""}:{tr:" lockedLog",td:" padlockLocked"};e?($("#"+t).removeClass("lockedLog"),$("#"+t+" > .lockImage").removeClass("padlockLocked")):($("#"+t).addClass("lockedLog"),$("#"+t+" > .lockImage").addClass("padlockLocked"))}function updateExisting(e,t,a,n,o,i,s,r){var c=e;$("#"+c).html("<td class='bold lockImage'>"+t+"</td><td>"+a+"</td><td>"+n+"</td><td class='hide landscapeShow'>"+o+"</td><td class='hide landscapeShow'>"+i+"</td><td>"+s+"</td><td class='hide landscapeShow editable'>"+r+"</td>"),editableStyling(r,c)}function updateAdminExisting(e,t,a,n,o,i,s,r,c,d,l){var u=e,m="object"==typeof l?'<ons-icon icon="md-pin" class="adminActiveIcon"></ons-icon>':'<ons-icon icon="md-pin-off" class="adminNotActive"></ons-icon>',p=s>0?"adminActiveIcon":"adminNotActive";$("#"+u).html("<td class='lockImage adminSummaryIcons'><ons-icon icon='fa-trophy' class='"+p+"'></ons-icon>"+m+"</td><td>"+c+"</td><td class='bold'>"+t+"</td><td>"+a+"</td><td>"+n+"</td><td>"+o+"</td><td>"+i+"</td><td>"+s+"</td><td>"+d+"</td><td class='editable'>"+r+"</td>"),editableStyling(r,u)}function updateTable(e,t,a,n,o,i,s,r,c,d){var l=e,u=editableStyling(r);return'<tr id="'+l+'"class="'+(d+u.tr)+'"><td class="'+("bold lockImage"+u.td)+'">'+t+"</td><td>"+a+"</td><td>"+n+'</td><td class="hide landscapeShow">'+o+'</td><td class="hide landscapeShow">'+i+"</td><td>"+s+'</td><td class="hide landscapeShow editable">'+r+"</td></tr>"}function updateAdminTable(e,t,a,n,o,i,s,r,c,d,l,u){var m=e,p=editableStyling(r);return'<tr id="'+m+'" class="'+(l+" "+p.tr)+'"><td class="adminSummaryIcons '+("lockImage"+p.td)+'"><ons-icon icon="fa-trophy" class="'+(s>0?"adminActiveIcon":"adminNotActive")+'"></ons-icon>'+("object"==typeof u?'<ons-icon icon="md-pin" class="adminActiveIcon"></ons-icon>':'<ons-icon icon="md-pin-off" class="adminNotActive"></ons-icon>')+'</td><td class="">'+c+'</td><td class="bold">'+t+"</td><td>"+a+"</td><td>"+n+"</td><td>"+o+"</td><td>"+i+"</td><td>"+s+"</td><td>"+d+'</td><td class="editable">'+r+"</td></tr>"}function tableUpdateFunction(e,t,a){var n=new Date(e.timeIn),o=addZero(n.getHours())+":"+addZero(n.getMinutes()),i=new Date(e.timeOut),s=addZero(i.getHours())+":"+addZero(i.getMinutes());return tableLogId=1==t?"ad-log-":"log-",e.offRoute&&(tableLogId+="-or"),t?patrolRecordUpdate(e._id,e.offRoute,!0)?updateAdminExisting(e._id,e.patrol,o,s,e.timeWait,e.offRoute,e.totalScore,e.editable,e.base,e.username,e.geolocation):a.push(updateAdminTable(e._id,e.patrol,o,s,e.timeWait,e.offRoute,e.totalScore,e.editable,e.base,e.username,tableLogId,e.geolocation)):e.base===getBaseNumber()?patrolRecordUpdate(e._id,e.offRoute,!1)?updateExisting(e._id,e.patrol,o,s,e.timeWait,e.offRoute,e.totalScore,e.editable,"#logsTable",tableLogId):a.push(updateTable(e._id,e.patrol,o,s,e.timeWait,e.offRoute,e.totalScore,e.editable,"#logsTable",tableLogId)):void 0}function dbUpdateFromFindOrChange(e,t,a){for(var n=/_(\d)/g,o=[],i=0,s=[],r=navi.topPage.name,c=0,d=e.docs.length;c<d;c++){var l=e.docs[c];try{if(l._deleted>0){if(removePatrolRecord(l._id,t)){$("#"+l._id).remove();var u=l._id.split(n)[1];!deleteNotificationCleared||u!=base&&0!==base||(deleteNotificationCleared=!1,ons.notification.alert({title:"HQ deleted some logs",messageHTML:"For your awareness HQ have deleted logs and they will be removed from your log list",cancelable:!0}).then(function(){deleteNotificationCleared=!0}))}}else if("string"==typeof l.patrol)l.patrol.length>0&&(l.patrol!==a&&a&&void 0!==a||tableUpdateFunction(l,t,o));else if(/message/i.test(l._id))i++,"messagesPage.html"===r&&s.push(l);else if("eventDescription"===l._id){var m=l._rev.split(/\W/g)[0];ons.notification.alert({title:"Event Update",messageHTML:"<p>This event has been updated by the event organisers to version: "+m+".</p><p>Your device will update once this message closes.</p>",cancelable:!0}).then(function(){var e;if("messagesPage.html"===navi.topPage.name){var t=navi.pages.length-2;e=navi.pages[t].name}else e=navi.topPage.name;navi.resetToPage("updatePage.html",{animation:pageChangeAnimation,data:{eventInfo:l,lastPage:e}})}).catch(function(e){})}}catch(e){}}o.length>0&&(t?$("#adminLogsTable"):$("#logsTable")).prepend(o.reverse());if(i>0)if("messagesPage.html"===r){var p={include_docs:!0,endkey:newestMessage,startkey:"message￰",descending:!0,limit:void 0},h=basedb;t&&(h=admindb);var g=$("#messagesPage .page__content");Promise.resolve().then(function(){return addMessages(h,$("#messageWindow"),g,p,!1,!1)}).then(function(){if($("#scrollToBottomFab").prop("visible")){var e=(parseInt($("#scrollMessageBadge").html())||0)+i,t=" new message";e>1&&(t+="s"),$("#scrollMessageBadge").html(e+t).removeClass("hide")}else scrollToElement(g,g[0].scrollHeight,1);nextSeq=dbSeqNumber+=i,localStorage.dbSeqNumber=dbSeqNumber}).catch(function(e){})}else{updateMsgBadgeNo((parseInt($("#messageBadge").html())||0)+i),nextSeq+=i}orientationLandscapeUpdate()}function clearQuickAddInputs(){$(".quickAddInput").val(""),$("#wait").val("0"),$("#offRoute").prop("checked",!1),$("#total").prop("disabled",!1)}function editLog(e){for(var t=0,a=e.length;t<a;t++){var n=e[t];basedb.get(n).then(function(e){switch(e.editable){case!1:ons.notification.alert({message:"This record has been locked by the event admins and cannot be edited.",cancelable:!0});break;case!0:var t=new Date(e.timeIn),a=new Date(e.timeOut);switch($("#patrolNo").val(e.patrol),$("#timeIn").val(addZero(t.getHours())+":"+addZero(t.getMinutes())),$("#timeOut").val(addZero(a.getHours())+":"+addZero(a.getMinutes())),$("#wait").val(e.timeWait),$("#total").val(e.totalScore),e.offRoute){case!0:$("#offRoute").prop("checked",!0);break;case!1:$("#offRoute").prop("checked",!1)}scrollToElement($("#page1 .page__content"),0,400)}})}}function deleteRecords(e){for(var t=e.length,a=(new Date).toISOString(),n=0,o=t;n<o;n++){var i=e[n];attemptCount=0,writeUntilWrittenDelete(i,a),$("#"+i).remove()}var s=t>1?"logs":"log";ons.notification.alert({title:t+" "+s+" deleted",message:"You have deleted "+t+" "+s+". This has updated the "+s+" in the database to deleted and will sync up with other users now.",cancelable:!0})}function writeUntilWrittenDelete(e,t){admindb.get(e).then(function(e){return admindb.put({_id:e._id,_rev:e._rev,username:personName,timestamp:t,_deleted:!0})}).then(function(e){return!0}).catch(function(a){if(404===a.status&&admindb.put({_id:e,username:personName,timestamp:t,_deleted:!0}).then(function(){return!0}).catch(function(e){}),409===a.status)return attemptCount<5&&(attemptCount++,writeUntilWrittenDelete(e))})}function lockOrUnlockLogFromEdits(e,t){var a,n,o=e.length,i=(new Date).toISOString();switch(t){case!1:a="unlocked",n="allow";break;case!0:a="locked",n="stop"}for(var s=0,r=o;s<r;s++){var c=e[s];admindb.get(c).then(function(e){switch(t){case!0:e.editable=!1;break;case!1:e.editable=!0}switch(e.timestamp=i,tableUpdateFunction(e,!0),t){case!0:$("#"+c).addClass("lockedLog");break;case!1:$("#"+c).removeClass("lockedLog")}return admindb.put(e)}).then(function(){orientationLandscapeUpdate()}).catch(function(e){})}ons.notification.alert({title:o+" logs "+a,message:"You have set "+o+" to "+a+". This will propagate to other users to "+n+" them the ability to update the log.",cancelable:!0})}function changeAtSymbol(e){return e.replace("@",",40,")}function changeAtSymbolBack(e){return e.replace(",40,","@")}function logOutPageChange(){return navi.bringPageTop("loginPage.html",{animation:pageChangeAnimation}).then(function(e){return $("#userName").val(personName),$(".adminCleanAll").remove(),deleteIndexes(),e}).catch(function(e){})}function deleteIndexes(){return offRouteIndex=[],offRouteIndexAdmin=[],patrolRecord=[],patrolRecordAdmin=[],!0}function closeDatabases(){basedbConnected&&!syncBasedb.canceled&&(syncBasedb.cancel(),basedbConnected=!1,baseSyncInProgress=!1),admindbConnected&&!adminSync.canceled&&(adminSync.cancel(),admindbConnected=!1,adminSyncInProgress=!1),void 0==evtUpdateCheck||evtUpdateCheck.canceled||evtUpdateCheck.cancel(),deleteIndexes(),closeMaps()}function openMenu(){menu.open(),menu.classList.add("menuShadow")}function closeMenu(){return menu.close()}function baseLogOut(){return Promise.resolve().then(function(){return closeMenu()}).then(function(){var e;navi.topPage.data.firstPage?(e={animation:pageChangeAnimation,data:{eventInfo:navi.topPage.data.eventInfo}},navi.replacePage("loginPage.html",e)):(e={animation:pageChangeAnimation},navi.popPage(e)),closeDatabases(),logOutPageChange(),menuController()}).catch(function(e){})}function goToTermsOfUse(){return navi.bringPageTop("./terms",{animation:pageChangeAnimation})}function closeMaps(){Object.keys(maps).forEach(function(e){maps[e].off(),maps[e].remove()}),maps={}}function signOut(){return Promise.resolve().then(function(){return closeMenu()}).then(function(){return baseNames=[],baseCodes=[],closeDatabases(),basedb=void 0,admindb=void 0,remotedb=void 0,remotedbConnected=!1,localStorage.lastDb="false",localStorage.verified="false",localStorage.evtOrganiser="false",localStorage.customerId="false",navi.resetToPage("signInPage.html",{animation:pageChangeAnimation})}).then(function(){return menuController()}).catch(function(e){})}function goToEventSummary(){var e=navi.topPage.data;return Promise.resolve().then(function(){return closeMenu()}).then(function(){return navi.bringPageTop("eventSummaryPage.html",{animation:pageChangeAnimation,data:e})}).catch(function(e){})}function changeEvent(){return Promise.resolve().then(function(){return closeMenu()}).then(function(){baseNames=[],baseCodes=[],closeDatabases(),basedb=void 0,admindb=void 0,remotedb=void 0,remotedbConnected=!1,localStorage.lastDb="false";var e={animation:pageChangeAnimation};return navi.resetToPage("eventSelectionPage.html",e)}).catch(function(e){})}function editEvent(){return Promise.resolve().then(function(){return closeMenu()}).then(function(){closeDatabases();var e={animation:pageChangeAnimation,data:{edit:!0,eventInfo:navi.topPage.data.eventInfo}};return navi.bringPageTop("createEventPage.html",e)}).catch(function(e){})}function activateEvent(){Promise.resolve().then(editEvent()).then(function(){var e=addPluralS(navi.topPage.data.eventInfo.pRef).toLowerCase();ons.notification.alert({title:"Activate Event",messageHTML:"<p>Before activating please ensure your event settings are correct.</p><p>When ready, press done in the top right to continue to the checkout. The event will activate after purchase.</p><p>These settings can be changed after activation and more "+e+' can be purchased by visiting the menu and selecting "Edit Event Set-up".</p>'})})}function showMap(){var e=document.getElementById("adminTabbar").getActiveTabIndex();Promise.resolve().then(function(){return closeMenu()}).then(function(){var t="tab"+e,a=t+"Map";return $("#"+(t+"Container")).addClass("col-md-8 col-lg-6 mapShow"),$("#"+a).addClass("adminMapContainer col-md-4 col-lg-6").removeClass("hide"),createMap(a)}).then(function(){$("#showMap").addClass("hide"),$("#hideMap").removeClass("hide"),adminShowMap=!0}).then(function(){return appdb.get("login_"+username).then(function(e){return e.adminShowMap=!0,e.timestamp=(new Date).toISOString(),appdb.put(e)})}).catch(function(e){})}function hideMap(){Promise.resolve().then(function(){return closeMenu()}).then(function(){closeMaps(),adminShowMap=!1}).then(function(){$("#hideMap").addClass("hide"),$("#showMap").removeClass("hide");var e="tab"+document.getElementById("adminTabbar").getActiveTabIndex(),t=e+"Map";$("#"+(e+"Container")).removeClass("col-md-8 col-lg-6 mapShow"),$("#"+t).removeClass("adminMapContainer col-md-4 col-lg-6").addClass("hide")}).then(function(){return appdb.get("login_"+username).then(function(e){return e.adminShowMap=!1,e.timestamp=(new Date).toISOString(),appdb.put(e)})}).catch(function(e){})}function getBaseNumber(){return base}function apiAjax(e,t){return{async:!0,crossDomain:!0,url:e,method:"POST",dataType:"json",xhrFields:{withCredentials:!1},headers:{"content-type":"application/x-www-form-urlencoded"},data:t}}function baseSelectValue(e){return document.getElementById("baseSelectDialog").hide(),$("#baseCode").val(e).text("Selected base: "+baseNames[e])}function loginAndRunFunction(e,t){var a;switch(a=void 0!=t?{animation:pageChangeAnimation,data:t}:{animation:pageChangeAnimation},e){case"logOut":logOutPageChange();break;case-1:alert("incorrect login information saved, please log in again"),navi.bringPageTop("loginPage.html",a);break;case 0:navi.bringPageTop("admin.html",a);break;default:navi.bringPageTop("page1.html",a)}}function addAppdbLoginDb(e){return appdb.get("login_"+username).then(function(t){return void 0===t.db?t.db=[e]:-1===t.db.indexOf(e)&&t.db.push(e),t.currentDb=e,t.timestamp=(new Date).toISOString(),appdb.put(t)}).catch(function(t){if(404===t.status)return appdb.put({_id:"login_"+username,db:[e],currentDb:e,timestamp:(new Date).toISOString()});throw t.message="issue saving event to device",t})}function compareTwoArrays(e,t,a){if(a)return $(e).not(t).get();if(e.length!==t.length)return!1;for(var n=0,o=e.length;n<o;n++)if(e[n]!==t[n])return!1;return!0}function onOffline(){$(".logTable").before('<div class="offlineMessage"><ons-icon icon="md-refresh-sync-alert"></ons-icon> Offline - sync to HQ will resume when online<div>')}function onOnline(){$(".offlineMessage").remove()}function downscaleImg(e,t,a){var n=imgStats(e);if(n.width<t&&n.height<a)return!1;var o=a/n.height*n.width;return o<t?t=o:a=t/n.width*n.height,{width:Math.floor(t),height:Math.floor(a)}}function imgStats(e){try{var t=e.naturalHeight,a=e.naturalWidth,n=a/t,o=!0}catch(e){}return t>a&&(o=!1),{height:t,width:a,ratio:n,landscape:o}}function stepped_scale(e,t,a){return void 0===a&&(a=.5),Promise.resolve().then(function(){var n=document.createElement("canvas"),o=n.getContext("2d"),i=document.createElement("canvas"),s=i.getContext("2d");if(n.width=t,n.height=n.width*e.naturalHeight/e.naturalWidth,e.width*a>t){var r=1/a,c={width:Math.floor(e.width*a),height:Math.floor(e.height*a)};for(i.width=c.width,i.height=c.height,s.drawImage(e,0,0,c.width,c.height);c.width*a>t;)c={width:Math.floor(c.width*a),height:Math.floor(c.height*a)},s.drawImage(i,0,0,c.width*r,c.height*r,0,0,c.width,c.height);o.drawImage(i,0,0,c.width,c.height,0,0,n.width,n.height)}else o.drawImage(e,0,0,n.width,n.height);return n}).then(function(e){return getCanvasBlob(e)}).then(function(e){return e}).catch(function(e){})}function getCanvasBlob(e){return new Promise(function(t){return e.toBlob(function(e){return t(e)})})}function menuController(){switch(navi.topPage.name){case"page1.html":$("#baseLogOut").removeClass("hide").find("div.center").html("Leave Checkpoint"),$("#goToMap, #eventSignOut").removeClass("hide"),$("#pricingPage, #showMap").addClass("hide"),menuEvtOrganiser();break;case"admin.html":$("#baseLogOut").removeClass("hide").find("div.center").html("Leave Admin Area"),menuEvtOrganiser(),$("#copyAllLogs, #goToEventSummary, #eventSignOut").removeClass("hide"),$("#pricingPage").addClass("hide"),navi.topPage.data.eventInfo.geolocationInUse&&$("#showMap").removeClass("hide");break;case"loginPage.html":menuEvtOrganiser(),$("#baseLogOut, #copyAllLogs, #pricingPage, #showMap").addClass("hide"),$("#goToMap, #eventSignOut").removeClass("hide");break;case"eventSelectionPage.html":$("#baseLogOut , #eventChanger , #eventEditor, #copyAllLogs, #pricingPage, #goToEventSummary, #showMap").addClass("hide"),$("#eventSignOut").removeClass("hide");break;case"signInPage.html":$("#eventSignOut, #baseLogOut, #eventChanger, #eventEditor, #copyAllLogs, #goToEventSummary, #showMap").addClass("hide"),$("#pricingPage").removeClass("hide");break;default:menuEvtOrganiser(),$("#baseLogOut, #copyAllLogs, #pricingPage, #showMap").addClass("hide")}lastSyncHandler(),!1===navigator.onLine&&onOffline()}function menuEvtOrganiser(){"true"===localStorage.evtOrganiser?$("#eventEditor , #eventChanger, #goToEventSummary").removeClass("hide"):$("#eventEditor , #eventChanger, #goToEventSummary").addClass("hide")}function participantReference(e,t,a){if(""===e||void 0===e)return!1;var n=$("#"+t+" .participantRef");n.each(function(t){var a=n[t].innerHTML;n[t].innerHTML=a.replace(/team/i,e)}),"page1"===t&&parseInt(a)>0&&$("#patrolNo").attr("placeholder",e+" No. (1 - "+a+")")}function copyToClipboard(e){var t=$("<input>");$("body").append(t),t.val(e.html()).select(),document.execCommand("copy"),t.remove()}function copyAllLogs(){copyToClipboard($("#allLogsCopy")),ons.notification.alert({title:"All logs table added to clipboard",messageHTML:"<p>You have just added the whole admin logs table to your clipboard.</p><p>This is in the form of an html table, paste into Microsoft Excel or HTML file to view.</p>",cancelable:!0})}function scrollToElement(e,t,a){e.animate({scrollTop:t},a)}function openMessages(){var e={animation:pageChangeAnimation,data:{currentBase:getBaseNumber(),eventInfo:navi.topPage.data.eventInfo}};navi.bringPageTop("messagesPage.html",e)}function lastSyncHandler(){void 0!==lastSync&&lastSyncUpdater(lastSync)}function lastSyncUpdater(e){lastSync=void 0===e?HHMMSSNow():e,$(".lastSync").html("last sync: "+lastSync),$(".normalTitle").addClass("hide"),$(".syncTitle").removeClass("hide")}function HHMMSSNow(){var e=new Date;return addZero(e.getHours())+":"+addZero(e.getMinutes())+":"+addZero(e.getSeconds())}function isScrolledIntoView(e){var t=e.getBoundingClientRect().top,a=e.getBoundingClientRect().bottom;return t>=0&&a<=window.innerHeight}function addZero(e){return e<10&&(e="0"+e),e}ons.ready(function(){var e=localStorage.customerId;function t(e,t){switch(t){case!0:return $("#"+e+" .progressBar").removeClass("hide"),!0;case!1:return $("#"+e+" .progressBar").addClass("hide"),!1}}function a(e,t,a){$("#"+e+" .progressBar").attr("value",t).attr("secondary-value",a).removeAttr("indeterminate")}function n(e,t,a){var n,o;a?(n=new PouchDB(e),o=new PouchDB(http+username+":"+password+"@"+couchdb+"/"+e)):(o=new PouchDB(e),n=new PouchDB(http+username+":"+password+"@"+couchdb+"/"+e));var i={doc_ids:t};return n.replicate.to(o,i).then(function(e){return e.docs_written>0}).catch(function(e){throw e})}function o(e,t){if(void 0!=t)return t;if(void 0!=e._attachments&&void 0!=e._attachments.evtLogo)return new PouchDB(e.dbName).getAttachment("eventDescription","evtLogo").then(function(e){return URL.createObjectURL(e)}).catch(function(e){})}ons.platform.isIOS()||ons.forcePlatformStyling("android"),orientationLandscapeUpdate(),ons.orientation.on("change",function(){orientationUpdates()}),$(document).on("click",".menuButton",function(){openMenu()}),$("#menu").on("postclose",function(){$("#menu").removeClass("menuShadow")}),!1===appdbConnected&&(appdb=new PouchDB(appDatabaseName,{auto_compaction:!0}),appdbConnected=!0),"true"===localStorage.previousSignIn&&"false"!=lastDb?appdb.get("login_"+username).then(function(e){base=e.base,personName=e.name,appdbConnected=!0,adminShowMap=e.adminShowMap||!1;var t=appServer+"/api/signin",a={username:username,password:password};return $.ajax(apiAjax(t,a)).then(function(t){var a=t.user.roles.sort(),o=e.db.sort();if(!1===compareTwoArrays(a,o,!1)){if(e.db=a,appdb.put(e).then(function(){return appdb.compact()}).then(function(){var e=compareTwoArrays(a,o,!0);return Promise.all(e.map(function(e){return n(e,["eventDescription"],!1)}))}).catch(function(e){}),localStorage.db=JSON.stringify(e.db),e.db.indexOf(lastDb)>-1)return e;var i={status:307,message:"last database does not match current user's databases"};throw i}return e}).catch(function(t){if(307===t.status)throw t;if(401===t.status&&"unauthorized"===t.error)throw t;return e})}).then(function(t){var a=new PouchDB(lastDb);return e=t.customerId,a.get("eventDescription").then(function(e){return e.lastBase=t.base,e}).catch(function(e){throw e})}).then(function(e){var t,a={eventInfo:e,firstPage:!0};return t="number"==typeof e.lastBase?0===e.lastBase?"admin.html":"page1.html":"loginPage.html",navi.bringPageTop(t,{animation:pageChangeAnimation,data:a})}).catch(function(e){return navi.bringPageTop("signInPage.html",{animation:pageChangeAnimation})}):navi.bringPageTop("signInPage.html",{animation:pageChangeAnimation}),window.addEventListener("offline",onOffline,!1),window.addEventListener("online",onOnline,!1);function i(e){var a=appServer+"/api/event/new",o={username:username,password:password,eventName:eventDescription.eventName,eventUsername:eventDescription.evtUsername};return $.ajax(apiAjax(a,o)).then(function(e){if(void 0!==localStorage.db){var t=JSON.parse(localStorage.db);t.push(e.dbName),localStorage.db=JSON.stringify(t)}else localStorage.db=e.dbName;localStorage.lastDb=e.dbName,localStorage.couchdb=e.url,localStorage.http=e.http,eventDescription.evtUserPass=e.evtUserPass,eventDescription.dbName=e.dbName;var a=e.http+username+":"+password+"@"+e.url+"/"+e.dbName;return remotedbURL===a||(remotedbURL=a,remotedbConnected?remotedb.close().then(function(){return remotedbConnected=!1}).catch(function(e){throw e}):remotedbConnected)}).then(function(e){return!1===e?remotedb=new PouchDB(remotedbURL):remotedb}).then(function(e){return e.get("eventDescription").then(function(t){return eventDescription._rev=t._rev,e.put(eventDescription)}).catch(function(t){if(404===t.status)return e.put(eventDescription);throw t.message="unable to upload event description to the database",t})}).then(function(){return n(eventDescription.dbName,["eventDescription"],!1)}).then(function(){return addAppdbLoginDb(eventDescription.dbName)}).then(function(t){var a={animation:pageChangeAnimation,data:{eventName:eventDescription.eventName,url:e,eventInfo:eventDescription}};return navi.resetToPage("eventSummaryPage.html",a)}).catch(function(e){return void 0===e.message&&(e.message="issue saving the event"),ons.notification.alert({title:"error",message:e.message,cancelable:!0}).then(function(){return t("createEventPage",!1)})})}function s(e,t,a){return Promise.resolve().then(function(){return!1===a?{changeMade:a}:new PouchDB(t.dbName).put(eventDescription).then(function(e){return eventDescription._rev=e.rev,n(t.dbName,["eventDescription"],!0)})}).then(function(t){var a={animation:pageChangeAnimation,data:{eventName:eventDescription.eventName,url:e,eventInfo:eventDescription}};return navi.resetToPage("eventSummaryPage.html",a)}).then(function(){return new PouchDB(http+username+":"+password+"@"+couchdb+"/"+t.dbName).compact(),closeDatabases()})}document.addEventListener("postpush",function(){var r;switch(navi.topPage.name){case"signInPage.html":"string"==typeof username&&$("#signInUserName").val(changeAtSymbolBack(username)),$(".signUpButton").hasClass("evtHandler")||$(".signUpButton").addClass("evtHandler").on("click",function(){navi.bringPageTop("signUpPage.html",{animation:pageChangeAnimation})}),$("#signInPassword").hasClass("evtHandler")||$("#signInPassword").addClass("evtHandler").on("keyup",function(e){13===e.which&&(e.preventDefault(),$(".signInButton").click())}),$(".signInButton").hasClass("evtHandler")||$(".signInButton").addClass("evtHandler").on("click",function(){t("signInPage",!0),username=changeAtSymbol($("#signInUserName").val().trim()),password=$("#signInPassword").val().trim();var a=appServer+"/api/signin",o={username:username,password:password};$.ajax(apiAjax(a,o)).then(function(t){if(200===t.status){"undefined"!=typeof localStorage&&(localStorage.couchdb=t.couchdb,localStorage.http=t.http,localStorage.username=username,localStorage.password=password,localStorage.customerId=t.user.metadata.customerId,localStorage.db=JSON.stringify(t.user.roles),localStorage.previousSignIn=!0,void 0!==t.user.metadata&&(localStorage.evtOrganiser=t.user.metadata.evtOrganiser,void 0!=t.user.metadata.verification&&(localStorage.verified=t.user.metadata.verification.verified))),e=t.user.metadata.customerId,couchdb=t.couchdb,http=t.http,ne=t.user.roles;var a=(new Date).toISOString();return appdb.get("login_"+username).then(function(n){return n.db=ne,n.timestamp=a,n.http=http,n.couchdb=couchdb,n.customerId=e,appdb.put(n).then(function(){return t}).catch(function(e){throw e})}).catch(function(n){if(404===n.status){var o={_id:"login_"+username,db:ne,timestamp:a,http:http,couchdb:couchdb,customerId:e};return appdb.put(o).then(function(e){if(e.ok)return t}).catch(function(e){})}throw n})}throw t}).then(function(e){return Promise.all(ne.map(function(e){return n(e,["eventDescription"],!1)})).then(function(t){return e.user.metadata}).catch(function(e){throw e})}).then(function(e){var a;Promise.resolve().then(function(){if(!(e.evtOrganiser&&e.verification.verified||!e.evtOrganiser))return a="verificationPage.html",!1;switch(ne.length){case 1:return a="loginPage.html",new PouchDB(ne[0]).get("eventDescription").then(function(e){return localStorage.lastDb=e.dbName,lastDb=e.dbName,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb,{eventInfo:e}}).catch(function(e){throw e});case 0:return e.evtOrganiser?(a="createEventPage.html",!1):(ons.notification.alert({title:"This event has finished",message:"The events associated with these log in details have finished",cancelable:!0}),a="signInPage.html",!1);default:if("false"==lastDb||void 0==lastDb)return a="eventSelectionPage.html",{db:ne};a="loginPage.html";var t=ne.indexOf(lastDb);if(t>-1)return new PouchDB(ne[t]).get("eventDescription").then(function(e){return lastDb=e.dbName,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb,{eventInfo:e}}).catch(function(e){throw e})}}).then(function(e){t("signInPage",!1);var n=e?{animation:pageChangeAnimation,data:e}:{animation:pageChangeAnimation};return"loginPage.html"===a||"eventSelectionPage.html"===a?navi.resetToPage(a,n):navi.bringPageTop(a,n)}).catch(function(e){throw e})}).catch(function(e){if($("#signInPage .progressBar").addClass("hide"),401===e.status)return ons.notification.alert({title:e.error,messageHTML:"<p>"+e.message+"</p><p>Be aware that both your username and password are case sensitive.</p><p>If you haven't signed up but would like to, click the big orange button below.</p>",cancelable:!0});if(404===e.status&"Event information not found on server"===e.title)return!1;switch(document.onLine){case!1:return ons.notification.alert({message:"Couldn't connect to server because this device is offline.",cancelable:!0});default:return ons.notification.alert({message:"Couldn't connect to server, please try again later.",cancelable:!0})}})}),menuController("signInPage.html");break;case"signUpPage.html":var c=!1,d=!1,l=!1,u=!1,m=!1,p=$("#signUpEmail"),h=$("#signUpPassword"),g=$("#signUpPasswordConfirm"),f=$("#signUpInputButton"),v=$("#termsOfUse");if(!p.hasClass("evtHandler")){var b="";p.addClass("evtHandler").on("blur",function(){if(document.getElementById("signUpEmail").getElementsByTagName("input")[0].checkValidity()){var e=appServer+"/api/user/checkusername",t=changeAtSymbol(p.val().trim()),a={username:t};t!=b&&""!=t&&$.ajax(apiAjax(e,a)).then(function(e){switch(e.status){case 200:d=t,l=!0;break;case 409:c||(c=!0,ons.notification.alert({title:e.message,message:e.reason,cancelable:!0}).then(function(){c=!1}));break;case 500:default:c||(c=!0,ons.notification.alert({title:"error",message:"issue validating email address is unique.",cancelable:!0}).then(function(){c=!1}))}}).catch(function(e){c||(c=!0,ons.notification.alert({title:"Issue connecting to server",messageHTML:'<p>We are very sorry there was an issue connecting to the server to validate your email address is unique.</p><p>Please try re-submitting your sign up or come back later.</p><p>If the problem persists contact:</p><p class="copyableArea"><a href="mailto:support@checkpointlive.com" class="copyableArea">support@checkpointlive.com</a></a></p>',cancelable:!0}).then(function(){c=!1}))}),b=t}else c||(c=!0,l=!1,ons.notification.alert({title:"Invalid email",messageHTML:"<p>Please enter a valid email address like:</p><p>event@checkpointlive.com</p>",cancelable:!0}).then(function(){c=!1}))})}h.hasClass("evtHandler")||h.addClass("evtHandler").on("blur",function(){var e=$(this).val().trim();e.length>=6?u!=e&&(u=e,m=e===g.val()):(u=e,c||(c=!0,ons.notification.alert({message:"A longer password is required please use a minimum of 6 characters",cancelable:!0}).then(function(){c=!1})))}),g.hasClass("evtHandler")||g.addClass("evtHandler").on("blur",function(){var e=$(this).val().trim();e===u&&""!=u?u.length>=6?m=!0:c||(c=!0,ons.notification.alert({message:"A longer password is required please use a minimum of 6 characters",cancelable:!0}).then(function(){c=!1})):""===e&&!1===u?(c=!0,ons.notification.alert({messageHTML:"Please enter a password to confirm",cancelable:!0}).then(function(){c=!1})):(m=!1,c||(c=!0,ons.notification.alert({message:"Your passwords do not match",cancelable:!0}).then(function(){c=!1})))}).on("keyup",function(e){13===e.which&&(e.preventDefault(),f.click())}),f.hasClass("evtHandler")||f.addClass("evtHandler").on("click",function(){switch(l&&m&&v.prop("checked")){case!0:var t=appServer+"/api/user/new",a={username:d,password:u,evtOrganiser:!0};$.ajax(apiAjax(t,a)).then(function(t){switch(t.status){case 200:navi.replacePage("verificationPage.html"),username=d,password=u,e=t.db.customerId,"undefined"!=typeof localStorage&&(localStorage.username=d,localStorage.password=u,localStorage.customerId=e,localStorage.verified=!1,localStorage.evtOrganiser=!0,localStorage.previousSignIn=!0);var a={_id:"login_"+username,customerId:e};appdb.put(a);break;default:throw{title:"error",message:"Something has gone wrong that isn't your fault please contact support",cancelable:!0}}}).catch(function(e){ons.notification.alert({title:e.title||"error",message:e.message||"error: "+e.toString(),cancelable:!0})});break;case!1:var n="";!1===l&&(n+="<p>Enter an email address.</p>"),!1===m&&(n+="<p>Enter and confirm your password.</p>"),!1===v.prop("checked")&&(n+="<p>Read and confirm you accept the terms of use.</p>"),ons.notification.alert({title:"Please complete the following:",messageHTML:n,cancelable:!0})}});break;case"verificationPage.html":$("#verificationCode").hasClass("evtHandler")||$("#verificationCode").addClass("evtHandler").on("keyup",function(e){13===e.which&&(e.preventDefault(),$("#verifyAccountButton").click())}),$("#verifyAccountButton").hasClass("evtHandler")||$("#verifyAccountButton").addClass("evtHandler").on("click",function(){var e=appServer+"/api/user/verify",t={username:localStorage.username,token:$("#verificationCode").val().trim()};""!=t.token&&$.ajax(apiAjax(e,t)).then(function(e){switch(e.status){case 200:navi.replacePage("createEventPage.html"),"undefined"!=typeof localStorage&&(localStorage.verified=!0);break;case 401:throw{title:"Incorrect code",message:"This code does not match your user account, please check you entered it correctly."};case 500:throw{title:"Error",message:e.message.toString()}}}).catch(function(e){ons.notification.alert({title:e.title||"Error sending verification code",message:e.message||"failed to send verification code because of: "+e.toString(),cancelable:!0})})}),$("#resendVerificationCode").hasClass("evtHandler")||$("#resendVerificationCode").addClass("evtHandler").on("click",function(){var e=appServer+"/api/user/resendverification",t={username:username};$.ajax(apiAjax(e,t)).then(function(){ons.notification.alert({title:"Email sent",message:"Your new verification code has been sent to the email address you signed up with.",cancelable:!0})}).catch(function(){ons.notification.alert({title:"Error",message:"There was an issue re-sending your verification email, please try again",cancelable:!0})})});break;case"createEventPage.html":var w,y,S=!1,C={},k=[],P=!1,I=1,T=navi.topPage.data,x=!1,D=$("#trackedEntities"),L=$("#pReference"),E=$("#createEventPage .cePRefPlural"),M=$("#createEventPage .cePRef"),O=!1,A=!1,N=0,R=function(e){var t,a,n=$(e),o=$(e).val();""!=o?k.indexOf(o)>-1?(t=!1,void 0!=C[e.id]?C[e.id]!=o&&(t=!0,a=k.indexOf(C[e.id]),k.splice(a,1),delete C[e.id]):t=!0,t&&ons.notification.alert({title:"Password Error",message:"The admin and base passwords must be unique.",cancelable:!0}).then(function(){n.val("")})):void 0!=C[e.id]?C[e.id]!=o&&(a=k.indexOf(C[e.id]),k.splice(a,1),C[e.id]=o,k.push(o)):(k.push(o),C[e.id]=o):void 0!=C[e.id]&&C[e.id]!=o&&(a=k.indexOf(C[e.id]),k.splice(a,1),delete C[e.id])},B=function(e){var t='<div class="baseSetUp"><p class="txtLeft bold marginTop">Checkpoint '+e+'</p><ons-input id="base'+e+'Name" modifier="underbar" placeholder="Checkpoint name or location" float type="text" class="fullWidthInput"></ons-input><div class="flex flexRow flexSpaceBetween marginTop"><div class="caption"><span class="bold">Maximum score available</span><br/><span class="marginLeft">(blank = no score input)</span></div><ons-input id="base'+e+'MaxScore" modifier="underbar" placeholder="Max score" float type="number" class="baseMaxScore" required></ons-input></div><div class="flex flexRow flexSpaceBetween marginTop basePasswordShowHide"><div class="caption bold">Checkpoint password *</div><ons-input id="base'+e+'Password" modifier="underbar" placeholder="Password" float type="text" class="basePassword eventPassword" required></ons-input></div><div class="flex flexRow flexSpaceBetween marginTop"><div class="caption bold">Record location with logs</div><div class="geolocationSwitch"><ons-switch id="base'+e+'GeolocationSwitch"></ons-switch></div></div><textarea class="textarea marginTop" id="base'+e+'Instructions" placeholder="Checkpoint specific instructions" style="width: 100%; height:45px;"></textarea></div>';return $(".addBaseButton").before(t)},H=function(e,t,a){return e.prop(t,a)},_=function(){var e=$("#trackingUrl").val().trim();eventDescription={_id:"eventDescription",eventName:$("#eventName").val().trim(),dateStart:$("#eventStartDate").val(),dateEnd:$("#eventEndDate").val(),pRef:L.val().trim()||"Team",eventDescription:$("#eventDescription").val().trim(),passwordProtectLogs:$("#passwordSwitch").prop("checked"),logOffRoute:$("#offRouteLogsSwitch").prop("checked"),autoTime:$("#autoTimeSwitch").prop("checked"),tracking:$("#trackingSwitch").prop("checked")&&""!==e,trackingUrl:e,adminPassword:$("#adminPassword").val(),evtUsername:$("#evtUsername").val(),bases:[{baseNo:0,baseName:"admin HQ",basePassword:$("#adminPassword").val().trim()}]};var t=parseInt(D.val());eventDescription.trackedEntities=t;var a=0;"object"==typeof r&&(a=parseInt(r.paidTrackedEntities)||0,eventDescription.paidTrackedEntities=a),a<t&&(N=t-a)},U=function(e,a,n){for(var o=1,i=e+1;o<i;o++){var s={baseNo:o,baseMaxScore:$("#base"+o+"MaxScore").val(),basePassword:$("#base"+o+"Password").val().trim(),baseGeolocation:$("#base"+o+"GeolocationSwitch").prop("checked"),baseInstructions:$("#base"+o+"Instructions").val().trim()},c=$("#base"+o+"Name").val().trim();if(""!==c&&void 0!==c||(c=o),s.baseName=c,w=!1,(s.baseGeolocation||O)&&(O=!0,n.geolocationInUse=!0),a&&""===s.basePassword)return ons.notification.alert({title:"Missing Password",message:"Check each base has a password and that the admin password is set, else if passwords are not required turn off the 'Password protect base logs' switch.",cancelable:!0}).then(function(){return t("createEventPage",!1),!1});n.bases.push(s),w=!0}return O&&(A="object"!=typeof T.eventInfo||void 0===r.geolocationPaid||!0!==r.geolocationPaid),w};if(!0===T.edit&&"object"==typeof T.eventInfo){P=!0;var q,F=/\W/g;q="string"==typeof(r=T.eventInfo)._rev?parseInt(r._rev.split(F)[0])+1:2;var j=addPluralS(r.pRef);$("#createEventPage .center").html("Edit Event - version: "+q),$("#eventName").val(r.eventName),$("#eventStartDate").val(r.dateStart),$("#eventEndDate").val(r.dateEnd),$("#eventDescription").val(r.eventDescription),L.val(r.pRef),M.html(r.pRef),E.html(j),D.val(r.trackedEntities),D.attr("placeholder","Number of "+j),$("#passwordSwitch").prop("checked",r.passwordProtectLogs),$("#offRouteLogsSwitch").prop("checked",r.logOffRoute),$("#autoTimeSwitch").prop("checked",r.autoTime),$("#trackingSwitch").prop("checked",r.tracking),$("#trackingUrl").val(r.trackingUrl).prop("disabled",!r.tracking),$("#adminPassword").val(r.adminPassword),$("#evtUsername").val(r.evtUsername).prop("disabled",!0),r.bases.forEach(function(e){var t=e.basePassword,a="base"+e.baseNo,n=e.baseNo;""!=t&&k.push(t),n>0?(n>1&&(B(n),I=n),""!=t&&(C[a+"Password"]=t,$("#"+a+"Password").val(t)),$("#"+a+"Name").val(e.baseName),$("#"+a+"MaxScore").val(e.baseMaxScore),$("#"+a+"GeolocationSwitch").prop("checked",e.baseGeolocation),$("#"+a+"Instructions").val(e.baseInstructions)):C.adminPassword=t});var W=$("#eventBannerImage");Promise.resolve().then(function(){return o(r,y)}).then(function(e){void 0!=e?(W.hide().attr("src",e).fadeIn(1500),y=e):W.hide().fadeIn(1500)}).catch(function(e){}),hideElement(!r.passwordProtectLogs,".basePasswordShowHide")}if(!$("#eventBanner").hasClass("evtHandler")){var Z=document.querySelector("#eventBanner");$("#eventBanner").addClass("evtHandler").on("change",function(){var e=$("#eventBannerImage");Promise.resolve().then(function(){return function(e){return new Promise(function(t){x=e.files[0],t(y=URL.createObjectURL(x))})}(Z)}).then(function(t){return e.attr("src",t)}).catch(function(e){})})}L.hasClass("evtHandler")||L.addClass("evtHandler").on("change",function(){var e=L.val().trim(),t=addPluralS(e);E.html(t),D.attr("placeholder","Number of "+t),M.html(e)}),$(".passwordProtectLogs").hasClass("evtHandler")||$(".passwordProtectLogs").addClass("evtHandler").on("click",function(){var e=$("#passwordSwitch");!function(e,t,a){H(e,"checked",a),hideElement(!a,t)}(e,".basePasswordShowHide",!e.prop("checked"))}),$("#passwordSwitch").hasClass("evtHandler")||$("#passwordSwitch").addClass("evtHandler").on("change",function(){hideElement(!$("#passwordSwitch").prop("checked"),".basePasswordShowHide")}),$(".tracking").hasClass("evtHandler")||$(".tracking").addClass("evtHandler").on("click",function(){var e=$("#trackingSwitch"),t=$("#trackingUrl");H(e,"checked",!e.prop("checked")),H(t,"disabled",!t.prop("disabled"))}),$("#trackingSwitch").hasClass("evtHandler")||$("#trackingSwitch").addClass("evtHandler").on("change",function(){hideElement(!$("#trackingSwitch").prop("checked"),".trackingShowHide")}),$("#createEventForm").hasClass("evtHandlerPassword")||$("#createEventForm").addClass("evtHandlerPassword").find(".eventPassword").on("blur",function(){R(this)}),$("#offRouteLogs").hasClass("evtHandler")||($("#offRouteLogs").addClass("evtHandler"),$("#offRouteLogs .offRouteLogs").on("click",function(){switch($("#offRouteLogsSwitch").prop("checked")){case!0:$("#offRouteLogsSwitch").prop("checked",!1);break;case!1:$("#offRouteLogsSwitch").prop("checked",!0)}})),$("#automateTimeEntry").hasClass("evtHandler")||($("#automateTimeEntry").addClass("evtHandler"),$("#automateTimeEntry .autoTime").on("click",function(){switch($("#autoTimeSwitch").prop("checked")){case!0:$("#autoTimeSwitch").prop("checked",!1);break;case!1:$("#autoTimeSwitch").prop("checked",!0)}})),$("#evtUsername").hasClass("evtHandler")||$("#evtUsername").addClass("evtHandler").on("blur",function(){var e=$("#evtUsername").val().trim();if(""!=e){var t=appServer+"/api/user/checkusername",a={username:e};$.ajax(apiAjax(t,a)).then(function(e){switch(e.status){case 200:S=!0;break;case 409:ons.notification.alert({title:e.message,message:e.reason,cancelable:!0});break;case 500:default:throw"default (evtUsernameToTest)"}}).catch(function(e){ons.notification.alert({title:"error",message:"Issue checking username is unique.",cancelable:!0})})}});var G=$(".addBaseButton");G.hasClass("evtHandler")||G.addClass("evtHandler").on("click",function(){B(++I),$("#passwordSwitch").prop("checked")||$(".basePasswordShowHide").addClass("hide");var e=1570+250*I;scrollToElement($("#createEventPage .page__content"),e,1e3),$("#base"+I+"Password").on("blur",function(){R(this)})}),$("#saveEvent").hasClass("evtHandler")||$("#saveEvent").addClass("evtHandler").on("click",function(){!function(){var e;if(P){var a=new PouchDB(r.dbName);e=document.getElementById("eventBannerImage"),ons.notification.confirm({title:"Are you sure you want to update "+r.eventName+"?",message:"Your changes will update the event and be distributed to all users of the event.",cancelable:!0}).then(function(a){if(1==!a)throw{canceled:!0};return t("createEventPage",!0),0!=x&&Promise.resolve().then(function(){return downscaleImg(e,1922,240)}).then(function(t){return 0!=t&&stepped_scale(e,t.width,.5)}).then(function(e){if(0!=e)return x=e})}).then(function(e){return a.get("eventDescription")}).then(function(e){var a=!1;if(_(),eventDescription.dateStart>eventDescription.dateEnd)throw"Event set to end before it starts.";if(!U(I,eventDescription.passwordProtectLogs,eventDescription))throw"password not set";if($.each(eventDescription,function(t,n){return"bases"==t?n.forEach(function(t){if(void 0===e.bases[t.baseNo])return a=!0,!1;var n=e.bases[t.baseNo];return $.each(t,function(e,t){return t===n[e]||(a=!0,!1)})}):n===e[t]||(a=!0,!1)}),!1!==x?(eventDescription._attachments={evtLogo:{data:x,content_type:x.type}},a=!0):"object"==typeof e._attachments&&(eventDescription._attachments=e._attachments),eventDescription._rev=e._rev,eventDescription.dbName=e.dbName,eventDescription.evtUserPass=e.evtUserPass,A||N>0)return t("createEventPage",!1),navi.bringPageTop("checkoutPage.html",{animation:pageChangeAnimation,data:{newEvent:!1,geolocationTurnedOnThisUpdate:A,trackedEntitiesDifference:N,url:y,eventInfo:r,pRef:eventDescription.pRef,eventName:eventDescription.eventName,trackedEntities:eventDescription.trackedEntities,location:eventDescription.geolocationInUse,changeMade:a}});if(!a)throw{noChange:!0};return s(y,r,a)}).catch(function(e){if(t("createEventPage",!1),e.canceled)return!1;if(e.noChange)return ons.notification.alert({title:"No change found",message:"No changes have been detected from the previous event information. A new version has not been saved.",cancelable:!0}).then(function(){throw navi.popPage()});var a={title:"Input Error",message:e,cancelable:!0};ons.notification.alert(a)})}else{if(t("createEventPage",!0),_(),eventDescription.dateStart>eventDescription.dateEnd)return ons.notification.alert({title:"Check event dates",message:"Event set to end before it starts.",cancelable:!0});switch(0!=x&&(e=document.getElementById("eventBannerImage"),Promise.resolve().then(function(){return downscaleImg(e,1922,240)}).then(function(t){return 0!=t&&stepped_scale(e,t.width,.5)}).then(function(e){return 0!=e?x=e:x}).then(function(e){return eventDescription._attachments={evtLogo:{data:e,content_type:e.type}}}).catch(function(e){})),""===eventDescription.eventName||""===eventDescription.dateStart||""===eventDescription.dateEnd||""===eventDescription.adminPassword||""===eventDescription.evtUsername||""===eventDescription.trackedEntities){case!0:ons.notification.alert({title:"Missing attributes",messageHTML:"<p>An event requires the following information:</p><p>A name</p></p><p>Start and end date</p></p><p>An admin password</p><p>An event username</p><p>The number of "+eventDescription.pRef+"s</p>"}).then(function(){return t("createEventPage",!1)});break;case!1:if(S){if(U(I,eventDescription.passwordProtectLogs,eventDescription))A||N>0?(t("createEventPage",!1),navi.bringPageTop("checkoutPage.html",{animation:pageChangeAnimation,data:{newEvent:!0,geolocationTurnedOnThisUpdate:A,trackedEntitiesDifference:N,url:y,pRef:eventDescription.pRef,eventName:eventDescription.eventName,trackedEntities:eventDescription.trackedEntities,location:eventDescription.geolocationInUse,changeMade:!0}})):i(y)}else ons.notification.alert({message:"This username is already in use, please try a different username.",cancelable:!0}).then(function(){return t("createEventPage",!1)})}}}()});break;case"eventSummaryPage.html":var K=navi.topPage.data.eventName;if(y=navi.topPage.data.url,r="object"==typeof navi.topPage.data.eventInfo?navi.topPage.data.eventInfo:eventDescription,!$("#eventSummaryPage").hasClass("evtLoaded")){$("#eventSummaryPage").addClass("evtLoaded"),$("#evtSummaryTitle").html(K);var Q=new Date(r.dateStart),Y=new Date(r.dateEnd);$("#evtSummaryStartDate").append(addZero(Q.getHours())+":"+addZero(Q.getMinutes())+" on "+Q.toDateString()),$("#evtSummaryEndDate").append(addZero(Y.getHours())+":"+addZero(Y.getMinutes())+" on "+Y.toDateString()),$("#evtSummaryBaseCount").append(r.bases.length),$("#evtSummaryUsername").append(r.evtUsername),$("#evtSummaryPassword").append(r.evtUserPass),r.tracking&&$("#evtSummaryEvtDetails").append('<p id="evtSummaryBaseCount" class=""><span class="bold sentanceCase">URL to tracking server: </span><span>'+r.trackingUrl+"</span></p>"),""!==r.eventDescription&&$("#evtSummaryDescription").append(r.eventDescription.replace(/\n/g,"<br>"));var z=[];if(r.bases.forEach(function(e){var t,a="",n="",o='<div class="baseSummaryInfo"><p class="bold evtSummaryBasesTitle">Checkpoint '+e.baseNo+": "+e.baseName+"</p>",i='<div class="baseSummaryIcons">';void 0===e.baseMaxScore||""===e.baseMaxScore?t="no score available at this location":(t=e.baseMaxScore,a="baseSummaryIconActive"),i+='<ons-icon icon="fa-trophy" class="'+a+'"></ons-icon>',o+='<p><span class="bold sentanceCase">Max Score Available: </span>'+t+"</p>",(r.passwordProtectLogs||0===e.baseNo)&&(o+='<p><span class="bold sentanceCase">Passcode: </span><span class="passwordFont">'+e.basePassword+"</span></p>",n="baseSummaryIconActive"),i+='<ons-icon icon="fa-lock" class="'+n+'"></ons-icon>';var s="",c="no";e.baseGeolocation&&(c="yes",s+="baseSummaryIconActive"),o+='<p><span class="bold sentanceCase">Record location with logs: </span><span class="">'+c+"</span></p>",i+='<ons-icon icon="md-pin" class="'+s+'"></ons-icon>',"string"==typeof e.baseInstructions&&""!==e.baseInstructions&&(o+='<p><span class="bold sentanceCase">Base instructions: </span><br>'+e.baseInstructions.replace(/\n/g,"<br>")+"</p>"),o+=i+"</div></div>",z.push(o)}),$("#evtSummaryBases").append(z),Promise.resolve().then(function(){return o(r,y)}).then(function(e){void 0!=e&&($("#evtSummaryBanner").append('<img src="'+e+'" class="loginLogo marginTop" id="eventSummaryBannerImage">'),y=e)}).catch(function(e){}),$("#goToEvent").on("click",function(){lastDb=r.dbName,localStorage.lastDb=lastDb,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb;var e={animation:pageChangeAnimation,data:navi.topPage.data},t=navi.pages[0].name;return"loginPage.html"===t||"admin.html"===t?navi.popPage():navi.resetToPage("loginPage.html",e)}),"true"===localStorage.evtOrganiser){$(".evtSendEmail").on("click",function(){var e=appServer+"/api/event/email",t={username:username,password:password,db:r.dbName};return $.ajax(apiAjax(e,t)).then(function(e){return ie=200!==e.status?{title:"Error",message:"There was an issue sending you an email with the event details, please try again later.",cancelable:!0}:{title:"Email Sent",messageHTML:'<p>An email has been sent to you at the email address you use to sign in:</p><p class="secondaryColor">'+changeAtSymbolBack(username)+"</p><p>Please check your inbox it should be with you shortly.</p><p>This will contain instructions you can distribute to your users on how start using the website.</p>",cancelable:!0}}).then(function(e){return ons.notification.alert(e)})});var V=$("#eventSummaryPage .page__content"),J=document.getElementById("sendEventEmailButtonContainer"),X=document.getElementById("emailEvtDescription");V.on("scroll",function(){return isScrolledIntoView(J)?X.hide():X.show()})}else $(".evtSendEmail").addClass("hide")}break;case"loginPage.html":var ee,te,ae;if("string"==typeof personName&&"undefined"!==name&&$("#userName").val(personName),"object"==typeof navi.topPage.data.eventInfo){if(r=navi.topPage.data.eventInfo,!evtUpdateCheckConnected){evtUpdateCheckConnected=!0;var ne=new PouchDB(r.dbName),oe=new PouchDB(http+username+":"+password+"@"+couchdb+"/"+r.dbName),ie={doc_ids:["eventDescription"],live:!0,retry:!0},se=!1;evtUpdateCheck=ne.replicate.from(oe,ie).on("change",function(e){if(!se){se=!0;var t=e.docs[0]._rev.split(/\W/g)[0];ons.notification.alert({title:"Event Updated",messageHTML:"<p>This event has been updated by the event organisers to version: "+t+".</p><p>Your device will update once this message closes.</p>",cancelable:!0}).then(function(){var e={animation:pageChangeAnimation,data:{event:r.dbName,lastPage:"loginPage.html"}};navi.resetToPage("updatePage.html",e),evtUpdateCheck.cancel(),se=!1})}}).on("paused active denied error",function(e){}).on("complete",function(){evtUpdateCheckConnected=!1})}$("#loginEventDescription").html(r.eventDescription.replace(/\n/g,"<br>"));var re,ce=new Date(r.dateStart),de=new Date(r.dateEnd);if(F=/\W/g,re="string"==typeof r._rev?r._rev.split(F)[0]:1,$("#loginEventDescriptionTitle").after('<span id="evtVersion">Event version: '+re+'</span><p><span class="bold">Start</span>: '+ce.toDateString()+" at "+addZero(ce.getHours())+":"+addZero(ce.getMinutes())+'<br><span class="bold">End</span>: '+de.toDateString()+" at "+addZero(de.getHours())+":"+addZero(de.getMinutes())+"</p>"),y=navi.topPage.data.url,W=$("#loginEventLogo"),Promise.resolve().then(function(){return o(r,y)}).then(function(e){void 0!=e?(W.hide().attr("src",e).removeClass("hide").fadeIn(1500),y=e):W.hide().removeClass("hide").fadeIn(1500)}).catch(function(e){}),r.passwordProtectLogs)baseCodes=[],baseNames=[],r.bases.forEach(function(e){var t=e.basePassword;""===t&&(t=e.baseNo.toString()),baseCodes.push(t),baseNames.push(e.baseName)}),ee="Please enter both your name and your passcode provided by the event organisers.",te="Welcome to "+r.eventName+" please enter your name and passcode below:",(ae=$("#baseCode")).hasClass("evtHandler")||ae.addClass("evtHandler").on("keyup",function(e){13===e.which&&(e.preventDefault(),$(".loginButton").click())});else{if(ee="Please enter both your name and select a checkpoint.",te="Welcome to "+r.eventName+" please enter your name and select a checkpoint below:",$("#baseCodeParagraph").replaceWith('<div class="select col-xs-12 marginBottom"><select name="baseSelect" id="baseCode" class="col-xs-12"><option value="" disabled selected hidden>Select your checkpoint</option></select></div>'),!(ae=$("#baseCode")).hasClass("evtHandler")){var le=navi.topPage.data.eventInfo.bases;baseCodes=[],baseNames=[],le.forEach(function(e){var t=e.baseNo.toString(),a=e.baseName;baseCodes.push(t),baseNames.push(a),ae.append('<option value="'+t+'">'+a+"</option>")})}$("#betweenNameAndBase").html("Select your checkpoint below:"),$("#loginCodeCaption").remove()}if($("#loginWelcome").html(te),$("#loginTitle .normalTitle,#loginTitle .mainTitle").html(r.eventName),!r.paidTrackedEntities>0){var ue="<div class='activationWarning warning txtCenter col-xs-12'><hr><div class='col-xs-12'><ons-icon icon='fa-warning'></ons-icon><p>This event has not been activated by the event organisers yet. Some functionality has been restricted. Once activated all functionality will be unlocked.</p></div>";"true"===localStorage.evtOrganiser&&(ue+='<ons-button class="primaryColorButton col-xs-12 col-sm-6 col-sm-push-3 col-md-4 col-md-push-4" modifier="large" onClick="activateEvent()">Activate Event</ons-button>'),ue+='<hr class="col-xs-12"></div>',$("#loginForm").before(ue)}}else ons.notification.alert({title:"Event information missing",messageHTML:"<p>The data for this event is missing, when this message closes you will be signed out. Please sign back in, this should fix any issues.</p><p>If the problem persists please contact:</p><p>support@checkpointlive.com</p>",cancelable:!0}).then(function(){signOut()});var me=$("#loginButton"),pe=$("#baseCode"),he=$("#userName");me.hasClass("evtHandler")||me.addClass("evtHandler").on("click",function(){var e=(new Date).toISOString();return Promise.resolve().then(function(){if(""===pe.val()||""===he.val())throw{message:ee,title:"Missing inputs",cancelable:!0};var e=pe.val().toLowerCase().trim();if(personName=he.val(),!((base=baseCodes.indexOf(e))>-1))throw{message:"Please try re-entering your passcode or contact the event organisers",title:"Incorrect passcode",cancelable:!0};return base}).then(function(e){return 0!==e||r.passwordProtectLogs?e:ons.notification.prompt({title:"Enter Admin Code",messageHTML:"To enter the admin area please enter the admin code provided to you by the event organisers:",cancelable:!0,placeholder:"Enter admin code here"}).then(function(t){if(t.trim()!==r.adminPassword)throw{title:"Admin code Error",messageHTML:"<p>Please try re-entering your admin code, the code you entered was incorrect.</p><p>Admin codes are case sensitive.</p>",cancelable:!0};return e})}).then(function(){return appdb.get("login_"+username).then(function(t){return t.base=base,t.name=personName,t.currentDb=r.dbName,t.timestamp=e,appdb.put(t)}).catch(function(e){return ons.notification.alert({title:"Error saving user",message:"You have logged in but there was an error saving your user credentials, the app will require you to log in again if you close it.",cancelable:!0})})}).then(function(){loginAndRunFunction(base,{eventInfo:r}),evtUpdateCheck.cancel()}).catch(function(e){return ons.notification.alert(e)})}),menuController("loginPage.html");break;case"eventSelectionPage.html":var ge=$("#ongoingEvents"),fe=$("todaysEvents"),ve=$("#upcomingEvents"),be=$("#pastEvents"),we=JSON.parse(localStorage.db);Promise.all(we.map(function(e){return new PouchDB(e).get("eventDescription").then(function(t){var a,n=new Date,i=n.getDay(),s=n.getMonth(),r=n.getFullYear(),c=new Date(t.dateStart),d=c.getDay(),l=c.getMonth(),u=c.getFullYear(),m=new Date(t.dateEnd);a=c<n&&n<m?ge:n<c&&d===i&&l===s&&u===r?fe:n<c?ve:n>m?be:ve;var p='<div class="card shadow--2dp" id="'+e+'"><div class="cardMediaDiv"></div><div class="material-card__title">'+t.eventName+'</div><div class="material-card__actions material-card--border"><ons-button modifier="quiet" class="goToEventButton secondaryColor">Enter event</ons-button><ons-button modifier="quiet" class="goToSummary secondaryColor">Info</ons-button><ons-button modifier="quiet" ripple class="cardIconButton rotate270 evtInstructionsShow button--material button--material--flat"><i class="zmdi zmdi-chevron-left chevron"></i></ons-button></div><div class="material-card__supporting-text hide">'+t.eventDescription.replace(/\n/g,"<br>")+'</div><div class="cardTRButton"><ons-button modifier="quiet" ripple class="cardIconButton hide"><i class="zmdi zmdi-share"></i></ons-button></div></div><br>';a.append(p),a.find(".eventTitle").removeClass("hide");var h=$("#"+e);h.data("eventInfo",t),$("#"+e+" .goToEventButton").on("click",function(){var e=h.data("eventInfo");lastDb=e.dbName,localStorage.lastDb=lastDb,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb;var t={animation:pageChangeAnimation,data:{eventInfo:e}};navi.resetToPage("loginPage.html",t)});var g=$("#"+e+" .evtInstructionsShow");return g.on("click",function(){g.toggleClass("rotate90"),$("#"+e+" .material-card__supporting-text").slideToggle(500)}),$("#"+e+" .goToSummary").on("click",function(){var e=h.data("eventInfo"),t={animation:pageChangeAnimation,data:{eventInfo:e}};navi.bringPageTop("eventSummaryPage.html",t)}),o(t)}).then(function(t){if(void 0!=t)return $("#"+e+" .cardMediaDiv").css({"background-image":'url("'+t+'")',"background-repeat":"no-repeat","background-position":"center top","background-size":"cover",height:240,"min-height":100}),!0}).catch(function(e){})}));var ye=$("#createNewEventButton");ye.hasClass("evtHandler")||ye.addClass("evtHandler").on("click",function(){var e={animation:pageChangeAnimation,data:{edit:!1}};navi.bringPageTop("createEventPage.html",e)}),menuController("eventSelectionPage.html");break;case"page1.html":var Se=function(e,t){return Promise.resolve().then(function(){return t?getPosition().then(function(t){return e.geolocation={lat:t.coords.latitude,lon:t.coords.longitude,accuracy:t.coords.accuracy},e}):e}).catch(function(t){return e})};menuController("page1.html");var Ce=document.getElementById("fullEditFab");Ce.hide(),userCurrentlySelected=[],$("#fullEditFab").removeClass("hide");var ke=$("#logsTable");if(void 0!==navi.topPage.data.eventInfo){var $e=(r=navi.topPage.data.eventInfo).bases[getBaseNumber()];""!=$e.baseInstructions&&($("#p1TopHalf").prepend('<div id="instructions"><ons-list><ons-list-item tappable><div class="left"><span id="baseInstructionsShowHideWord">Hide checkpoint instructions</span></div><div class="right"><i id="instructionChevron" icon="md-chevron-left" class="zmdi zmdi-chevron-left secondaryColor rotate270 chevron"></i></div></ons-list-item></div>'),$("#instructions").append('<div id="baseInstructions" class="baseInstructions">'+r.bases[getBaseNumber()].baseInstructions.replace(/\n/g,"<br>")+"</div>"),$("#instructions").on("click",function(){$("#instructionChevron").toggleClass("rotate90"),$("#baseInstructions").slideToggle(500);var e=$("#baseInstructionsShowHideWord");"Hide checkpoint instructions"===e.html()?e.html("Show checkpoint instructions"):e.html("Hide checkpoint instructions")})),""===$e.baseMaxScore||void 0===$e.baseMaxScore?$("#page1TotalScore").hide():$("#total").attr("placeholder","Total score (max "+$e.baseMaxScore+")"),1==r.autoTime&&$("#p1TopHalf .page1Time").hide(),baseDatabaseName=r.dbName}if(base>0){$("#page1 .normalTitle, #page1 .mainTitle").html("ChkPt "+base+": "+r.bases[getBaseNumber()].baseName);var Pe="Add new log from checkpoint "+base;!r.paidTrackedEntities>0&&(Pe='<div class="txtCenter"><hr><span class="warning txtCenter"><ons-icon icon="fa-warning"></ons-icon> Event activation required to submit logs</span></div><hr>'+Pe),$("#quickAddTitle").html(Pe),participantReference(r.pRef,"page1",r.trackedEntities)}else"noBase"===base&&($("#page1 .normalTitle,#page1 .mainTitle").html("On the look out"),$("#quickAddTitle").html("Record the"+addPluralS(r.pRef)+" you see"),$("#tableTitle").html(addPluralS(r.pRef)+" seen"));if($("#logsTable").empty(),!1===basedbConnected&&(basedb=new PouchDB(baseDatabaseName),basedbConnected=!0),basedb.createIndex({index:{fields:["timeOut"],name:"timeOutIndex",ddoc:"timeOutIndex",type:"json"}}).then(function(e){return basedb.createIndex({index:{fields:["base","timeOut"],name:"baseTimeOutIndex",ddoc:"baseTimeOutIndex",type:"json"}})}).then(function(){return basedb.createIndex({index:{fields:["patrol"],name:"patrolIndex",ddoc:"patrolIndex",type:"json"}})}).then(function(e){return basedb.find({selector:{timeOut:{$gt:0},base:{$eq:base}},sort:["timeOut"]})}).then(function(e){return dbUpdateFromFindOrChange(e,!1)}).then(function(){return basedb.createIndex({index:{fields:["base"],name:"baseIndex",ddoc:"baseIndex",type:"json"}})}).then(function(){if(!1===remotedbConnected&&(remotedb=new PouchDB(remotedbURL),remotedbConnected=!0),!1===baseSyncInProgress){return baseSyncInProgress=!0,syncBasedb=basedb.sync(remotedb,{live:!0,retry:!0}).on("change",function(e){"pull"===e.direction&&dbUpdateFromFindOrChange(e.change,!1)}).on("paused",function(){lastSyncUpdater()}).on("error",function(e){ons.notification.alert({title:"Error",messageHTML:"<p>An error has occured with the following message</p><p>"+e.message+"</p>",cancelable:!0}),e.status}).on("complete",function(){baseSyncInProgress=!1})}}).catch(function(e){}),checkForNewMessagesOnPageLoad(basedb,dbSeqNumber),$e.baseGeolocation&&void 0===geolocation){ons.notification.alert({title:"Location",messageHTML:'<p class="">The event organiser has set this checkpoint to include a location with each log.</p><p>After closing this message a location check will be performed, select whether you would be happy to allow checkpointlive.com to use your location.</p>',cancelable:!0}).then(function(){return getPosition()}).then(function(e){var t={title:"Your current location",messageHTML:'<p class="">Thank you for accepting geolocation privaldges, your current location is shown below:</p><div><p class="txtCenter">lat: '+e.coords.latitude+'</p><p class="txtCenter">lon: '+e.coords.longitude+'</p><p class="txtCenter">Accuracy: '+e.coords.accuracy+"m</p></div>",cancelable:!0};return e.coords.accuracy>100&&(t.messageHTML+='<p class="caption ">Accuracy will improve as the GPS finds satelites.</p>'),t}).catch(function(e){return ie={title:"Location Failed",message:"If you did not accept to allow for locations, if you change your mind you can do so from your browser settings. If not then it seems your browser cannot utilise geolocation.",cancelable:!0}}).then(function(e){return"Location Failed"===e.title?(geolocation="rejected",localStorage.geolocation="rejected"):(geolocation="accepted",localStorage.geolocation="accepted"),ons.notification.alert(e)})}r.logOffRoute&&!$("#offRouteCheckbox").hasClass("evtHandler")?($("#offRouteCheckbox").addClass("evtHandler").removeClass("logOffRouteFalse"),$(".checkbox").on("click",".checkbox__input",function(){$("#offRoute.checkbox__input").is(".checkbox__input:checked")?$("#total").prop("disabled",!0):$("#total").prop("disabled",!1)})):r.logOffRoute||$("#offRouteCheckbox").addClass("logOffRouteFalse"),$("#logsTable").hasClass("evtHandler")||($("#logsTable").addClass("evtHandler"),$("#logsTable").on("click","tr",function(){var e;if($(this).hasClass("lockedLog"))ons.notification.alert({title:"No longer editable",message:"This record has been locked by HQ and cannot be edited",cancelable:!0});else if($(this).hasClass("tableSelected")){$(this).removeClass("tableSelected"),e=$(this).attr("id");var t=userCurrentlySelected.indexOf(e);t>-1&&userCurrentlySelected.splice(t,1),$("tr").hasClass("tableSelected")||Ce.hide()}else $("tr").removeClass("tableSelected"),$(this).addClass("tableSelected"),Ce.show(),userCurrentlySelected=[],e=$(this).attr("id"),userCurrentlySelected.push(e)})),$("#fullEditFab").hasClass("evtHandler")||($("#fullEditFab").addClass("evtHandler"),$("#fullEditFab").on("click",function(){editLog(userCurrentlySelected)})),$("#cancelSubmitQuick").hasClass("evtHandler")||($("#cancelSubmitQuick").addClass("evtHandler"),$("#cancelSubmitQuick").on("click",function(){ons.notification.confirm({message:"Are you sure you want to clear this entry?",cancelable:!0}).then(function(e){1==e&&clearQuickAddInputs()})}));var Ie=function(e){e.length>0&&ke.prepend(e),orientationLandscapeUpdate(),clearQuickAddInputs()};$("#submitQuick").hasClass("evtHandler")||($("#submitQuick").addClass("evtHandler"),$("#submitQuick").on("click",function(){if(!r.paidTrackedEntities>0)return ons.notification.alert({title:"Event activation required",messageHTML:"<p>This event has not been activated</p><p>To activate the event the organisers need to complete the checkout process.</p>",cancelable:!0});base=getBaseNumber();var e=$e.baseGeolocation&&"accepted"===geolocation,t=r.tracking&&e;sqPatrol=$("#patrolNo").val(),sqTimeIn=$("#timeIn").val(),sqTimeOut=$("#timeOut").val(),sqWait=$("#wait").val(),sqOffRoute=$("#offRoute").prop("checked"),sqTotalScore=$("#total").val();var a="",n=Date.now(),o=(new Date).toISOString(),i=[];if(""===sqTimeIn)sqTimeIn=new Date;else if(5==sqTimeIn.length){var s=sqTimeIn.split(":");(sqTimeIn=new Date).setHours(s[0]),sqTimeIn.setMinutes(s[1]),sqTimeIn.setSeconds(0)}if(""===sqTimeOut)sqTimeOut=new Date;else if(5==sqTimeOut.length){var c=sqTimeOut.split(":");(sqTimeOut=new Date).setHours(c[0]),sqTimeOut.setMinutes(c[1])}if(""===sqPatrol&&(a="<p>"+r.pRef+" number</p>"),sqOffRoute||""!==sqTotalScore||""===$e.baseMaxScore||(a=a+"<p>Total score for the "+r.pRef+"</p>"),""!==a)ons.notification.alert({title:"Missing fields",messageHTML:"<p>This log entry is missing the following fields:</p>"+a,cancelable:!0});else if(sqPatrol>parseInt(r.trackedEntities)||sqPatrol<1)ons.notification.alert({message:"You have entered an invalid "+r.pRef+" number.",cancelable:!0});else if(parseInt(sqTotalScore)>parseInt($e.baseMaxScore))ons.notification.alert({message:"The total score entered is greater than the maximum points available at this checkpoint.",cancelable:!0});else if(sqTimeIn>sqTimeOut)ons.notification.alert({message:"The time out must be after the time in.",cancelable:!0});else if(sqOffRoute&&""!=sqTotalScore)ons.notification.confirm({title:"Confirm off route or log score",messageHTML:"<p>You have entered a score of "+sqTotalScore+" and that the "+r.pRef+" was off route.</p><p>Select whether you wish to submit an off route log with no score or an on route log with a score of "+sqTotalScore+".</p>",cancelable:!0,buttonLabels:["Off route - no score","On route - score of "+sqTotalScore]}).then(function(e){switch(e){case 0:$("#total").val(""),$("#submitQuick").click();break;case 1:$("#offRoute").prop("checked",!1),$("#submitQuick").click()}}).catch(function(e){});else{""==sqWait&&(sqWait=0),(sqOffRoute&&""!=sqTotalScore||"noBase"===base)&&(sqTotalScore=""),r.logOffRoute||(sqOffRoute="n/a");var d={_id:sqPatrol+"_base_"+base,patrol:sqPatrol,base:base,username:personName,timeIn:sqTimeIn,timeOut:sqTimeOut,timeWait:sqWait,offRoute:"",totalScore:sqTotalScore,editable:!0,timestamp:o};switch(sqOffRoute){case!0:return d._id=sqPatrol+"_base_"+base+"_offRoute_"+n,d.offRoute=sqOffRoute,Se(d,e).then(function(e){return sendviaOsmAnd(t,r.pRef,e,r.trackingUrl)}).then(function(e){return tableUpdateFunction(e,!1,i),Ie(i),basedb.put(e)}).catch(function(e){});default:basedb.get(d._id).then(function(a){switch(a.editable){case!0:return ons.notification.confirm({title:"Update",message:"Are you sure you want to update "+r.pRef+" number "+sqPatrol,cancelable:!0}).then(function(n){if(1===n)return d._rev=a._rev,d._id=a._id,Se(d,e).then(function(e){return sendviaOsmAnd(t,r.pRef,e,r.trackingUrl)}).then(function(e){return tableUpdateFunction(e,!1,i),basedb.put(e)})}).catch(function(e){});case!1:return ons.notification.alert({message:"This record has been locked by Admin HQ and cannot be edited.",cancelable:!0})}}).catch(function(a){if(404==a.status)return Se(d,e).then(function(e){return sendviaOsmAnd(t,r.pRef,e,r.trackingUrl)}).then(function(e){return tableUpdateFunction(e,!1,i),basedb.put(e)}).catch(function(e){});409==a.status&&basedb.get(d._id).then(function(t){return d._rev=t._rev,d._id=t._id,Se(d,e)}).then(function(e){return sendviaOsmAnd(t,r.pRef,e,r.trackingUrl)}).then(function(e){return tableUpdateFunction(e,!1,i),basedb.put(e)})}).then(function(){Ie(i)})}}}));break;case"admin.html":var Te,xe,De=!1,Le=[],Ee=$("#patrolSearch"),Me=$("#adminTitleDiv"),Oe=function(e,t,a){Date.now();for(var n=[],o=0,i=e.docs.length;o<i;o++){var s=e.docs[o];if("number"!=typeof De||s.patrol===De){var r=Le.indexOf(s.patrol);if(t||!(r>-1)){var c="on route";s.offRoute&&(c="off route");var d=new Date(s.timeOut),l=addZero(d.getHours())+":"+addZero(d.getMinutes()),u='<tr id="ls-'+s.patrol+'"><td class="bold">'+s.patrol+"</td><td>"+l+"</td><td>"+s.base+"</td><td>"+c+'</td><td class="hide landscapeShow">'+s.username+"</td></tr>";r>-1?($("#lastSeenTable #ls-"+s.patrol).remove(),n=u):(Le.push(s.patrol),n.unshift(u))}}}a.append(n),orientationLandscapeUpdate()},Ae=function(e,t){admindb.find({selector:{timeOut:{$gt:0}},fields:["_id","base","patrol","timeOut","offRoute","username"],sort:[{timeOut:"desc"}]}).then(function(a){return Oe(a,t,e)}).catch(function(e){})},Ne=function(e,t){e.empty(),admindb.query("leaderboardIndex",{reduce:!0,group:!0}).then(function(e){return e.rows.sort((t="value",a=!0,o=n?function(e){return n(e[t])}:function(e){return e[t]},a=a?-1:1,function(e,t){return e=o(e),t=o(t),a*((e>t)-(t>e))}));var t,a,n,o}).then(function(e){return Re(e,t)}).then(function(t){e.append(t)}).catch(function(e){})},Re=function(e,t){var a=1,n="";return Promise.all(e.map(function(e){n===e.value&&a--;var o='<tr id="lb-'+a+'"><td class="bold">'+a+"</td><td>"+e.key+"</td><td>"+e.value+"</td></tr>";if(a++,n=e.value,!t||t===e.key||void 0===t)return o}))};if(menuController("admin.html"),void 0!=navi.topPage.data.eventInfo&&(r=navi.topPage.data.eventInfo,adminDatabaseName=r.dbName),!Ee.hasClass("evtHandler")){Ee.addClass("evtHandler");var Be=!1,He=!1;Ee.on("click",function(){if(Be)He&&($("#patrolSearchInput").removeClass("hide"),Me.addClass("adminHide"));else{Me.addClass("adminHide");var e='<ons-input id="patrolSearchInput" type="number" modifier="underbar" placeholder="'+r.pRef+' No." float class="patrolSearchInput" autofocus></ons-input>';$(this).prepend(e),Be=!0,$(document).ready(function(){$("#patrolSearchInput").focus().on("keyup blur",function(e){if(13===e.which||"blur"===e.type){var t=$(this).val();De!=t&&""!==t?(De=t,admindb.find({selector:{timeOut:{$gt:0},patrol:{$eq:De}},sort:["timeOut"]}).then(function(e){$("#adminLogsTable").empty(),patrolRecordAdmin=[],offRouteIndexAdmin=[],dbUpdateFromFindOrChange(e,!0),void 0!=Te&&(Le=[],Te.empty(),Oe(e,!0,Te)),void 0!=xe&&Ne(xe,De)})):""===t&&De!=t&&!1!==De&&"blur"===e.type?($(this).addClass("hide"),Me.removeClass("adminHide"),He=!0,admindb.find({selector:{timeOut:{$gt:0}},sort:["timeOut"]}).then(function(e){De=!1,$("#adminLogsTable").empty(),patrolRecordAdmin=[],offRouteIndexAdmin=[],dbUpdateFromFindOrChange(e,!0),void 0!=Te&&void 0!==Te&&(Te.empty(),Le=[],Ae(Te,!1)),void 0!=xe&&Ne(xe,De)})):""===t&&($(this).addClass("hide"),Me.removeClass("adminHide"),He=!0)}})})}})}document.getElementById("adminTabbar").addEventListener("postchange",function(e){switch(e.tabItem.getAttribute("page")){case"allLogsPage.html":var a=$("#allLogsPage");if(participantReference(r.pRef,"allLogsPage"),!a.hasClass("evtHandler")){a.addClass("evtHandler");var n=document.getElementById("adminSpeedDial");n.hide(),adminCurrentlySelected=[],0==admindbConnected&&(admindb=new PouchDB(adminDatabaseName),admindbConnected=!0),admindb.createIndex({index:{fields:["timeOut"],name:"timeOutIndex",ddoc:"timeOutIndex",type:"json"}}).then(function(e){return admindb.createIndex({index:{fields:["base","timeOut"],name:"baseTimeOutIndex",ddoc:"baseTimeOutIndex",type:"json"}})}).then(function(){return admindb.createIndex({index:{fields:["patrol"],name:"patrolIndex",ddoc:"patrolIndex",type:"json"}})}).then(function(){return admindb.createIndex({index:{fields:["base"],name:"baseIndex",ddoc:"baseIndex",type:"json"}})}).then(function(){return admindb.get("_design/leaderboardIndex").catch(function(){var e={_id:"_design/leaderboardIndex",views:{leaderboardIndex:{map:function(e){"string"==typeof e.patrol&&emit(e.patrol,parseInt(e.totalScore)||0)}.toString(),reduce:"_sum"}}};return admindb.put(e)})}).then(function(){return admindb.find({selector:{timeOut:{$gt:0}},sort:["timeOut"]})}).then(function(e){return dbUpdateFromFindOrChange(e,!0)}).then(function(){if(!1===remotedbConnected&&(remotedb=new PouchDB(remotedbURL),remotedbConnected=!0),!1===adminSyncInProgress){return adminSyncInProgress=!0,adminSync=admindb.sync(remotedb,{live:!0,retry:!0}).on("change",function(e){"pull"===e.direction&&dbUpdateFromFindOrChange(e.change,!0,De)}).on("paused",function(e){lastSyncUpdater()}).on("error",function(e){ons.notification.alert({title:"Error",message:"A connection error has occured please, refresh the app or web page",cancelable:!0})}).on("complete",function(){adminSyncInProgress=!1})}}).catch(function(e){});var o=function(e,t,a){return a&&(adminCurrentlySelected=[]),e.addClass("tableSelected"),n.show(),adminCurrentlySelected.push(t),s(t,a)},i=$("#tab0Map");adminShowMap&&!i.hasClass("mapLoaded")&&(showMap(),i.addClass("mapLoaded"));var s=function(e,t){if("object"!=typeof mapLayers.tab0Map)return!1;t&&mapLayers.tab0Map.clearLayers(),Promise.resolve().then(function(){return admindb.get(e)}).then(function(e){if("object"!=typeof e.geolocation)throw"no location";return addMarkerToLayer(mapLayers.tab0Map,e._id,e.geolocation.lat,e.geolocation.lon,e)}).then(function(){zoomToLayer(mapLayers.tab0Map,"tab0Map")}).catch(function(e){})};$("#adminSpeedDial").removeClass("hide"),$("#adminLogsTable").hasClass("evtHandler")||$("#adminLogsTable").addClass("evtHandler").on("click","tr",function(e){var t=$(this),a=t.attr("id");if(t.hasClass("tableSelected")){t.removeClass("tableSelected");var i=adminCurrentlySelected.indexOf(a);i>-1&&adminCurrentlySelected.splice(i,1),$("tr").hasClass("tableSelected")||n.hide(),"object"==typeof mapLayers.tab0Map&&removeLayerFrom(a,mapLayers.tab0Map)}else 1==e.shiftKey?o(t,a,!1):($("tr").removeClass("tableSelected"),o(t,a,!0))}),$("#adminDelete").hasClass("evtHandler")||($("#adminDelete").addClass("evtHandler"),$("#adminDelete").on("click",function(){var e=adminCurrentlySelected.length>1?"these "+adminCurrentlySelected.length+" logs?":"this log?";ons.notification.confirm({title:"Are you sure?",message:"Are you sure you wish to delete "+e,cancelable:!0}).then(function(e){1==e&&deleteRecords(adminCurrentlySelected)})})),$("#adminLock").hasClass("evtHandler")||$("#adminLock").addClass("evtHandler").on("click",function(){lockOrUnlockLogFromEdits(adminCurrentlySelected,!0)}),$("#adminUnlock").hasClass("evtHandler")||$("#adminUnlock").addClass("evtHandler").on("click",function(){lockOrUnlockLogFromEdits(adminCurrentlySelected,!1)}),checkForNewMessagesOnPageLoad(admindb,dbSeqNumber)}break;case"lastSeenPage.html":void 0===Te&&(Te=$("#lastSeenTable")),Te.hasClass("evtListener")||(Te.addClass("evtListener"),t("adminPage",!0),participantReference(r.pRef,"lastSeenPage"),Ae(Te,!1),t("adminPage",!1),adminSync.on("change",function(e){if(t("adminPage",!0),"string"==typeof De?e.change.docs.filter(function(e){return e.patrol===De}):e.change.docs.filter(function(e){return"string"==typeof e.patrol}),0===(e.change._deleted?1:0).length)return t("adminPage",!1);Te.empty(),Le=[],Ae(Te,!1),t("adminPage",!1)}));break;case"leaderboard.html":void 0===xe&&(xe=$("#leaderboardTable")),xe.hasClass("evtListener")||(xe.addClass("evtListener"),t("adminPage",!0),participantReference(r.pRef,"leaderboard"),Ne(xe,De),t("adminPage",!1),adminSync.on("change",function(e){if(t("adminPage",!0),"string"==typeof De?e.change.docs.filter(function(e){return e.patrol===De}):e.change.docs.filter(function(e){return"string"==typeof e.patrol}),0===(e.change._deleted?1:0).length)return t("adminPage",!1);Ne(xe,De),t("adminPage",!1)}))}});break;case"messagesPage.html":var _e=navi.topPage.data.currentBase;r=navi.topPage.data.eventInfo;var Ue=$("#messageWindow"),qe=$("#messageInput"),Fe=document.getElementById("newMessages"),je=$("#messageInputPlaceholder"),We=basedb,Ze=!0,Ge=$("#messagesPage .page__content"),Ke=!0,Qe=$("#scrollToBottomFab"),Ye=$("#scrollMessageBadge");dbSeqNumber=nextSeq,localStorage.dbSeqNumber=nextSeq;var ze=function(e){return!(!e>0)||(ons.notification.alert({title:"Messaging unavailable",messageHTML:"<p>Messaging is currently unavailable.</p><p>This functionality will become available when the event is activated by the event's organisers</p>",cancelable:!0}),!1)},Ve=function(){var e=(new Date).toISOString(),t={_id:"message-"+e,message:qe.html().trim(),from:_e,time:e,username:personName};We.put(t).then(function(e){e.ok&&(Je(),nextSeq=++dbSeqNumber,localStorage.dbSeqNumber=dbSeqNumber)}).then(function(){return addMessages(We,Ue,Ge,{include_docs:!0,endkey:newestMessage,startkey:"message￰",descending:!0,limit:void 0},!1,!0,!0)}).catch(function(e){})},Je=function(){qe.html(""),je.removeClass("hide"),Ze=!0},Xe=function(){return Ke=!1,Promise.resolve().then(function(){var e=Ge.scrollTop();return e<120?(nextMessageEndKey2=nextMessageEndKey,addMessages(We,Ue,Ge,{include_docs:!0,endkey:"message",startkey:nextMessageEndKey,descending:!0,limit:10},!0,!0,!1,e).then(function(){return Ge.scrollTop()<300&&nextMessageEndKey!==nextMessageEndKey2?Xe():Ke=nextMessageEndKey!==nextMessageEndKey2})):(Ke=!0,!0)}).catch(function(e){})};0===_e&&(We=admindb),Qe[0].hide();if(addMessages(We,Ue,Ge,{include_docs:!0,endkey:"message",startkey:"message￰",descending:!0,limit:25},!1,!0,!0),qe.on("keydown",function(e){Ze&&(je.addClass("hide"),Ze=!1),13!=e.which||e.shiftKey||e.preventDefault()}).on("keyup",function(e){if(13==e.which&&!e.shiftKey)return""!==qe.html().trim()&&ze(r.paidTrackedEntities)?Ve():Je()}),$("#sendMessage").on("click",function(){if(""!==qe.html().trim()&&ze(r.paidTrackedEntities))return Ve()}),lastSyncHandler(),Qe.on("click",function(){var e=Ge[0].scrollHeight;scrollToElement(Ge,e,1)}),updateMsgBadgeNo(0,!0),Ge.on("scroll",function(){return Ke&&nextMessageEndKey!==nextMessageEndKey2&&Xe(),isScrolledIntoView(Fe)?(Qe[0].hide(),void Ye.html(0).addClass("hide")):Qe[0].show()}),!r.paidTrackedEntities>0){$("#topDateMsgDivider").before('<div class="txtCenter marginTop"><hr><span class="warning txtCenter"><ons-icon icon="fa-warning"></ons-icon> Event activation required to send messages</span></div><hr>')}break;case"updatePage.html":var et,tt,at;et=navi.topPage.data,at={animation:pageChangeAnimation,data:{firstPage:!0}},closeDatabases(),Promise.resolve().then(function(){if(void 0===et.lastPage)throw"no last page defined";return tt=navi.topPage.data.lastPage,void 0!=et.eventInfo?at.data.eventInfo=et.eventInfo:void 0!=et.event?new PouchDB(et.event).get("eventDescription").then(function(e){at.data.eventInfo=e}).catch(function(e){throw e}):void 0}).then(function(){navi.resetToPage(tt,at)}).catch(function(e){ons.notification.alert({title:"Issue Updating",message:"There was an issue updating, please sign in again to solve the issue.",cancelable:!0}).then(function(){tt="signInPage.html",navi.resetToPage(tt,at)})});break;case"checkoutPage.html":var nt=Stripe("pk_live_4sF9oetIyHkeKkrXGkW3zitd"),ot=nt.elements(),it=$("#paymentSubmitButton"),st=ot.create("card",{style:{base:{fontSize:"16px",color:"#32325d"}}}),rt=navi.topPage.data,ct=$("#checkoutCountry"),dt=$("#country"),lt=$("#promoCode"),ut=$("#checkoutPromoCode"),mt=rt.trackedEntitiesDifference>1?rt.pRef.toLowerCase()+"s":rt.pRef.toLowerCase(),pt=0;"object"==typeof rt.eventInfo&&(pt="number"==typeof rt.eventInfo.paidTrackedEntities?rt.eventInfo.paidTrackedEntities:0),0===pt&&$("#skipPaymentButton").removeClass("hide").on("click",function(){return rt.newEvent?i(rt.url):s(rt.url,rt.eventInfo,rt.changeMade)});var ht=rt.location?"Enabled":"Disabled";$("#checkoutEventName").html(rt.eventName),$("#checkoutPRef").html(mt),$("#checkoutPRefPlural").html(rt.pRef.toLowerCase()+"s"),$("#checkoutTotalTrackedEntities").html(rt.trackedEntities),$("#checkoutGeolocationOn").html(ht),rt.location||$("#checkoutLocationPin").addClass("disabled");var gt,ft=function(e,t,a,n){var o=0,i=0,s=0,r=0,c=0,d=0,l=!1,u=rt.trackedEntitiesDifference*e,m=rt.geolocationTurnedOnThisUpdate?t:0,p=rt.storageTimeAdded?a*rt.storageTimeAdded:0,h="number"==typeof n?n:0,g=u+m+p-h;g<0?gt=0:g<.5?(gt=.5,l=!0):gt=g;var f="",v="",b=!1;if(rt.trackedEntitiesDifference>0&&(o=.5*rt.trackedEntitiesDifference,f+='<div class="row"><div class="col-xs-8" id="numberOfTrackedEntities">Tracked '+mt+':<div class="caption">'+rt.trackedEntitiesDifference+" "+mt+" x £"+.5.toFixed(2)+'</div></div><div class="col-xs-4 txtRight bold" id="trackedEntitiesCost">£'+o.toFixed(2)+"</div></div>"),rt.geolocationTurnedOnThisUpdate&&(i=5,f+='<div class="row"><div class="col-xs-8 marginTop">Enable location tracking:  <div class="caption">1 location tracking x £'+5..toFixed(2)+'</div></div><div class="col-xs-4 txtRight bold  marginTop geoLocationInUse">£'+5..toFixed(2)+"</div></div>"),rt.storageTimeAdded>0&&(s=2*rt.storageTimeAdded,f+='<div class="row"><div class="col-xs-8 marginTop">Additional data storage time:<div class="caption">'+rt.storageTimeAdded+" 12 month storage x £"+2..toFixed(2)+'</div></div><div class="col-xs-4 txtRight bold  marginTop">£'+s.toFixed(2)+"</div></div>"),f+='<div class="row"><hr></div>',v+='<div class="row">',.5>e&&rt.trackedEntitiesDifference>0){var w=(.5-e).toFixed(2);r=rt.trackedEntitiesDifference*w,b=!0,v+='<div class="col-xs-8 marginBottom ">Tracked '+mt+' discount:<div class="caption">'+rt.trackedEntitiesDifference+" "+mt+" x - £"+w+'</div></div> <div class="col-xs-4 txtRight bold marginBottom">- £'+r.toFixed(2)+"</div>"}if(5>t&&rt.geolocationTurnedOnThisUpdate&&(b=!0,v+='<div class="col-xs-8 marginBottom ">Location tracking discount:<div class="caption">1 x - £'+(d=5-t)+'</div></div> <div class="col-xs-4 txtRight bold marginBottom">- £'+d.toFixed(2)+"</div>"),2>a&&rt.storageTimeAdded>0){b=!0;var y=(2-a).toFixed(2);c=y*rt.storageTimeAdded,v+='<div class="col-xs-8 marginBottom ">Location tracking discount:<div class="caption">'+rt.storageTimeAdded+" x - £"+y+'</div></div> <div class="col-xs-4 txtRight bold marginBottom">- £'+c.toFixed(2)+"</div>"}if(n>0&&(b=!0,v+='<div class="col-xs-8 marginBottom ">Promo discount:</div><div class="col-xs-4 txtRight bold marginBottom">- £'+n.toFixed(2)+"</div>"),v+="</div>",b){var S=r+c+d+h;f+='<div class="row"><div class="col-xs-8 bold">Subtotal</div><div class="col-xs-4 txtRight bold">£'+(o+i+s).toFixed(2)+"</div></div><hr>",v+='<div class="row"><hr class="noMarginTop"><div class="col-xs-8 bold">Discount subtotal</div><div class="col-xs-4 txtRight bold">- £'+S.toFixed(2)+"</div></div><hr>"}f+=v,l&&(f+='<div class="row marginBottom"><div class="col-xs-8">Minimum payment</div><div class="col-xs-4 txtRight">£0.50</div></div>'),f+='<div class="row"><div class="col-xs-8 bold">Total</div><div class="col-xs-4 txtRight bold">£'+gt.toFixed(2)+"</div></div>",$("#orderSummary").html(f),$("#checkoutTotal").html("£"+gt.toFixed(2))};ft(.5,5,2),st.mount("#card-element"),st.addEventListener("change",function(e){var t=document.getElementById("card-errors");e.error?t.textContent=e.error.message:t.textContent=""}),it.on("click",function(){if(0===gt)return bt(rt,eventDescription);t("checkoutPage",!0),Promise.resolve().then(function(){return vt()}).then(function(t){return a("checkoutPage",25,50),nt.createToken(st).then(function(n){if(a("checkoutPage",50,75),!n.error)return t.eventName=eventDescription.eventName,wt(n.token.id,e,100*gt,t);document.getElementById("card-errors").textContent=n.error.message})}).then(function(){return t("checkoutPage",!1)}).catch(function(e){return t("checkoutPage",!1),ons.notification.alert({title:e.title||"Error",messageHTML:e.message,cancelable:!0})})});var vt=function(){var e={name:$("#checkoutName").val(),email:$("#checkoutEmail").val(),address:$("#checkoutAddress").val(),city:$("#checkoutCity").val(),county:$("#checkoutCounty").val(),postcode:$("#checkoutPostCode").val(),country:$("#checkoutCountry").val()},t=document.getElementById("checkoutEmail").getElementsByTagName("input"),a=Object.keys(e).filter(function(t){if(""===e[t])return"<p>"+t+"</p>"});if(a.length>0)throw{title:"Missing inputs",message:"<p>Please enter the following information:</p>"+a.join().replace(/,/g,"")};if(!t[0].checkValidity())throw{title:"Invalid email",message:"<p>Please enter a valid email address like:</p><p>event@checkpointlive.com</p>"};return e},bt=function(e,t){return e.newEvent?(t.paidTrackedEntities=e.trackedEntitiesDifference,i(e.url)):(t.paidTrackedEntities=e.trackedEntitiesDifference+pt,s(e.url,e.eventInfo,!0))},wt=function(e,t,a,n,o){var i={name:o,source:e,amount:a,customer:t,metadata:n};return $.ajax(apiAjax(appServer+"/api/payment",i)).then(function(e){if(200===e.status)return bt(rt,eventDescription);throw e}).then(function(){return ons.notification.alert({title:"Payment successful",message:"£"+(a/100).toFixed(2)+" has been charged to your card.",cancelable:!0})}).catch(function(e){throw"string"!=typeof e.message&&(e.message="<p>There was an issue sending your payment, you have not been charged and your changes have not been saved.</p><p>Please check you are online.</p>"),e})};ct.on("change",function(){dt.removeClass().addClass(ct.val().toLowerCase())}),lt.on("click",function(){return Promise.resolve().then(function(){var e={username:username,promo:ut.val().trim().toLowerCase()};if(""===e.promo)throw{title:"No promo code",message:"Please enter a promo code"};return $.ajax(apiAjax(appServer+"/api/promocode",e))}).then(function(e){if(200===e.status)return ft(e.trackedEntitiesPrice,e.locationPrice,e.storagePrice,e.discount);throw e}).catch(function(e){ons.notification.alert({title:e.title||"Promo invalid",message:e.message||"Promo code is not valid",cancelable:!0})})})}})});var getPosition=function(){return new Promise(function(e,t){navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0})})};function addPluralS(e){return"children"===e||"people"===e?e:"s"===e.slice(-1)?e:e+"s"}function sendviaOsmAnd(e,t,a,n){if(!e)return a;var o={trackingUrl:n,id:t+"-"+a.patrol,lat:a.geolocation.lat,lon:a.geolocation.lon,accuracy:a.geolocation.accuracy,loggedBy:a.username,checkpoint:a.base,score:a.totalScore,offRoute:a.offRoute},i=apiAjax(appServer+"api/event/tracking",o);return $.ajax(i),a}function hideElement(e,t){switch(e){case!0:$(t).addClass("hide");break;case!1:$(t).removeClass("hide")}}