var eventDescription,appdb,basedb,remotedb,admindb,syncBasedb,adminSync,evtUpdateCheck,adminCurrentlySelected,userCurrentlySelected,nextMessageEndKey,nextMessageEndKey2,newestMessage,adminDatabaseName,baseDatabaseName,lastSync,base,name,tableId,tableLogId,sqPatrol,sqTimeIn,sqTimeOut,sqWait,sqOffRoute,sqTotalScore,baseCodes=[],baseNames=[],appdbConnected=!1,basedbConnected=!1,remotedbConnected=!1,admindbConnected=!1,adminSyncInProgress=!1,baseSyncInProgress=!1,evtUpdateCheckConnected=!1,deleteNotificationCleared=!0,attemptCount=0,dbSeqNumber=parseInt(localStorage.dbSeqNumber),nextSeq=0,username=localStorage.username,password=localStorage.password,lastDb=localStorage.lastDb,couchdb=localStorage.couchdb,http=localStorage.http,db=localStorage.db,appDatabaseName="oppFounderLoginDb",remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb,appServer="https:checkpointlive.com/app",patrolRecord=[],patrolRecordAdmin=[],offRouteIndex=[],offRouteIndexAdmin=[],pageChangeAnimation="none";function onDeviceReady(){console.log("deviceready"),"android"==cordova.platformId&&StatusBar.backgroundColorByHexString("#283593")}function onPause(){console.log("devicePaused")}function onResume(){console.log("deviceResume")}function checkForMessagesSinceSeqNo(e,t){var n={since:t},a=/message/i;return e.changes(n).then(function(e){return nextSeq=e.last_seq,e.results.filter(function(e){return a.test(e.id)})})}function updateMsgBadgeNo(e,t){return console.log(e),t?$("#messageBadge").html(0).addClass("hide"):$("#messageBadge").html(e).removeClass("hide")}function checkForNewMessagesOnPageLoad(e,t){Promise.resolve().then(function(){return checkForMessagesSinceSeqNo(e,t)}).then(function(e){return!(e.length<1)&&updateMsgBadgeNo(e.length)}).catch(function(e){console.log(e)})}function addMessages(e,t,n,a,o,s,i,r){null!=a.limit&&!1!==a.limit&&a.limit++;var l=t.height();return e.allDocs(a).then(function(e){var t=e.rows;return console.log(e),formBubbleMessages(t,a.limit,o)}).then(function(e){return console.log(e),o?t.prepend(e.reverse()).height():t.append(e.reverse()).height()}).then(function(e){return s&&(i?r=n[0].scrollHeight:(r=e-l+r,console.log(l+"-(517+"+r+")")),scrollToElement(n,r,1)),e}).catch(function(e){return console.log(e),!1})}function formBubbleMessages(e,t,n){var a=!1,o=0,s=e.length,i=getBaseNumber(),r=new Date,l=new Date;return l.setDate(l.getDate()-1),Promise.all(e.map(function(e){var c=e.doc;if("string"==typeof c.message){var d=" message-text",u="bubble",g="msg",m="bubble";if(c.date=new Date(c._id.replace("message-","")),c.time=c.date.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),c.from=parseInt(c.from),c.to=parseInt(c.to),c.msgBaseNo="Base "+c.from,0===c.from&&(c.msgBaseNo="Admin HQ"),!a&&s>1)return console.log("continue "+o),n||(newestMessage=c._id),a=c,void o++;1===s&&(a=c,c.date.setDate(1)),a.from===i?u+=" message-out":u+=" message-in",a.from!==c.from?u+=" tail":g+=" msgContinued",void 0===a.from&&(a.from=1);var p='<div id="'+a._id+'" class="'+g+'"><div class="'+u+'"><div class="msgFrom color-'+a.from+'">'+a.username+" @ "+a.msgBaseNo+'</div><div class="'+d+'">'+a.message+'</div><div class="bubble-text-meta msgTimeStamp ">'+a.time+"</div></div></div>";if(a.date.toDateString()!==c.date.toDateString()&&(p=dateBubble(a.date,r,l)+p),a=c,++o!==t){if(o===t-1||s<t&&o===s&&s>1){c.from===i?(m+=" message-out",g+=" topMsg"):(m+=" message-in",g+=" topMsg"),m+=" tail",nextMessageEndKey=c._id;var h='<div id="'+c._id+'" class="'+g+'"><div class="'+m+'"><div class="msgFrom color-'+c.from+'">'+c.username+" @ "+c.msgBaseNo+'</div><div class="'+d+'">'+c.message+'</div><div class="bubble-text-meta msgTimeStamp ">'+c.time+"</div></div></div>";return document.getElementById("topDateMsgBubble").innerHTML=dateString(c.date,r,l),h+p}}else if(o===t)return console.log("limit reached"),void(nextMessageEndKey=c._id);return p}}))}function dateString(e,t,n){var a=e.toDateString();return console.log("datebubble"),a===t.toDateString()?"Today":a===n.toDateString()?"Yesterday":a}function dateBubble(e,t,n){return'<div class="msg dateMsgDivider"><div class="bubble dateBubble">'+dateString(e,t,n)+"</div></div>"}function orientationLandscapeUpdate(){ons.orientation.isLandscape()?($(".landscapeHide").addClass("hide"),$(".landscapeShow").removeClass("hide"),$(".speed__dial.fab--bottom__right").attr("direction","left")):(console.log("portrait screen orientation"),$(".speed__dial.fab--bottom__right").attr("direction","up"))}function orientationUpdates(){ons.orientation.isLandscape()?($(".landscapeHide").addClass("hide"),$(".landscapeShow").removeClass("hide"),$(".speed__dial.fab--bottom__right").attr("direction","left")):($(".landscapeShow").addClass("hide"),$(".landscapeHide").removeClass("hide"),$(".speed__dial.fab--bottom__right").attr("direction","up"))}function destroyPouchDBs(){new PouchDB(baseDatabaseName).destroy().then(function(){ons.notification.alert(baseDatabaseName+"/basedb database destroyed")}),new PouchDB(appDatabaseName).destroy().then(function(){ons.notification.alert(appDatabaseName+"/opFounderAppDb database destroyed")}),new PouchDB(adminDatabaseName).destroy().then(function(){ons.notification.alert(adminDatabaseName+"/admindb database destroyed")})}function cleanAll(){ons.notification.prompt({title:"Clean all databases",messageHTML:"<p>You are about to delete all items from the central database, this will propagate out to all other devices, are you sure you want to do this?</p><p>If yes please enter the admin passcode used to access the admin portion of the app</p>",cancelable:!0,placeholder:"Enter admin code here"}).then(function(e){e.toLowerCase()===baseCodes[0]&&(console.log("you have ended the world"),admindb.allDocs().then(function(e){for(var t=0,n=e.total_rows;t<n;t++){var a=e.rows[t];if(console.log(a.id+" "+a.value.rev),"_design".test(a.id)){var o={_id:a.id,_rev:a.value.rev,_deleted:!0};admindb.put(o,options).catch(function(e){console.warn(e)})}}}).then(function(){admindb.compact().then(function(e){console.log(e)}).catch(function(e){console.warn(e)})}))})}function patrolRecordUpdate(e,t,n){return n?t?offRouteIndexAdmin.indexOf(e)>-1?(console.log("record already exists"),!0):(offRouteIndexAdmin.push(e),!1):patrolRecordAdmin.indexOf(e)>-1?(console.log("record already exists"),!0):(patrolRecordAdmin.push(e),!1):t?offRouteIndex.indexOf(e)>-1?(console.log(e+"record already exists"),!0):(offRouteIndex.push(e),!1):patrolRecord.indexOf(e)>-1||(patrolRecord.push(e),!1)}function removePatrolRecord(e,t){switch(t){case!0:var n=patrolRecordAdmin.indexOf(e),a=offRouteIndexAdmin.indexOf(e);return n>-1?(patrolRecordAdmin.splice(n,1),!0):a>-1?(offRouteIndexAdmin.splice(a,1),!0):(console.log("record isnt in the admin array of logs"),!1);case!1:n=patrolRecord.indexOf(e),a=offRouteIndex.indexOf(e);return n>-1?(patrolRecord.splice(n,1),!0):a>-1?(offRouteIndex.splice(a,1),!0):(console.log("record isnt in the base logs"),!1)}}function editableStyling(e,t){if(void 0===t)return e?{tr:"",td:""}:{tr:" lockedLog",td:" padlockLocked"};e?($("#"+t).removeClass("lockedLog"),$("#"+t+" > .lockImage").removeClass("padlockLocked")):($("#"+t).addClass("lockedLog"),$("#"+t+" > .lockImage").addClass("padlockLocked"))}function removeExisiting(e,t){$("#"+e).remove()}function updateExisting(e,t,n,a,o,s,i,r,l,c){var d=e;$("#"+d).html("<td class='bold lockImage'>"+t+"</td><td>"+n+"</td><td>"+a+"</td><td class='hide landscapeShow'>"+o+"</td><td class='hide landscapeShow'>"+s+"</td><td>"+i+"</td><td class='hide landscapeShow editable'>"+r+"</td>"),editableStyling(r,d)}function updateAdminExisting(e,t,n,a,o,s,i,r,l,c,d,u){var g=e;$("#"+g).html("<td class='lockImage'>"+l+"</td><td class='bold'>"+t+"</td><td>"+n+"</td><td>"+a+"</td><td class='hide landscapeShow'>"+o+"</td><td class='hide landscapeShow'>"+s+"</td><td class='hide landscapeShow'>"+i+"</td><td class='hide landscapeShow'>"+c+"</td><td class='hide landscapeShow editable'>"+r+"</td>"),editableStyling(r,g)}function updateTable(e,t,n,a,o,s,i,r,l,c){var d=e,u=editableStyling(r);return'<tr id="'+d+'"class="'+(c+u.tr)+'"><td class="'+("bold lockImage"+u.td)+'">'+t+"</td><td>"+n+"</td><td>"+a+'</td><td class="hide landscapeShow">'+o+'</td><td class="hide landscapeShow">'+s+"</td><td>"+i+'</td><td class="hide landscapeShow editable">'+r+"</td></tr>"}function updateAdminTable(e,t,n,a,o,s,i,r,l,c,d,u){console.log(e);var g=e,m=editableStyling(r);return'<tr id="'+g+'" class="'+(u+m.tr)+'"><td class="'+("lockImage"+m.td)+'">'+l+'</td><td class="bold">'+t+"</td><td>"+n+"</td><td>"+a+'</td><td class="hide landscapeShow">'+o+'</td><td class="hide landscapeShow">'+s+'</td><td class="hide landscapeShow">'+i+'</td><td class="hide landscapeShow">'+c+'</td><td class="hide landscapeShow editable">'+r+"</td></tr>"}function tableUpdateFunction(e,t,n){var a=new Date(e.timeIn).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),o=new Date(e.timeOut).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return console.log(e.patrol+" "+e.base+" "+e._id),tableLogId=1==t?"ad-log-":"log-",e.offRoute&&(tableLogId+="-or"),t?patrolRecordUpdate(e._id,e.offRoute,!0)?updateAdminExisting(e._id,e.patrol,a,o,e.timeWait,e.offRoute,e.totalScore,e.editable,e.base,e.username,"#adminLogsTable",tableLogId):n.push(updateAdminTable(e._id,e.patrol,a,o,e.timeWait,e.offRoute,e.totalScore,e.editable,e.base,e.username,"#adminLogsTable",tableLogId)):e.base===getBaseNumber()?patrolRecordUpdate(e._id,e.offRoute,!1)?updateExisting(e._id,e.patrol,a,o,e.timeWait,e.offRoute,e.totalScore,e.editable,"#logsTable",tableLogId):n.push(updateTable(e._id,e.patrol,a,o,e.timeWait,e.offRoute,e.totalScore,e.editable,"#logsTable",tableLogId)):void 0}function updateTableFromAllDocs(e,t){console.log("updating from all docs on local db");for(var n=[],a=0,o=e.total_rows;a<o;a++){tableUpdateFunction(e.rows[a].doc,t,n)}if(n.length>0){if(t)var s=$("#adminLogsTable");else s=$("#logsTable");s.prepend(n.reverse())}orientationLandscapeUpdate()}function dbUpdateFromFindOrChange(e,t,n){var a=/_(\d)/g,o=[],s=0,i=[],r=navi.topPage.name;e.last_seq;console.log("updating from find query");for(var l=0,c=e.docs.length;l<c;l++){var d=e.docs[l];try{if(d._deleted>0){if(console.log(d._id+" has been set to deleted in remotedb"),removePatrolRecord(d._id,t)){$("#"+d._id).remove(),console.log(d._id+" removed");var u=d._id.split(a)[1];!deleteNotificationCleared||u!=base&&0!==base||(deleteNotificationCleared=!1,ons.notification.alert({title:"HQ deleted some logs",messageHTML:"For your awareness HQ have deleted logs and they will be removed from your log list",cancelable:!0}).then(function(e){deleteNotificationCleared=!0}))}}else if(null!=d.patrol)d.patrol.length>0&&(d.patrol!==n&&n&&void 0!==n||tableUpdateFunction(d,t,o));else if(/message/i.test(d._id))s++,"messagesPage.html"===r&&i.push(d);else if("eventDescription"===d._id){console.log("event description update");var g=d._rev.split(/\W/g)[0];ons.notification.alert({title:"Event Update",messageHTML:"<p>This event has been updated by the event organisers to version: "+g+".</p><p>Your device will update once this message closes.</p>",cancelable:!0}).then(function(){var e;if("messagesPage.html"===navi.topPage.name){var t=navi.pages.length-2;e=navi.pages[t].name}else e=navi.topPage.name;navi.resetToPage("updatePage.html",{animation:pageChangeAnimation,data:{eventInfo:d,lastPage:e}})}).catch(function(e){console.warn(e)})}}catch(e){console.log(e)}}if(o.length>0){if(t)var m=$("#adminLogsTable");else m=$("#logsTable");m.prepend(o.reverse())}if(s>0)if("messagesPage.html"===r){var p={include_docs:!0,endkey:newestMessage,startkey:"messageï¿°",descending:!0,limit:void 0},h=basedb;t&&(h=admindb);var f=$("#messagesPage .page__content");Promise.resolve().then(function(){return addMessages(h,$("#messageWindow"),f,p,!1,!1)}).then(function(){if($("#scrollToBottomFab").prop("visible")){var e=(parseInt($("#scrollMessageBadge").html())||0)+s,t=" new message";e>1&&(t+="s"),$("#scrollMessageBadge").html(e+t).removeClass("hide")}else scrollToElement(f,f[0].scrollHeight,1);nextSeq=dbSeqNumber+=s,localStorage.dbSeqNumber=dbSeqNumber}).catch(function(e){console.warn(e)})}else{updateMsgBadgeNo((parseInt($("#messageBadge").html())||0)+s),nextSeq+=s}orientationLandscapeUpdate()}function clearQuickAddInputs(){$(".quickAddInput").val(""),$("#wait").val("0"),$("#offRoute").prop("checked",!1),$("#total").prop("disabled",!1)}function editLog(e){for(var t=e.length,n=((new Date).toISOString(),0),a=t;n<a;n++){var o=e[n];basedb.get(o).then(function(e){switch(e.editable){case!1:ons.notification.alert({title:"No longer editable",message:"This record has been locked by the event admins and cannot be edited",cancelable:!0});break;case!0:var t=new Date(e.timeIn),n=new Date(e.timeOut);switch($("#patrolNo").val(e.patrol),$("#timeIn").val(t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),$("#timeOut").val(n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),$("#wait").val(e.timeWait),$("#total").val(e.totalScore),e.offRoute){case!0:console.log("should be checked"),$("#offRoute").prop("checked",!0);break;case!1:$("#offRoute").prop("checked",!1)}scrollToElement($("#page1 .page__content"),0,400)}})}}function deleteRecords(e){for(var t=e.length,n=(new Date).toISOString(),a=0,o=t;a<o;a++){var s=e[a];console.log(s),attemptCount=0,writeUntilWrittenDelete(s,n),$("#"+s).remove()}ons.notification.alert({title:t+" logs deleted",message:"You have deleted "+t+" logs. This has updated the record in the database to deleted and will sync up with other users now.",cancelable:!0})}function writeUntilWrittenDelete(e,t){admindb.get(e).then(function(e){return console.log(e),admindb.put({_id:e._id,_rev:e._rev,username:name,timestamp:t,_deleted:!0})}).then(function(e){return console.log(e),!0}).catch(function(n){if(console.warn(n),404===n.status&&admindb.put({_id:e,_rev:origRev,username:name,timestamp:t,_deleted:!0}).then(function(e){return!0}).catch(function(e){console.warn(e)}),409===n.status)return attemptCount<5?(attemptCount++,writeUntilWrittenDelete(e)):(console.warn("409 could not be written"),!1)})}function lockOrUnlockLogFromEdits(e,t){var n=e.length,a=(new Date).toISOString();switch(t){case!1:var o="unlocked",s="allow";break;case!0:o="locked",s="stop"}for(var i=0,r=n;i<r;i++){var l=e[i];admindb.get(l).then(function(e){switch(console.log(e),t){case!0:e.editable=!1;break;case!1:e.editable=!0}switch(e.timestamp=a,tableUpdateFunction(e,!0),t){case!0:$("#"+l).addClass("lockedLog");break;case!1:$("#"+l).removeClass("lockedLog")}return admindb.put(e)}).then(function(){orientationLandscapeUpdate()}).catch(function(e){console.warn(e)})}ons.notification.alert({title:n+" logs "+o,message:"You have set "+n+" to "+o+". This will propagate to other users to "+s+" them the ability to update the log.",cancelable:!0})}function checkConnection(){return navigator.connection.type}function changeAtSymbol(e){return e.replace("@",",40,")}function changeAtSymbolBack(e){return e.replace(",40,","@")}function loginPut(e){var t=(new Date).toISOString();return appdb.put({_id:e._id,_rev:e._rev,base:base,name:name,timestamp:t})}function logOutPageChange(){return navi.bringPageTop("loginPage.html",{animation:pageChangeAnimation}).then(function(e){return $("#userName").val(name),$(".adminCleanAll").remove(),deleteIndexes(),e}).catch(function(e){console.warn(e)})}function deleteIndexes(){return offRouteIndex=[],offRouteIndexAdmin=[],patrolRecord=[],patrolRecordAdmin=[],!0}function closeDatabases(){basedbConnected&&!syncBasedb.canceled&&(syncBasedb.cancel(),basedbConnected=!1,baseSyncInProgress=!1),admindbConnected&&!adminSync.canceled&&(adminSync.cancel(),admindbConnected=!1,adminSyncInProgress=!1),null==evtUpdateCheck||evtUpdateCheck.canceled||evtUpdateCheck.cancel(),deleteIndexes()}function baseLogOut(){if(navi.topPage.data.firstPage){var e={animation:pageChangeAnimation,data:{eventInfo:navi.topPage.data.eventInfo}};navi.replacePage("loginPage.html",e)}else{e={animation:pageChangeAnimation};navi.popPage(e)}return closeDatabases(),logOutPageChange(),document.getElementById("menu").toggle(),menuController(),appdb.get("login_"+username).then(function(e){var t=(new Date).toISOString();return e.base="logOut",e.timestamp=t,appdb.put(e)}).catch(function(e){throw console.warn(e),e})}function signOut(){navi.resetToPage("signInPage.html",{animation:pageChangeAnimation}),baseNames=[],baseCodes=[],document.getElementById("menu").toggle(),closeDatabases(),basedb=void 0,admindb=void 0,remotedb=void 0,remotedbConnected=!1,localStorage.lastDb="false",localStorage.verified="false",localStorage.evtOrganiser="false"}function changeEvent(){document.getElementById("menu").toggle(),baseNames=[],baseCodes=[],closeDatabases(),basedb=void 0,admindb=void 0,remotedb=void 0,remotedbConnected=!1,localStorage.lastDb="false";var e={animation:pageChangeAnimation};return navi.resetToPage("eventSelectionPage.html",e)}function editEvent(){document.getElementById("menu").toggle(),closeDatabases();var e={animation:pageChangeAnimation,data:{edit:!0,eventInfo:navi.topPage.data.eventInfo}};return navi.bringPageTop("createEventPage.html",e)}function getBaseNumber(){return base}function apiAjax(e,t){return{async:!0,crossDomain:!0,url:e,method:"POST",dataType:"json",xhrFields:{withCredentials:!1},headers:{"content-type":"application/x-www-form-urlencoded"},data:t}}function baseSelectValue(e){return document.getElementById("baseSelectDialog").hide(),$("#baseCode").val(e).text("Selected base: "+baseNames[e])}function loginAndRunFunction(e,t){if(null!=t)var n={animation:pageChangeAnimation,data:t};else n={animation:pageChangeAnimation};switch(e){case"logOut":logOutPageChange();break;case-1:alert("incorrect login information saved, please log in again"),console.log(err),navi.bringPageTop("loginPage.html",n);break;case 0:navi.bringPageTop("admin.html",n);break;default:navi.bringPageTop("page1.html",n)}}function addAppdbLoginDb(e){return console.log(e),appdb.get("login_"+username).then(function(t){return void 0===t.db?t.db=[e]:-1===t.db.indexOf(e)&&t.db.push(e),t.currentDb=e,t.timestamp=(new Date).toISOString(),appdb.put(t)}).catch(function(t){if(404===t.status)return appdb.put({_id:"login_"+username,db:[e],currentDb:e,timestamp:(new Date).toISOString()});throw console.warn(t),t.message="issue saving event to device",t})}function compareTwoArrays(e,t,n){if(n)return $(e).not(t).get();if(e.length!==t.length)return!1;for(var a=0,o=e.length;a<o;a++)if(e[a]!==t[a])return!1;return!0}function downscaleImg(e,t,n){var a=imgStats(e);if(a.width<t&&a.height<n)return console.log("img already small enough"),!1;var o=n/a.height*a.width;return o<t?(console.log("height restricted"),t=o):(console.log("width restricted"),n=t/a.width*a.height),{width:Math.floor(t),height:Math.floor(n)}}function imgStats(e){try{var t=e.naturalHeight,n=e.naturalWidth,a=n/t,o=!0}catch(e){console.log(e)}return t>n&&(o=!1),{height:t,width:n,ratio:a,landscape:o}}function stepped_scale(e,t,n){if(void 0===n)n=.5;return Promise.resolve().then(function(){var a=document.createElement("canvas"),o=a.getContext("2d"),s=document.createElement("canvas"),i=s.getContext("2d");if(a.width=t,a.height=a.width*e.naturalHeight/e.naturalWidth,e.width*n>t){var r=1/n,l={width:Math.floor(e.width*n),height:Math.floor(e.height*n)};for(s.width=l.width,s.height=l.height,i.drawImage(e,0,0,l.width,l.height);l.width*n>t;)l={width:Math.floor(l.width*n),height:Math.floor(l.height*n)},i.drawImage(s,0,0,l.width*r,l.height*r,0,0,l.width,l.height);o.drawImage(s,0,0,l.width,l.height,0,0,a.width,a.height)}else o.drawImage(e,0,0,a.width,a.height);return a}).then(function(e){return console.log("getting blob"),getCanvasBlob(e)}).then(function(e){return console.log(e),e}).catch(function(e){console.warn(e)})}function getCanvasBlob(e){return new Promise(function(t,n){return e.toBlob(function(e){return t(e)})})}function menuController(){switch(navi.topPage.name){case"page1.html":$("#baseLogOut").removeClass("hide").find("div.center").html("Leave Base"),$("#goToMap").removeClass("hide"),menuEvtOrganiser();break;case"admin.html":$("#baseLogOut").removeClass("hide").find("div.center").html("Leave Admin Area"),$("#goToMap, #copyAllLogs").removeClass("hide"),menuEvtOrganiser();break;case"loginPage.html":menuEvtOrganiser(),$("#baseLogOut, #copyAllLogs").addClass("hide"),$("#goToMap").removeClass("hide");break;case"eventSelectionPage.html":$("#baseLogOut , #eventChanger , #eventEditor, #goToMap, #copyAllLogs").addClass("hide");break;default:menuEvtOrganiser(),$("#baseLogOut , #goToMap, #copyAllLogs").addClass("hide")}lastSyncHandler(),console.log(navi.topPage.name+" menu controller run")}function menuEvtOrganiser(){"true"===localStorage.evtOrganiser?(console.log(localStorage.evtOrganiser),$("#eventEditor , #eventChanger").removeClass("hide")):$("#eventEditor , #eventChanger").addClass("hide")}function participantReference(e,t){if(""===e||void 0===e)return!1;var n=$("#"+t+" .participantRef");n.each(function(t){var a=n[t].innerHTML;n[t].innerHTML=a.replace(/team/i,e)}),"page1"===t&&$("#patrolNo").attr("placeholder",e+" No.")}function copyToClipboard(e){var t=$("<input>");$("body").append(t),t.val(e.html()).select(),document.execCommand("copy"),t.remove()}function copyAllLogs(){copyToClipboard($("#allLogsCopy")),ons.notification.alert({title:"All logs table added to clipboard",messageHTML:"<p>You have just added the whole admin logs table to your clipboard.</p><p>This is in the form of an html table, paste into Microsoft Excel or HTML file to view.</p>",cancelable:!0})}function scrollToElement(e,t,n){e.animate({scrollTop:t},n)}function openMessages(){var e={animation:pageChangeAnimation,data:{currentBase:getBaseNumber(),eventInfo:navi.topPage.data.eventInfo}};navi.bringPageTop("messagesPage.html",e)}function lastSyncHandler(){void 0!==lastSync&&lastSyncUpdater(lastSync)}function lastSyncUpdater(e){if(void 0===e){var t=new Date;lastSync=t.toLocaleTimeString()}else lastSync=e;$(".lastSync").html("last sync: "+lastSync),$(".normalTitle").addClass("hide"),$(".syncTitle").removeClass("hide")}function isScrolledIntoView(e){var t=e.getBoundingClientRect().top,n=e.getBoundingClientRect().bottom;return t>=0&&n<=window.innerHeight}document.addEventListener("deviceready",onDeviceReady,!1),document.addEventListener("pause",onPause,!1),document.addEventListener("resume",onResume,!1),ons.ready(function(){if(console.log("ons-ready function fired"),ons.platform.isIOS()||ons.forcePlatformStyling("android"),orientationLandscapeUpdate(),ons.orientation.on("change",function(){orientationUpdates()}),$(document).on("click",".menuButton",function(){document.getElementById("menu").toggle(),$("#menu").addClass("menuShadow")}),$("#menu").on("postclose",function(){console.log("menu closed"),$("#menu").removeClass("menuShadow")}),!1===appdbConnected&&(appdb=new PouchDB(appDatabaseName,{auto_compaction:!0}),appdbConnected=!0),"true"===localStorage.previousSignIn&&"false"!=lastDb?appdb.get("login_"+username).then(function(e){base=e.base,name=e.name,appdbConnected=!0;var n=appServer+"/api/signin",a={username:username,password:password};return $.ajax(apiAjax(n,a)).then(function(n){var a=n.user.roles.sort(),o=e.db.sort();if(console.log(o),console.log(a),!1===compareTwoArrays(a,o,!1)){if(e.db=a,console.log(o),appdb.put(e).then(function(e){return appdb.compact()}).then(function(e){var n=compareTwoArrays(a,o,!0);return console.log(n),Promise.all(n.map(function(e){return console.log(e),t(e,["eventDescription"],!1)}))}).catch(function(e){console.warn(e)}),localStorage.db=JSON.stringify(e.db),e.db.indexOf(lastDb)>-1)return console.log("dbs updated and last exists"),e;var s={status:307,message:"last database does not match current user's databases"};throw console.log(s.message),s}return console.log("dbs were the same"),e}).catch(function(t){if(307===t.status)throw t;if(401===t.status&&"unauthorized"===t.error)throw t;return e})}).then(function(e){return console.log(e),new PouchDB(lastDb).get("eventDescription").then(function(t){return console.log(t),t.lastBase=e.base,t}).catch(function(e){throw console.log(e),e})}).then(function(e){var t={eventInfo:e,firstPage:!0};if("number"==typeof e.lastBase)if(0===e.lastBase)var n="admin.html";else n="page1.html";else n="loginPage.html";return navi.bringPageTop(n,{animation:pageChangeAnimation,data:t})}).catch(function(e){return console.log("going to sign in screen"),console.log(e),navi.bringPageTop("signInPage.html",{animation:pageChangeAnimation})}):(console.log("no previous sign in information"),navi.bringPageTop("signInPage.html",{animation:pageChangeAnimation})),ons.platform.isWebView()){document.addEventListener("offline",function(){$(".logTable").before('<div class="offlineMessage"><ons-icon icon="md-refresh-sync-alert"></ons-icon> Offline - sync to HQ will resume when online<div>'),$(".offlineMap").html("Local Map - Offline")},!1),document.addEventListener("online",function(){$(".offlineMessage").remove(),$(".offlineMap").html("Local Map")},!1)}function e(e,t){switch(t){case!0:return $("#"+e+" .progressBar").removeClass("hide"),!0;case!1:return $("#"+e+" .progressBar").addClass("hide"),!1}}function t(e,t,n){if(n)o=new PouchDB(e),a=new PouchDB(http+username+":"+password+"@"+couchdb+"/"+e);else var a=new PouchDB(e),o=new PouchDB(http+username+":"+password+"@"+couchdb+"/"+e);var s={doc_ids:t};return o.replicate.to(a,s).then(function(t){return console.log(t),t.docs_written>0?(console.log("event Description for "+e+" updated"),!0):(console.log("event Description for "+e+" was up to date"),!1)}).catch(function(e){throw console.log("there was an error"),console.log(e),e})}function n(e,t){if(console.log(t),null!=t)return t;if(null!=e._attachments&&null!=e._attachments.evtLogo)return console.log("getting attachment"),new PouchDB(e.dbName).getAttachment("eventDescription","evtLogo").then(function(e){return console.log(e),URL.createObjectURL(e)}).catch(function(e){console.log("issue loading evtLogo image"),console.log(e)})}var a=function(e,t,n){var a=n?function(t){return n(t[e])}:function(t){return t[e]};return t=t?-1:1,function(e,n){return e=a(e),n=a(n),t*((e>n)-(n>e))}};document.addEventListener("postpush",function(o){switch(console.log("page pushed "+navi.topPage.name),console.log(navi.pages),navi.topPage.name){case"signInPage.html":null!=username&&$("#signInUserName").val(changeAtSymbolBack(username)),$(".signUpButton").hasClass("evtHandler")||$(".signUpButton").addClass("evtHandler").on("click",function(){navi.bringPageTop("signUpPage.html",{animation:pageChangeAnimation})}),$("#signInPassword").hasClass("evtHandler")||$("#signInPassword").addClass("evtHandler").on("keyup",function(e){13===e.which&&(e.preventDefault(),$(".signInButton").click())}),$(".signInButton").hasClass("evtHandler")||$(".signInButton").addClass("evtHandler").on("click",function(){e("signInPage",!0),username=changeAtSymbol($("#signInUserName").val().trim()),password=$("#signInPassword").val().trim();var n=appServer+"/api/signin",a={username:username,password:password};$.ajax(apiAjax(n,a)).then(function(e){if(console.log("sign in sent back status: "+e.status),200===e.status){console.log(e),"undefined"!=typeof localStorage&&(localStorage.couchdb=e.couchdb,localStorage.http=e.http,localStorage.username=username,localStorage.password=password,localStorage.db=JSON.stringify(e.user.roles),localStorage.previousSignIn=!0,void 0!==e.user.metadata&&(localStorage.evtOrganiser=e.user.metadata.evtOrganiser,null!=e.user.metadata.verification&&(localStorage.verified=e.user.metadata.verification.verified))),couchdb=e.couchdb,http=e.http,H=e.user.roles,console.log(H);var t=(new Date).toISOString();return appdb.get("login_"+username).then(function(n){return n.db=H,n.timestamp=t,n.http=http,n.couchdb=couchdb,appdb.put(n).then(function(t){return e}).catch(function(e){throw console.log(e),e})}).catch(function(n){if(console.log(n),404===n.status){console.log("no login doc, creating one");var a={_id:"login_"+username,db:H,timestamp:t,http:http,couchdb:couchdb};return appdb.put(a).then(function(t){if(t.ok)return e}).catch(function(e){console.log(e)})}throw n})}throw e}).then(function(e){return console.log(e),Promise.all(H.map(function(e){return t(e,["eventDescription"],!1)})).then(function(t){return console.log(t),e.user.metadata}).catch(function(e){throw e})}).then(function(e){var t;console.log("got down to here"),console.log(e),Promise.resolve().then(function(){if(!(e.evtOrganiser&&e.verification.verified||!e.evtOrganiser))return t="verificationPage.html",!1;switch(H.length){case 1:return t="loginPage.html",new PouchDB(H[0]).get("eventDescription").then(function(e){return localStorage.lastDb=e.dbName,lastDb=e.dbName,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb,{eventInfo:e}}).catch(function(e){throw console.log(e),e});case 0:return e.evtOrganiser?(t="createEventPage.html",!1):(ons.notification.alert({title:"This event has finished",message:"The events associated with these log in details have finished",cancelable:!0}),t="signInPage.html",!1);default:if("false"==lastDb||null==lastDb)return t="eventSelectionPage.html",{db:H};t="loginPage.html";var n=H.indexOf(lastDb);if(n>-1)return new PouchDB(H[n]).get("eventDescription").then(function(e){return lastDb=e.dbName,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb,{eventInfo:e}}).catch(function(e){throw console.log(e),e})}}).then(function(e){if(console.log(e),!1!==e){n={animation:pageChangeAnimation,data:e};return navi.resetToPage(t,n)}var n={animation:pageChangeAnimation};return navi.bringPageTop(t,n)}).catch(function(e){throw console.log(e),e})}).catch(function(e){if($("#signInPage .progressBar").addClass("hide"),console.log(e),401===e.status)return ons.notification.alert({title:e.error,messageHTML:"<p>"+e.message+"</p><p>Be aware that both your username and password are case sensitive.</p>",cancelable:!0});if(console.log("no response from sign in"),404===e.status&"Event information not found on server"===e.title)return!1;var t;switch(ons.platform.isWebView()&&(t=checkConnection()),console.log("current connection: "+t),t){case"none":return console.log(t),ons.notification.alert({title:"Error",message:"Couldn't connect to server because this device is offline.",cancelable:!0});default:return ons.notification.alert({title:"Error",message:"Couldn't connect to server, please try again later.",cancelable:!0})}})});break;case"signUpPage.html":var s=!1,i=!1,r=!1,l=!1,c=!1;if(!$("#signUpEmail").hasClass("evtHandler")){var d="";$("#signUpEmail").addClass("evtHandler").on("blur",function(){var e=document.getElementById("signUpEmail").getElementsByTagName("input");if($(e)[0].checkValidity()){var t=appServer+"/api/user/checkusername",n=changeAtSymbol($("#signUpEmail").val().trim()),a={username:n};n!=d&&""!=n&&$.ajax(apiAjax(t,a)).then(function(e){switch(e.status){case 200:i=n,r=!0;break;case 409:s||(s=!0,ons.notification.alert({title:e.message,message:e.reason,cancelable:!0}).then(function(){s=!1}));break;case 500:default:s||(s=!0,ons.notification.alert({title:"error",message:"issue validating email address is unique",cancelable:!0}).then(function(){s=!1}))}}).catch(function(e){console.log(e),s||(s=!0,ons.notification.alert({title:"Error connecting to server",message:"We are very sorry there was an error connecting to the server to validate your email address is unique please try submitting your sign up or come back later.",cancelable:!0}).then(function(){s=!1}))}),d=n}else s||(s=!0,r=!1,ons.notification.alert({title:"Invalid email",message:"Please enter a valid email address like: event@hikemanager.com",cancelable:!0}).then(function(){s=!1}))})}$("#signUpPassword").hasClass("evtHandler")||$("#signUpPassword").addClass("evtHandler").on("blur",function(){var e=$(this).val().trim();e.length>=6?l!=e&&(l=e,c=e===$("#signUpPasswordConfirm").val()):(l=e,s||(s=!0,ons.notification.alert({title:"Longer password required",message:"Minimum of 6 characters",cancelable:!0}).then(function(){s=!1})))}),$("#signUpPasswordConfirm").hasClass("evtHandler")||$("#signUpPasswordConfirm").addClass("evtHandler").on("blur",function(){var e=$(this).val().trim();e===l&&""!=l?l.length>=6?c=!0:s||(s=!0,ons.notification.alert({title:"Longer password required",message:"Minimum of 6 characters",cancelable:!0}).then(function(){s=!1})):""===e&&!1===l?(s=!0,ons.notification.alert({title:"Please enter a password",messageHTML:"Please enter a password to confirm",cancelable:!0}).then(function(){s=!1})):(c=!1,s||(s=!0,ons.notification.alert({title:"Password does not match",messageHTML:"Your passwords do not match",cancelable:!0}).then(function(){s=!1})))}).on("keyup",function(e){13===e.which&&(e.preventDefault(),$(".signUpInputButton").click())}),$(".signUpInputButton").hasClass("evtHandler")||$(".signUpInputButton").addClass("evtHandler").on("click",function(){switch(r&&c){case!0:var e=appServer+"/api/user/new",t={username:i,password:l,evtOrganiser:!0};$.ajax(apiAjax(e,t)).then(function(e){switch(console.log(e),e.status){case 200:navi.replacePage("verificationPage.html"),username=i,password=l,"undefined"!=typeof localStorage&&(localStorage.username=i,localStorage.password=l,localStorage.verified=!1,localStorage.evtOrganiser=!0,localStorage.previousSignIn=!0);break;default:ons.notification.alert({title:"error",message:"Something has gone wrong that isn't your fault please contact support",cancelable:!0})}}).catch(function(e){console.log(e),ons.notification.alert({title:"error",message:"error: "+e.toString(),cancelable:!0})});break;case!1:var n="<p>Please complete the following:</p>";!1===r&&(n+="<p>Enter a email</p>"),!1===c&&(n+="<p>Enter and confirm your password</p>"),ons.notification.alert({title:"Missing fields",messageHTML:n,cancelable:!0})}});break;case"verificationPage.html":$("#verificationCode").hasClass("evtHandler")||$("#verificationCode").addClass("evtHandler").on("keyup",function(e){13===e.which&&(e.preventDefault(),$("#verifyAccountButton").click())}),$("#verifyAccountButton").hasClass("evtHandler")||$("#verifyAccountButton").addClass("evtHandler").on("click",function(){var e=appServer+"/api/user/verify",t={username:localStorage.username,token:$("#verificationCode").val().trim()};""!=t.token&&$.ajax(apiAjax(e,t)).then(function(e){switch(e.status){case 200:navi.replacePage("createEventPage.html"),"undefined"!=typeof localStorage&&(localStorage.verified=!0);break;case 401:ons.notification.alert({title:"Incorrect code",message:"This code does not match your user account, please check you entered it correctly.",cancelable:!0});break;case 500:ons.notification.alert({title:"Error",message:e.err.toString(),cancelable:!0})}}).catch(function(e){console.log(e),ons.notification.alert({title:"Error sending verification code",message:"failed to send verification code because of: "+e.toString(),cancelable:!0})})}),$("#resendVerificationCode").hasClass("evtHandler")||$("#resendVerificationCode").addClass("evtHandler").on("click",function(){var e=appServer+"/api/user/resendverification",t={username:username};$.ajax(apiAjax(e,t)).then(function(e){ons.notification.alert({title:"Email sent",message:"Your new verification email has been sent",cancelable:!0})}).catch(function(e){ons.notification.alert({title:"Error",message:"There was an issue re-sending your verification email, please try again",cancelable:!0})})});break;case"createEventPage.html":var u,g=!1,m={},p=[],h=!1,f=1,v=navi.topPage.data,b=!1;function w(e){var t,n=$(e),a=$(e).val();if(""!=a)if(p.indexOf(a)>-1){if(t=!1,null!=m[e.id]){if(m[e.id]!=a){t=!0;var o=p.indexOf(m[e.id]);p.splice(o,1),delete m[e.id]}}else t=!0;t&&ons.notification.alert({title:"Password Error",message:"The admin and base passwords must be unique.",cancelable:!0}).then(function(){n.val("")})}else if(null!=m[e.id]){if(m[e.id]!=a){o=p.indexOf(m[e.id]);p.splice(o,1),m[e.id]=a,p.push(a)}}else p.push(a),m[e.id]=a;else if(null!=m[e.id]&&(console.log("6"),m[e.id]!=a)){o=p.indexOf(m[e.id]);p.splice(o,1),delete m[e.id]}console.log(p),console.log(m)};function S(e){var t='<div class="baseSetUp"><p class="txtLeft bold marginTop">Base '+e+'</p><ons-input id="base'+e+'Name" modifier="underbar" placeholder="Base name or location" float type="text" class="fullWidthInput"></ons-input><div class="flex flexRow flexSpaceBetween marginTop"><div class="caption"><span class="bold">Maximum score available</span><br/><span class="marginLeft">(blank = no score input)</span></div><ons-input id="base'+e+'MaxScore" modifier="underbar" placeholder="Max score" float type="number" class="baseMaxScore" required></ons-input></div><div class="flex flexRow flexSpaceBetween marginTop basePasswordShowHide"><div class="caption bold">Base password *</div><ons-input id="base'+e+'Password" modifier="underbar" placeholder="Password" float type="text" class="basePassword eventPassword maxWidth50per" required></ons-input></div><textarea class="textarea marginTop" id="base'+e+'Instructions" placeholder="Base specific instructions" style="width: 100%; height:45px;"></textarea></div>';return $(".addBaseButton").before(t)}function y(e){switch(e){case!0:$(".basePasswordShowHide").addClass("hide");break;case!1:$(".basePasswordShowHide").removeClass("hide")}}function C(){eventDescription={_id:"eventDescription",eventName:$("#eventName").val().trim(),dateStart:$("#eventStartDate").val(),dateEnd:$("#eventEndDate").val(),pRef:$("#pReference").val().trim(),eventDescription:$("#eventDescription").val().trim(),passwordProtectLogs:$("#passwordSwitch").prop("checked"),logOffRoute:$("#offRouteLogsSwitch").prop("checked"),autoTime:$("#autoTimeSwitch").prop("checked"),adminPassword:$("#adminPassword").val(),evtUsername:$("#evtUsername").val(),bases:[{baseNo:0,baseName:"admin HQ",basePassword:$("#adminPassword").val().trim()}]}}function P(t,n,a){for(var o=1,s=t+1;o<s;o++){var i={baseNo:o,baseMaxScore:$("#base"+o+"MaxScore").val(),basePassword:$("#base"+o+"Password").val().trim(),baseInstructions:$("#base"+o+"Instructions").val().trim()},r=$("#base"+o+"Name").val().trim();if(""!==r&&void 0!==r||(r=o),i.baseName=r,u=!1,n&&""===i.basePassword)return ons.notification.alert({title:"Missing Password",message:"Check each base has a password and that the admin password is set, else if passwords are not required turn off the 'Password protect base logs' switch.",cancelable:!0}).then(function(){return e("createEventPage",!1),!1});a.bases.push(i),u=!0}return u}if(!0===v.edit&&null!=v.eventInfo){h=!0;var I=/\W/g;q="string"==typeof(L=v.eventInfo)._rev?parseInt(L._rev.split(I)[0])+1:2,$("#createEventPage .center").html("Edit Event - version: "+q),$("#eventName").val(L.eventName),$("#eventStartDate").val(L.dateStart),$("#eventEndDate").val(L.dateEnd),$("#eventDescription").val(L.eventDescription),$("#pReference").val(L.pRef),$("#passwordSwitch").prop("checked",L.passwordProtectLogs),$("#offRouteLogsSwitch").prop("checked",L.logOffRoute),$("#autoTimeSwitch").prop("checked",L.autoTime),$("#adminPassword").val(L.adminPassword),$("#evtUsername").val(L.evtUsername).prop("disabled",!0),L.bases.forEach(function(e){var t=e.basePassword,n="base"+e.baseNo,a=e.baseNo;""!=t&&p.push(t),a>0?(a>1&&(S(a),f=a),""!=t&&(m[n+"Password"]=t,$("#"+n+"Password").val(t)),$("#"+n+"Name").val(e.baseName),$("#"+n+"MaxScore").val(e.baseMaxScore),$("#"+n+"Instructions").val(e.baseInstructions)):m.adminPassword=t}),console.log(f);var k=$("#eventBannerImage");Promise.resolve().then(function(){return n(L,E)}).then(function(e){null!=e?(k.hide().attr("src",e).fadeIn(1500),E=e):k.hide().fadeIn(1500)}).catch(function(e){console.log(e)}),y(!L.passwordProtectLogs)}if(!$("#eventBanner").hasClass("evtHandler")){var D=document.querySelector("#eventBanner");$("#eventBanner").addClass("evtHandler").on("change",function(){var e=$("#eventBannerImage");Promise.resolve().then(function(){return console.log("file upload"),e=D,new Promise(function(t,n){b=e.files[0],E=URL.createObjectURL(b),console.log(E),t(E)});var e}).then(function(t){return e.attr("src",t)}).catch(function(e){console.log(e)})})}$(".passwordProtectLogs").hasClass("evtHandler")||$(".passwordProtectLogs").addClass("evtHandler").on("click",function(){var e=$("#passwordSwitch");switch(e.prop("checked")){case!0:e.prop("checked",!1),$(".basePasswordShowHide").addClass("hide");break;case!1:e.prop("checked",!0),$(".basePasswordShowHide").removeClass("hide")}}),$("#passwordSwitch").hasClass("evtHandler")||$("#passwordSwitch").addClass("evtHandler").on("change",function(){y(!$("#passwordSwitch").prop("checked"))}),$("#createEventForm").hasClass("evtHandlerPassword")||$("#createEventForm").addClass("evtHandlerPassword").find(".eventPassword").on("blur",function(){w(this)}),$("#offRouteLogs").hasClass("evtHandler")||($("#offRouteLogs").addClass("evtHandler"),$("#offRouteLogs .offRouteLogs").on("click",function(){switch($("#offRouteLogsSwitch").prop("checked")){case!0:$("#offRouteLogsSwitch").prop("checked",!1);break;case!1:$("#offRouteLogsSwitch").prop("checked",!0)}})),$("#automateTimeEntry").hasClass("evtHandler")||($("#automateTimeEntry").addClass("evtHandler"),$("#automateTimeEntry .autoTime").on("click",function(){switch($("#autoTimeSwitch").prop("checked")){case!0:$("#autoTimeSwitch").prop("checked",!1);break;case!1:$("#autoTimeSwitch").prop("checked",!0)}})),$("#evtUsername").hasClass("evtHandler")||$("#evtUsername").addClass("evtHandler").on("blur",function(){var e=$("#evtUsername").val().trim();if(""!=e){var t=appServer+"/api/user/checkusername",n={username:e};$.ajax(apiAjax(t,n)).then(function(e){switch(e.status){case 200:g=!0;break;case 409:ons.notification.alert({title:e.message,message:e.reason,cancelable:!0});break;case 500:default:ons.notification.alert({title:"error",message:"issue checking username is unique",cancelable:!0})}}).catch(function(e){console.log(e),ons.notification.alert({title:"error",message:"issue checking username is unique",cancelable:!0})})}});var T=$(".addBaseButton");T.hasClass("evtHandler")||T.addClass("evtHandler").on("click",function(){S(++f),$("#passwordSwitch").prop("checked")||$(".basePasswordShowHide").addClass("hide");var e=1370+181*f;scrollToElement($("#createEventPage .page__content"),e,1e3),$("#base"+f+"Password").on("blur",function(){w(this)})}),$("#saveEvent").hasClass("evtHandler")||$("#saveEvent").addClass("evtHandler").on("click",function(){if(h){if(h){var n=new PouchDB(L.dbName);a=document.getElementById("eventBannerImage");ons.notification.confirm({title:"Update Event",message:"Are you sure you want to update "+L.eventName,cancelable:!0}).then(function(t){if(1===!t)throw{canceled:!0};return e("createEventPage",!0),0!=b&&Promise.resolve().then(function(){return downscaleImg(a,1922,240)}).then(function(e){return console.log(e),0!=e&&stepped_scale(a,e.width,.5)}).then(function(e){if(0!=e)return b=e})}).then(function(e){return console.log(e),n.get("eventDescription")}).then(function(e){var t=!1;if(C(),eventDescription.dateStart>eventDescription.dateEnd)throw"Event set to end before it starts.";if(!P(f,eventDescription.passwordProtectLogs,eventDescription))throw"password not set";return $.each(eventDescription,function(n,a){return console.log("key: "+n+" value: "+a),"bases"==n?a.forEach(function(n){if(void 0===e.bases[n.baseNo])return console.log("new base added"),t=!0,!1;var a=e.bases[n.baseNo];return console.log(a),$.each(n,function(e,n){return n===a[e]?(console.log("SAME key: "+e+" value: "+n),!0):(console.log("DIFF key: "+e+" value: "+n),t=!0,!1)})}):a===e[n]||(console.log("change made"),t=!0,!1)}),!1!==b?(eventDescription._attachments={evtLogo:{data:b,content_type:b.type}},t=!0):"object"==typeof e._attachments&&(eventDescription._attachments=e._attachments),t?(eventDescription._rev=e._rev,eventDescription.dbName=e.dbName,eventDescription.evtUserPass=e.evtUserPass,n.put(eventDescription)):{ok:!1}}).then(function(e){return console.log(e),e.ok?(eventDescription._rev=e.rev,t(L.dbName,["eventDescription"],!0)):ons.notification.alert({title:"No change found",message:"No change has been detected from previous event information. A new version has not been saved.",cancelable:!0}).then(function(){throw navi.popPage()})}).then(function(e){console.log(e);var t={animation:pageChangeAnimation,data:{eventName:eventDescription.eventName,url:E,eventInfo:eventDescription}};return navi.resetToPage("eventSummaryPage.html",t)}).then(function(e){return new PouchDB(http+username+":"+password+"@"+couchdb+"/"+L.dbName).compact(),closeDatabases()}).catch(function(t){if(console.log(t),e("createEventPage",!1),!0===t.canceled)return!1;var n={title:"Input Error",message:t,cancelable:!0};ons.notification.alert(n)})}}else{if(e("createEventPage",!0),C(),eventDescription.dateStart>eventDescription.dateEnd)return ons.notification.alert({title:"Check event dates",message:"Event set to end before it starts.",cancelable:!0});if(0!=b){var a=document.getElementById("eventBannerImage");Promise.resolve().then(function(){return downscaleImg(a,1922,240)}).then(function(e){return console.log(e),0!=e&&stepped_scale(a,e.width,.5)}).then(function(e){return 0!=e?b=e:b}).then(function(e){return eventDescription._attachments={evtLogo:{data:e,content_type:e.type}}}).catch(function(e){console.log(e)})}switch(""===eventDescription.eventName||""===eventDescription.dateStart||""===eventDescription.dateEnd||""===eventDescription.adminPassword||""===eventDescription.evtUsername){case!0:ons.notification.alert({title:"Missing attributes",messageHTML:"<p>An event requires the following information:</p><p>A name</p></p><p>Start and end date</p></p><p>An admin password</p><p>An event username</p>"}).then(function(){return e("createEventPage",!1)}),console.log(eventDescription);break;case!1:if(g){if(P(f,eventDescription.passwordProtectLogs,eventDescription)){var o=appServer+"/api/event/new",s={username:username,password:password,eventName:eventDescription.eventName,evtUsername:eventDescription.evtUsername};$.ajax(apiAjax(o,s)).then(function(e){if(console.log(e),void 0!==localStorage.db){var t=JSON.parse(localStorage.db);t.push(e.dbName),localStorage.db=JSON.stringify(t)}else localStorage.db=e.dbName;localStorage.lastDb=e.dbName,localStorage.couchdb=e.url,localStorage.http=e.http,eventDescription.evtUserPass=e.evtUserPass,eventDescription.dbName=e.dbName;var n=e.http+username+":"+password+"@"+e.url+"/"+e.dbName;return remotedbURL===n||(remotedbURL=n,remotedbConnected?remotedb.close().then(function(e){return remotedbConnected=!1}).catch(function(e){throw console.log(e),e}):remotedbConnected)}).then(function(e){return!1===e?(console.log("creating new remotedb connection with new characteristics"),remotedb=new PouchDB(remotedbURL)):remotedb}).then(function(e){return console.log(e),e.get("eventDescription").then(function(t){return eventDescription._rev=t._rev,e.put(eventDescription)}).catch(function(t){if(console.log(t),404===t.status)return e.put(eventDescription);throw console.log(t),t.message="unable to upload event description to the database",t})}).then(function(e){return t(eventDescription.dbName,["eventDescription"],!1)}).then(function(e){return addAppdbLoginDb(eventDescription.dbName)}).then(function(e){console.log(e);var t={animation:pageChangeAnimation,data:{eventName:eventDescription.eventName,url:E,eventInfo:eventDescription}};return navi.resetToPage("eventSummaryPage.html",t)}).catch(function(t){return console.warn(t),void 0===t.message&&(t.message="issue saving the event"),ons.notification.alert({title:"error",message:t.message,cancelable:!0}).then(function(){return e("createEventPage",!1)})})}}else ons.notification.alert({title:"error",message:"username is not unique, please try a different username",cancelable:!0}).then(function(){return e("createEventPage",!1)})}}});break;case"eventSummaryPage.html":var x=navi.topPage.data.eventName,E=navi.topPage.data.url;if("object"==typeof navi.topPage.data.eventInfo)var L=navi.topPage.data.eventInfo;else L=eventDescription;if(console.log(L),console.log(E),!$("#eventSummaryPage").hasClass("evtLoaded")){$("#eventSummaryPage").addClass("evtLoaded"),console.log(L),$("#evtSummaryTitle").html(x);var B=new Date(L.dateStart),_=new Date(L.dateEnd);$("#evtSummaryStartDate").append(B.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+" on "+B.toDateString()),$("#evtSummaryEndDate").append(_.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+" on "+_.toDateString()),$("#evtSummaryBaseCount").append(L.bases.length),$("#evtSummaryUsername").append(L.evtUsername),$("#evtSummaryPassword").append(L.evtUserPass),""!==L.eventDescription&&$("#evtSummaryDescription").append(L.eventDescription.replace(/\n/g,"<br>")),$("#evtSummaryAdminPass").append(L.bases[0].basePassword),L.bases.forEach(function(e){$("#evtSummaryBases").append('<p class="bold evtSummaryBasesTitle">Base '+e.baseNo+": "+e.baseName+"</p>"),void 0===e.baseMaxScore||""===e.baseMaxScore?message="no score available at this location":message=e.baseMaxScore,$("#evtSummaryBases").append('<p><span class="bold sentanceCase">Max Score Available: </span>'+message+"</p>"),L.passwordProtectLogs&&$("#evtSummaryBases").append('<p><span class="bold sentanceCase">Base code: </span><span class="passwordFont">'+e.basePassword+"</span></p>"),"string"==typeof e.baseInstructions&&""!==e.baseInstructions&&$("#evtSummaryBases").append('<p><span class="bold sentanceCase">Base instructions: </span>'+e.baseInstructions.replace(/\n/g,"<br>")+"</p>")}),Promise.resolve().then(function(){return n(L,E)}).then(function(e){console.log(e),null!=e&&($("#evtSummaryBanner").append('<img src="'+e+'" class="loginLogo marginTop" id="eventSummaryBannerImage">'),E=e)}).catch(function(e){console.log(e)}),$("#goToEvent").on("click",function(){lastDb=L.dbName,console.log(lastDb),localStorage.lastDb=lastDb,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb;var e={animation:pageChangeAnimation,data:{eventInfo:L,url:E}};navi.resetToPage("loginPage.html",e)}),$(".evtSendEmail").on("click",function(){console.log("send email");var e=appServer+"/api/event/email",t={username:username,password:password,db:L.dbName};return $.ajax(apiAjax(e,t)).then(function(e){return M=200!==e.status?{title:"Error",message:"There was an issue sending you an email with the event details, please try again later.",cancelable:!0}:{title:"Email Sent",messageHTML:'<p>An email has been sent to you at the email address you use to sign in:</p><p class="secondaryColor">'+changeAtSymbolBack(username)+"</p><p>Please check your inbox it should be with you shortly.</p><p>This will contain instructions you can distribute to your users on how start using the app or website.</p>",cancelable:!0}}).then(function(e){return ons.notification.alert(e)})});var N=$("#eventSummaryPage .page__content"),O=document.getElementById("sendEventEmailButtonContainer"),R=document.getElementById("emailEvtDescription");N.on("scroll",function(){return isScrolledIntoView(O)?(console.log("isVisible"),R.hide()):R.show()})}break;case"loginPage.html":if("string"==typeof name&&"undefined"!==name&&$("#userName").val(name),void 0!==navi.topPage.data.eventInfo){L=navi.topPage.data.eventInfo;if(!evtUpdateCheckConnected){evtUpdateCheckConnected=!0;var H=new PouchDB(L.dbName),A=new PouchDB(http+username+":"+password+"@"+couchdb+"/"+L.dbName),M={doc_ids:["eventDescription"],live:!0,retry:!0},U=!1;evtUpdateCheck=H.replicate.from(A,M).on("change",function(e){if(!U){U=!0;var t=e.docs[0]._rev.split(/\W/g)[0];ons.notification.alert({title:"Event Updated",messageHTML:"<p>This event has been updated by the event organisers to version: "+t+".</p><p>Your device will update once this message closes.</p>",cancelable:!0}).then(function(e){var t={animation:pageChangeAnimation,data:{event:L.dbName,lastPage:"loginPage.html"}};navi.resetToPage("updatePage.html",t),evtUpdateCheck.cancel(),U=!1})}}).on("paused active denied error",function(e){console.log(e)}).on("complete",function(e){console.log("evtUpdateCheck complete"),evtUpdateCheckConnected=!1})}$("#loginEventDescription").html(L.eventDescription.replace(/\n/g,"<br>"));var q;B=new Date(L.dateStart),_=new Date(L.dateEnd),I=/\W/g;q="string"==typeof L._rev?L._rev.split(I)[0]:1,$("#loginEventDescriptionTitle").after('<span id="evtVersion">Event version: '+q+'</span><p><span class="bold">Start</span>: '+B.toDateString()+" at "+B.toLocaleTimeString()+'<br><span class="bold">End</span>: '+_.toDateString()+" at "+_.toLocaleTimeString()+"</p>");E=navi.topPage.data.url,k=$("#loginEventLogo");if(Promise.resolve().then(function(){return n(L,E)}).then(function(e){null!=e?(k.hide().attr("src",e).removeClass("hide").fadeIn(1500),E=e):k.hide().removeClass("hide").fadeIn(1500)}).catch(function(e){console.warn(e)}),L.passwordProtectLogs){L.bases.forEach(function(e){var t=e.basePassword;""===t&&(t=e.baseNo.toString()),baseCodes.push(t),baseNames.push(e.baseName)});var F="Please enter both your name and your base code provided by the event organisers.",W="Welcome to "+L.eventName+" please enter your name and base code below:";(j=$("#baseCode")).hasClass("evtHandler")||j.addClass("evtHandler").on("keyup",function(e){13===e.which&&(e.preventDefault(),$(".loginButton").click())})}else{var j;F="Please enter both your name and select a base.",W="Welcome to "+L.eventName+" please enter your name and select a base below:";$("#baseCode").replaceWith('<ons-button class="primaryColorButton" modifier="large" id="baseCode">Select a base</ons-button>'),(j=$("#baseCode")).hasClass("evtHandler")||j.addClass("evtHandler").on("click",function(){var e=document.getElementById("baseSelectDialog");null===e?ons.createDialog("baseSelectDialog.html").then(function(e){e.addEventListener("preshow",function(e){var t=navi.topPage.data.eventInfo.bases;baseCodes=[],baseNames=[];var n=$("#loginBaseSelect");n.empty(),t.forEach(function(e){var t=e.baseNo.toString(),a=e.baseName;baseCodes.push(t),baseNames.push(a),n.append('<ons-list-item onClick="baseSelectValue('+t+')" class="baseSelectItem"  id="baseSelect_'+t+'" value ="'+t+'"><label class="left"><ons-input name="color" type="radio" input-id="radio-'+t+'"></ons-input></label><label for = "radio-'+t+'"class = "center" >'+a+"</label></ons-list-item>")})}),e.show()}).catch(function(e){console.warn(e)}):e.show()}),$("#betweenNameAndBase").html("Select your base by pressing the button below:"),$("#loginCodeCaption").remove()}$("#loginWelcome").html(W),console.log("event called "+L.eventName),$("#loginTitle .normalTitle,#loginTitle .mainTitle").html(L.eventName)}var Q=$("#loginButton"),K=$("#baseCode"),Y=$("#userName");Q.hasClass("evtHandler")||Q.addClass("evtHandler").on("click",function(){var e=(new Date).toISOString();L.eventName;return Promise.resolve().then(function(){if(""===K.val()||""===Y.val())throw{message:F,title:"Missing inputs",cancelable:!0};var e=K.val().toLowerCase();if(name=Y.val(),!((base=baseCodes.indexOf(e))>-1))throw{message:"Please try re-entering your base code or contact the event organisers",title:"Incorrect Base Code",cancelable:!0};return base}).then(function(e){return 0!==e||L.passwordProtectLogs?e:ons.notification.prompt({title:"Enter Admin Code",messageHTML:"To enter the admin area please enter the admin code provided to you by the event organisers:",cancelable:!0,placeholder:"Enter admin code here"}).then(function(t){if(t.toLowerCase()!==L.adminPassword)throw{title:"Admin code Error",message:"Please try re-entering your admin code, the code you entered was incorrect.",cancelable:!0};return e})}).then(function(t){return appdb.get("login_"+username).then(function(t){return t.base=base,t.name=name,t.currentDb=L.dbName,t.timestamp=e,appdb.put(t)}).catch(function(e){return console.warn(e),ons.notification.alert({title:"Error saving user",message:"You have logged in but there was an error saving your user credentials, the app will require you to log in again if you close it.",cancelable:!0})})}).then(function(e){loginAndRunFunction(base,{eventInfo:L}),evtUpdateCheck.cancel()}).catch(function(e){return console.warn(e),ons.notification.alert(e)})}),menuController("loginPage.html");break;case"eventSelectionPage.html":var V=$("#ongoingEvents"),z=$("todaysEvents"),J=$("#upcomingEvents"),Z=$("#pastEvents"),G=JSON.parse(localStorage.db);console.log(G),Promise.all(G.map(function(e){return new PouchDB(e).get("eventDescription").then(function(t){var a,o=new Date,s=o.getDay(),i=o.getMonth(),r=o.getFullYear(),l=new Date(t.dateStart),c=l.getDay(),d=l.getMonth(),u=l.getFullYear(),g=new Date(t.dateEnd);a=l<o&&o<g?V:o<l&&c===s&&d===i&&u===r?z:o<l?J:o>g?Z:J;var m='<div class="card mdl-shadow--2dp" id="'+e+'"><div class="cardMediaDiv"></div><div class="mdl-card__title">'+t.eventName+'</div><div class="mdl-card__actions mdl-card--border"><ons-button modifier="quiet" class="goToEventButton secondaryColor">Enter event</ons-button><ons-button modifier="quiet" class="goToSummary secondaryColor">Info</ons-button><ons-button modifier="quiet" ripple class="cardIconButton rotate270 evtInstructionsShow button--material button--material--flat"><i class="zmdi zmdi-chevron-left chevron"></i></ons-button></div><div class="mdl-card__supporting-text hide">'+t.eventDescription.replace(/\n/g,"<br>")+'</div><div class="cardTRButton"><ons-button modifier="quiet" ripple class="cardIconButton hide"><i class="zmdi zmdi-share"></i></ons-button></div></div><br>';a.append(m),a.find(".eventTitle").removeClass("hide");var p=$("#"+e);p.data("eventInfo",t),$("#"+e+" .goToEventButton").on("click",function(){var e=p.data("eventInfo");console.log(e),lastDb=e.dbName,localStorage.lastDb=lastDb,remotedbURL=http+username+":"+password+"@"+couchdb+"/"+lastDb;var t={animation:pageChangeAnimation,data:{eventInfo:e}};navi.resetToPage("loginPage.html",t)});var h=$("#"+e+" .evtInstructionsShow");return h.on("click",function(){h.toggleClass("rotate90"),$("#"+e+" .mdl-card__supporting-text").slideToggle(500)}),$("#"+e+" .goToSummary").on("click",function(){var e=p.data("eventInfo"),t=(p.find(),{animation:pageChangeAnimation,data:{eventInfo:e}});navi.bringPageTop("eventSummaryPage.html",t)}),n(t)}).then(function(t){if(null!=t)return $("#"+e+" .cardMediaDiv").css({"background-image":'url("'+t+'")',"background-repeat":"no-repeat","background-position":"center top","background-size":"cover",height:240,"min-height":100}),!0;console.log("no url")}).catch(function(e){console.warn(e)})}));var X=$("#createNewEventButton");X.hasClass("evtHandler")||X.addClass("evtHandler").on("click",function(){var e={animation:pageChangeAnimation,data:{edit:!1}};navi.bringPageTop("createEventPage.html",e)}),menuController("eventSelectionPage.html");break;case"page1.html":menuController("page1.html");var ee=document.getElementById("fullEditFab");ee.hide(),userCurrentlySelected=[],$("#fullEditFab").removeClass("hide");var te=$("#logsTable");if(void 0!==navi.topPage.data.eventInfo){var ne=(L=navi.topPage.data.eventInfo).bases[getBaseNumber()];""!=ne.baseInstructions&&(console.log("there are base instructions"),$("#p1TopHalf").prepend('<div id="instructions"><ons-list><ons-list-item tappable><div class="left">Show base instructions</div><div class="right"><i id="instructionChevron" icon="md-chevron-left" class="zmdi zmdi-chevron-left secondaryColor rotate270 chevron"></i></div></ons-list-item></div>'),$("#instructions").append('<div id="baseInstructions" class="hide baseInstructions">'+L.bases[getBaseNumber()].baseInstructions.replace(/\n/g,"<br>")+"</div>"),$("#instructions").on("click",function(){$("#instructionChevron").toggleClass("rotate90"),$("#baseInstructions").slideToggle(500)})),""===ne.baseMaxScore||void 0===ne.baseMaxScore?$("#page1TotalScore").hide():$("#total").attr("placeholder","Total score (max "+ne.baseMaxScore+")"),1==L.autoTime&&$("#p1TopHalf .page1Time").hide(),baseDatabaseName=L.dbName}function ae(e){console.log(e),e.length>0&&te.prepend(e),orientationLandscapeUpdate(),clearQuickAddInputs()}base>0?($("#page1 .normalTitle, #page1 .mainTitle").html("Base "+base+" @ "+L.bases[getBaseNumber()].baseName),$("#quickAddTitle").html("Add new log from base "+base),participantReference(L.pRef,"page1")):"noBase"===base&&($("#page1 .normalTitle,#page1 .mainTitle").html("On the look out"),$("#quickAddTitle").html("Record the teams you see"),$("#tableTitle").html("Teams seen")),$("#logsTable").empty(),!1===basedbConnected&&(basedb=new PouchDB(baseDatabaseName),basedbConnected=!0),basedb.createIndex({index:{fields:["timeOut"],name:"timeOutIndex",ddoc:"timeOutIndex",type:"json"}}).then(function(e){return console.log(e),basedb.createIndex({index:{fields:["base","timeOut"],name:"baseTimeOutIndex",ddoc:"baseTimeOutIndex",type:"json"}})}).then(function(e){return basedb.createIndex({index:{fields:["patrol"],name:"patrolIndex",ddoc:"patrolIndex",type:"json"}})}).then(function(e){return console.log(e),basedb.find({selector:{timeOut:{$gt:0},base:{$eq:base}},sort:["timeOut"]})}).then(function(e){return console.log(e),dbUpdateFromFindOrChange(e,!1)}).then(function(e){return basedb.createIndex({index:{fields:["base"],name:"baseIndex",ddoc:"baseIndex",type:"json"}})}).then(function(e){if(!1===remotedbConnected&&(remotedb=new PouchDB(remotedbURL),remotedbConnected=!0),!1===baseSyncInProgress){return baseSyncInProgress=!0,syncBasedb=basedb.sync(remotedb,{live:!0,retry:!0}).on("change",function(e){(console.log(e),"pull"===e.direction)?(console.log("change occured in remote updating basedb"),dbUpdateFromFindOrChange(e.change,!1)):console.log("updating remotedb")}).on("paused",function(e){console.log("basedb pasused"),lastSyncUpdater()}).on("active",function(e){}).on("error",function(e){console.log(e),ons.notification.alert({title:"Error",messageHTML:"<p>An error has occured with the following message</p><p>"+e.message+"</p>",cancelable:!0}),409===e.status&&console.log("conflict in doc upload")}).on("complete",function(e){console.log("sync between remotedb and basedb has been cancelled"),baseSyncInProgress=!1})}}).catch(function(e){return console.warn(e)}),checkForNewMessagesOnPageLoad(basedb,dbSeqNumber),L.logOffRoute&&!$("#offRouteCheckbox").hasClass("evtHandler")?($("#offRouteCheckbox").addClass("evtHandler").removeClass("logOffRouteFalse"),$(".checkbox").on("click",".checkbox__input",function(){$("#offRoute.checkbox__input").is(".checkbox__input:checked")?$("#total").prop("disabled",!0):$("#total").prop("disabled",!1)})):L.logOffRoute||$("#offRouteCheckbox").addClass("logOffRouteFalse"),$("#logsTable").hasClass("evtHandler")||($("#logsTable").addClass("evtHandler"),$("#logsTable").on("click","tr",function(e){if($(this).hasClass("lockedLog"))ons.notification.alert({title:"No longer editable",message:"This record has been locked by HQ and cannot be edited",cancelable:!0});else if($(this).hasClass("tableSelected")){$(this).removeClass("tableSelected");var t=$(this).attr("id"),n=userCurrentlySelected.indexOf(t);n>-1&&userCurrentlySelected.splice(n,1),console.log(userCurrentlySelected),$("tr").hasClass("tableSelected")||ee.hide()}else{$("tr").removeClass("tableSelected"),$(this).addClass("tableSelected"),ee.show(),userCurrentlySelected=[];t=$(this).attr("id");userCurrentlySelected.push(t),console.log(userCurrentlySelected)}})),$("#fullEditFab").hasClass("evtHandler")||($("#fullEditFab").addClass("evtHandler"),$("#fullEditFab").on("click",function(){editLog(userCurrentlySelected)})),$("#cancelSubmitQuick").hasClass("evtHandler")||($("#cancelSubmitQuick").addClass("evtHandler"),console.log("got to here"),$("#cancelSubmitQuick").on("click",function(){ons.notification.confirm({message:"Are you sure you want to clear this entry?",cancelable:!0}).then(function(e){1==e&&clearQuickAddInputs()})})),$("#submitQuick").hasClass("evtHandler")||($("#submitQuick").addClass("evtHandler"),$("#submitQuick").on("click",function(){base=getBaseNumber(),sqPatrol=$("#patrolNo").val(),o=$("#timeIn").val(),sqTimeOut=$("#timeOut").val(),sqWait=$("#wait").val(),sqOffRoute=$("#offRoute").prop("checked"),sqTotalScore=$("#total").val();var e="",t=Date.now(),n=(new Date).toISOString(),a=[];if(""===o)var o=new Date;else if(5==o.length){var s=o.split(":");(o=new Date).setHours(s[0]),o.setMinutes(s[1]),o.setSeconds(0),console.log(o)}if(""===sqTimeOut)sqTimeOut=new Date;else if(5==sqTimeOut.length){var i=sqTimeOut.split(":");(sqTimeOut=new Date).setHours(i[0]),sqTimeOut.setMinutes(i[1])}if(""===sqPatrol&&(e="<p>Patrol number</p>"),sqOffRoute||""!==sqTotalScore||""===ne.baseMaxScore||(e+="<p>Total score for the patrol</p>"),""!==e)ons.notification.alert({title:"Missing fields",messageHTML:"<p>This log entry is missing the following fields:</p>"+e,cancelable:!0});else if(parseInt(sqTotalScore)>parseInt(ne.baseMaxScore))ons.notification.alert({title:"Total score",message:"The total score entered is greater than the maximum points available at a base.",cancelable:!0});else if(o>sqTimeOut)ons.notification.alert({title:"Time input",message:"The time out must be after the time in.",cancelable:!0});else if(sqOffRoute&&""!=sqTotalScore)ons.notification.confirm({title:"Confirm off route or log score",messageHTML:"<p>You have entered a score of "+sqTotalScore+" and that the team was off route.</p><p>Select whether you wish to submit an off route log with no score or an on route log with a score of "+sqTotalScore+".</p>",cancelable:!0,buttonLabels:["Off route - no score","On route - score of "+sqTotalScore]}).then(function(e){switch(console.log(e),e){case 0:$("#total").val(""),$("#submitQuick").click();break;case 1:$("#offRoute").prop("checked",!1),$("#submitQuick").click()}}).catch(function(e){console.warn(e)});else{""==sqWait&&(sqWait=0),(sqOffRoute&&""!=sqTotalScore||"noBase"===base)&&(sqTotalScore=""),L.logOffRoute||(sqOffRoute="n/a");var r={_id:sqPatrol+"_base_"+base,patrol:sqPatrol,base:base,username:name,timeIn:o,timeOut:sqTimeOut,timeWait:sqWait,offRoute:"",totalScore:sqTotalScore,editable:!0,timestamp:n};switch(sqOffRoute){case!0:console.log(base),r._id=sqPatrol+"_base_"+base+"_offRoute_"+t,r.offRoute=sqOffRoute,tableUpdateFunction(r,!1,a),ae(a),console.log(r),basedb.put(r);break;default:basedb.get(r._id).then(function(e){switch(e.editable){case!0:return ons.notification.confirm({title:"Update",message:"Are you sure you want to update patrol number "+sqPatrol,cancelable:!0}).then(function(t){if(1===t)return r._rev=e._rev,r._id=e._id,basedb.put(r).then(function(e){return tableUpdateFunction(r,!1,a)})}).catch(function(e){console.warn(e)});case!1:return ons.notification.alert({title:"No longer editable",message:"This record has been updated by HQ and cannot be edited",cancelable:!0})}}).catch(function(e){if(404==e.status)return console.log("404 no prior record putting a new record"),tableUpdateFunction(r,!1,a),basedb.put(r);if(409==e.status)switch(doc.editable){case!0:console.log("409 putting anyway");var t={_id:doc._id,_rev:doc._rev,patrol:sqPatrol,base:base,username:name,timeIn:o,timeOut:sqTimeOut,timeWait:sqWait,offRoute:"",totalScore:sqTotalScore,editable:!0,timestamp:n};basedb.put(t).then(function(){return tableUpdateFunction(t,!1,a)});break;case!1:console.log("409 alert message"),ons.notification.alert({title:"No longer editable",message:"This record has been recorded by HQ and cannot be edited, please contact HQ to unlock",cancelable:!0})}else console.warn(e)}).then(function(e){ae(a)})}}}));break;case"admin.html":var oe,se,ie=!1,re=[],le=$("#patrolSearch"),ce=$("#adminTitleDiv");function de(e,t,n){timeStarting=Date.now();for(var a=[],o=0,s=e.docs.length;o<s;o++){var i=e.docs[o];if("number"!=typeof ie||i.patrol===ie){var r=re.indexOf(i.patrol);if(t||!(r>-1)){var l="on route";i.offRoute&&(l="off route");var c=new Date(i.timeOut).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),d='<tr id="ls-'+i.patrol+'"><td class="bold">'+i.patrol+"</td><td>"+c+"</td><td>"+i.base+"</td><td>"+l+'</td><td class="hide landscapeShow">'+i.username+"</td></tr>";r>-1?($("#lastSeenTable #ls-"+i.patrol).remove(),a=d):(re.push(i.patrol),a.unshift(d))}}}n.append(a),orientationLandscapeUpdate(),console.log(Date.now()-timeStarting),console.log("updated ls table")}function ue(e,t){admindb.find({selector:{timeOut:{$gt:0}},fields:["_id","base","patrol","timeOut","offRoute","username"],sort:[{timeOut:"desc"}]}).then(function(n){return de(n,t,e)}).catch(function(e){console.warn(e)})};function ge(e,t){e.empty(),admindb.query("leaderboardIndex",{reduce:!0,group:!0}).then(function(e){return e.rows.sort(a("value",!0))}).then(function(e){return n=e,a=t,o=1,s="",Promise.all(n.map(function(e){s===e.value&&o--;var t='<tr id="lb-'+o+'"><td class="bold">'+o+"</td><td>"+e.key+"</td><td>"+e.value+"</td></tr>";if(o++,s=e.value,!a||a===e.key||void 0===a)return t}));var n,a,o,s}).then(function(t){e.append(t)}).catch(function(e){console.warn(e)})};if(menuController("admin.html"),null!=navi.topPage.data.eventInfo){L=navi.topPage.data.eventInfo;adminDatabaseName=L.dbName}if(!le.hasClass("evtHandler")){le.addClass("evtHandler");var me=!1,pe=!1;le.on("click",function(){if(me)pe&&($("#patrolSearchInput").removeClass("hide"),ce.addClass("adminHide"));else{ce.addClass("adminHide");$(this).prepend('<ons-input id="patrolSearchInput" type="number" modifier="underbar" placeholder="Patrol No." float class="patrolSearchInput" autofocus></ons-input>'),me=!0,$(document).ready(function(){$("#patrolSearchInput").focus().on("keyup blur",function(e){if(13===e.which||"blur"===e.type){var t=$(this).val();ie!=t&&""!==t?(ie=t,admindb.find({selector:{timeOut:{$gt:0},patrol:{$eq:ie}},sort:["timeOut"]}).then(function(e){console.log(e),$("#adminLogsTable").empty(),patrolRecordAdmin=[],offRouteIndexAdmin=[],dbUpdateFromFindOrChange(e,!0),null!=oe&&(re=[],oe.empty(),de(e,!0,oe)),null!=se&&ge(se,ie)})):""===t&&ie!=t&&!1!==ie&&"blur"===e.type?($(this).addClass("hide"),ce.removeClass("adminHide"),pe=!0,admindb.find({selector:{timeOut:{$gt:0}},sort:["timeOut"]}).then(function(e){ie=!1,$("#adminLogsTable").empty(),patrolRecordAdmin=[],offRouteIndexAdmin=[],dbUpdateFromFindOrChange(e,!0),null!=oe&&void 0!==oe&&(oe.empty(),re=[],ue(oe,!1)),null!=se&&ge(se,ie)})):""===t&&($(this).addClass("hide"),ce.removeClass("adminHide"),pe=!0)}})})}})}document.getElementById("adminTabbar").addEventListener("postchange",function(t){switch(console.log("tab changed code will be run"),console.log(t.tabItem.getAttribute("page")),t.tabItem.getAttribute("page")){case"allLogsPage.html":var n=$("#allLogsPage");if(participantReference(L.pRef,"allLogsPage"),!n.hasClass("evtHandler")){n.addClass("evtHandler");var a=document.getElementById("adminSpeedDial");a.hide(),adminCurrentlySelected=[];0==admindbConnected&&(admindb=new PouchDB(adminDatabaseName),admindbConnected=!0),admindb.createIndex({index:{fields:["timeOut"],name:"timeOutIndex",ddoc:"timeOutIndex",type:"json"}}).then(function(e){return console.log(e),admindb.createIndex({index:{fields:["base","timeOut"],name:"baseTimeOutIndex",ddoc:"baseTimeOutIndex",type:"json"}})}).then(function(e){return admindb.createIndex({index:{fields:["patrol"],name:"patrolIndex",ddoc:"patrolIndex",type:"json"}})}).then(function(e){return admindb.createIndex({index:{fields:["base"],name:"baseIndex",ddoc:"baseIndex",type:"json"}})}).then(function(e){return admindb.get("_design/leaderboardIndex").then(function(e){return e}).catch(function(e){var t={_id:"_design/leaderboardIndex",views:{leaderboardIndex:{map:function(e){"string"==typeof e.patrol&&emit(e.patrol,parseInt(e.totalScore)||0)}.toString(),reduce:"_sum"}}};return admindb.put(t)})}).then(function(e){return console.log(e),admindb.find({selector:{timeOut:{$gt:0}},sort:["timeOut"]})}).then(function(e){return console.log(e),dbUpdateFromFindOrChange(e,!0)}).then(function(e){if(!1===remotedbConnected&&(remotedb=new PouchDB(remotedbURL),remotedbConnected=!0),!1===adminSyncInProgress){return adminSyncInProgress=!0,adminSync=admindb.sync(remotedb,{live:!0,retry:!0}).on("change",function(e){(console.log(e),"pull"===e.direction)?(console.log("change occured in remote updating admindb"),dbUpdateFromFindOrChange(e.change,!0,ie)):console.log("updating remotedb")}).on("paused",function(e){console.log("replication paused because of:"),console.log(e),lastSyncUpdater()}).on("active",function(e){console.log("replication resumed. Info: "),console.log(e)}).on("error",function(e){console.log("Replication Error: "),console.log(e),ons.notification.alert({title:error,message:"A connection error has occured please, refresh the app or web page",cancelable:!0})}).on("complete",function(e){console.log("sync disconected from admin database."),adminSyncInProgress=!1})}}).catch(function(e){console.warn(e)}),$("#adminSpeedDial").removeClass("hide"),$("#adminLogsTable").hasClass("evtHandler")||$("#adminLogsTable").addClass("evtHandler").on("click","tr",function(e){if($(this).hasClass("tableSelected")){$(this).removeClass("tableSelected");var t=$(this).attr("id"),n=adminCurrentlySelected.indexOf(t);n>-1&&adminCurrentlySelected.splice(n,1),console.log(adminCurrentlySelected),$("tr").hasClass("tableSelected")||a.hide()}else if(1==e.shiftKey){$(this).addClass("tableSelected"),a.show();t=$(this).attr("id");adminCurrentlySelected.push(t),console.log(adminCurrentlySelected)}else{$("tr").removeClass("tableSelected"),$(this).addClass("tableSelected"),a.show(),adminCurrentlySelected=[];t=$(this).attr("id");console.log(t),adminCurrentlySelected.push(t),console.log(adminCurrentlySelected)}}),$("#adminDelete").hasClass("evtHandler")||($("#adminDelete").addClass("evtHandler"),$("#adminDelete").on("click",function(){ons.notification.confirm({title:"Are you sure?",message:"Are you sure you wish to delete these "+adminCurrentlySelected.length+" logs",cancelable:!0}).then(function(e){1==e&&deleteRecords(adminCurrentlySelected)})})),$("#adminLock").hasClass("evtHandler")||$("#adminLock").addClass("evtHandler").on("click",function(){lockOrUnlockLogFromEdits(adminCurrentlySelected,!0)}),$("#adminUnlock").hasClass("evtHandler")||$("#adminUnlock").addClass("evtHandler").on("click",function(){lockOrUnlockLogFromEdits(adminCurrentlySelected,!1)}),checkForNewMessagesOnPageLoad(admindb,dbSeqNumber)}break;case"lastSeenPage.html":void 0===oe&&(oe=$("#lastSeenTable")),oe.hasClass("evtListener")||(oe.addClass("evtListener"),e("adminPage",!0),participantReference(L.pRef,"lastSeenPage"),ue(oe,!1),e("adminPage",!1),adminSync.on("change",function(t){if(console.log("updating ls table on change"),console.log(t.change.docs),e("adminPage",!0),0===("string"==typeof ie?t.change.docs.filter(function(e){return e.patrol===ie}):t.change.docs.filter(function(e){return"string"==typeof e.patrol})).length)return e("adminPage",!1);oe.empty(),re=[],ue(oe,!1),e("adminPage",!1)}));break;case"leaderboard.html":void 0===se&&(se=$("#leaderboardTable")),se.hasClass("evtListener")||(se.addClass("evtListener"),e("adminPage",!0),participantReference(L.pRef,"leaderboard"),ge(se,ie),e("adminPage",!1),adminSync.on("change",function(t){if(console.log("updating leader table on change"),console.log(t.change.docs),e("adminPage",!0),console.log(ie),console.log(typeof ie),0===("string"==typeof ie?t.change.docs.filter(function(e){return e.patrol===ie}):t.change.docs.filter(function(e){return"string"==typeof e.patrol})).length)return e("adminPage",!1);console.log("got here"),ge(se,ie),e("adminPage",!1)}))}});break;case"messagesPage.html":var he=navi.topPage.data.currentBase,fe=(L=navi.topPage.data.eventInfo,$("#messageWindow")),ve=$("#messageInput"),be=document.getElementById("newMessages"),we=$("#messageInputPlaceholder"),Se=basedb,ye=$("#messagesPage .page__content"),$e=($("#messagesPage"),!0),Ce=$("#scrollToBottomFab"),Pe=$("#scrollMessageBadge");function Ie(){var e=(new Date).toISOString(),t={_id:"message-"+e,message:ve.html().trim(),from:he,time:e,username:name};Se.put(t).then(function(e){e.ok?(console.log("message sent"),ve.html(""),we.removeClass("hide"),ke=!0,nextSeq=++dbSeqNumber,localStorage.dbSeqNumber=dbSeqNumber):console.log(e)}).then(function(e){return addMessages(Se,fe,ye,{include_docs:!0,endkey:newestMessage,startkey:"messageï¿°",descending:!0,limit:void 0},!1,!0,!0)}).catch(function(e){console.warn(e)}),""===ve.html()&&(we.removeClass("hide"),ke=!0)};dbSeqNumber=nextSeq,localStorage.dbSeqNumber=nextSeq,0===he&&(Se=admindb,adminSync),Ce[0].hide(),addMessages(Se,fe,ye,M={include_docs:!0,endkey:"message",startkey:"messageï¿°",descending:!0,limit:25},!1,!0,!0);var ke=!0;ve.on("keydown",function(e){ke&&(we.addClass("hide"),ke=!1),13!=e.which||e.shiftKey||e.preventDefault()}).on("keyup",function(e){console.log("keyup"),13!=e.which||e.shiftKey||Ie()}),$("#sendMessage").on("click",function(){""!=ve.html()&&Ie()}),lastSyncHandler(),Ce.on("click",function(){var e=ye[0].scrollHeight;scrollToElement(ye,e,1)}),updateMsgBadgeNo(0,!0),ye.on("scroll",function(){return $e&&nextMessageEndKey!==nextMessageEndKey2&&function e(){return $e=!1,Promise.resolve().then(function(){var t=ye.scrollTop();return t<120?(nextMessageEndKey2=nextMessageEndKey,addMessages(Se,fe,ye,{include_docs:!0,endkey:"message",startkey:nextMessageEndKey,descending:!0,limit:5},!0,!0,!1,t).then(function(t){return ye.scrollTop()<300&&nextMessageEndKey!==nextMessageEndKey2?e():$e=nextMessageEndKey!==nextMessageEndKey2})):($e=!0,!0)}).catch(function(e){console.warn(e)})}(),isScrolledIntoView(be)?(console.log("At Bottom"),Ce[0].hide(),void Pe.html(0).addClass("hide")):Ce[0].show()});break;case"updatePage.html":var De,Te=navi.topPage.data;console.log(Te),M={animation:pageChangeAnimation,data:{firstPage:!0}},closeDatabases(),Promise.resolve().then(function(){if(void 0===Te.lastPage)throw"no last page defined";return De=navi.topPage.data.lastPage,null!=Te.eventInfo?M.data.eventInfo=Te.eventInfo:null!=Te.event?new PouchDB(Te.event).get("eventDescription").then(function(e){M.data.eventInfo=e}).catch(function(e){throw e}):void 0}).then(function(e){navi.resetToPage(De,M)}).catch(function(e){console.warn(e),ons.notification.alert({title:"Issue Updating",message:"There was an issue updating, please sign in again to fix",cancelable:!0}).then(function(){De="signInPage.html",navi.resetToPage(De,M)})});break;case"testPage.html":var xe=Stripe("pk_test_Oy2WT7ZOCDFPn0znWKqZ4zQQ"),Ee=xe.elements().create("card",{style:{base:{fontSize:"16px",color:"#32325d"}}});Ee.addEventListener("change",function(e){var t=document.getElementById("card-errors");e.error?t.textContent=e.error.message:t.textContent=""}),document.getElementById("payment-form").addEventListener("submit",function(e){e.preventDefault(),xe.createToken(Ee).then(function(e){var t,n,a;e.error?document.getElementById("card-errors").textContent=e.error.message:(t=e.token,n=document.getElementById("payment-form"),(a=document.createElement("input")).setAttribute("type","hidden"),a.setAttribute("name","stripeToken"),a.setAttribute("value",t.id),n.appendChild(a),n.submit())})}),Ee.mount("#card-element");break;default:console.log("the following page has been pushed and has no reference in the push page switch "+navi.topPage.name)}})});